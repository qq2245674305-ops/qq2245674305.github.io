<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶Šå—ä¹‹æ—…ï¼šè¦ªå‹æ—…éŠå°å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* è¨­ç½®å…¨åŸŸå­—é«”ç‚º Noto Sans TC */
        /* === æ›´æ–°ç‚ºæ–°çš„é¡è‰²é…ç½® === */
        :root {
            --color-bg-primary: #faf8f5; /* ä¿æŒæ¥µæ·ºåº•è‰² */
            --color-bg-card: #ffffff; /* ç´”ç™½ */
            --color-text-main: #514378; /* æ·±ç´« (Primary Text/Dark Contrast) */
            --color-accent: #EBC79A; /* æš–é‡‘è‰² (Main Accent/Headers) */
            --color-divider: #eac9b8; /* æŸ”å’Œç²‰è‰² (Soft Divider/Border) */
            --color-highlight: #F8D77A; /* ç¶“å…¸æš–é»ƒ (Highlight/Important Time) */
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--color-bg-primary);
            color: var(--color-text-main);
            padding-bottom: 4rem; /* åº•éƒ¨ç©ºé–“ç•™çµ¦å°èˆªåˆ— */
            line-height: 1.6;
        }

        /* å°èˆªåˆ—æ¨£å¼ */
        .nav-item {
            color: var(--color-text-main);
            transition: color 0.2s, background-color 0.2s;
        }
        .nav-item.active {
            color: var(--color-text-main); /* å°èˆªé¸ä¸­æ™‚ä½¿ç”¨æ·±ç´« */
            background-color: var(--color-highlight);
            border-radius: 8px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .muji-card {
            background-color: var(--color-bg-card);
            border: 1px solid var(--color-divider);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.03);
            transition: transform 0.1s;
        }

        /* æŒ‰éˆ•é€šç”¨æ¨£å¼ */
        .muji-btn {
            background-color: var(--color-text-main); /* ä½¿ç”¨æœ€æ·±çš„é¡è‰²ä½œæŒ‰éˆ•èƒŒæ™¯ï¼Œç¢ºä¿å¯è¦–æ€§ */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .muji-btn:hover {
            background-color: #3d3151; /* Slightly darker deep purple */
        }
        .muji-btn-light {
             background-color: var(--color-bg-primary);
             color: var(--color-text-main);
             border: 1px solid var(--color-divider);
        }

        /* æ™‚é–“è»¸ç·šæ¢ */
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--color-divider);
        }
        .timeline-dot {
            position: absolute;
            left: 14px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: var(--color-text-main);
            border: 2px solid var(--color-bg-primary);
            z-index: 10;
        }
    </style>

    <!-- Supabase client (for cloud sync) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

</head>
<body class="min-h-screen">
<!-- Password Gate (æ–¹æ¡ˆBï¼šå‰ç«¯å›ºå®šå¯†ç¢¼) -->
<div id="pw-overlay" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/60 backdrop-blur-sm px-4">
  <div class="w-full max-w-sm rounded-2xl bg-white shadow-xl p-6">
    <div class="flex items-center gap-2 mb-3">
      <div class="w-9 h-9 rounded-xl bg-gray-100 flex items-center justify-center">
        <span class="text-lg">ğŸ”’</span>
      </div>
      <div>
        <div class="text-base font-semibold text-gray-900">è¼¸å…¥å¯†ç¢¼ä»¥é€²å…¥</div>
        <div class="text-xs text-gray-500">ï¼ˆæç¤ºï¼šé€™æ˜¯å‰ç«¯é–ï¼Œæ‡‚æŠ€è¡“çš„äººä»å¯å¾åŸå§‹ç¢¼æ‰¾åˆ°ï¼‰</div>
      </div>
    </div>

    <label class="block text-sm text-gray-700 mb-1">å¯†ç¢¼</label>
    <input id="pw-input" type="password" inputmode="numeric" autocomplete="current-password"
      class="w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900/20"
      placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
    <div id="pw-error" class="text-sm text-red-600 mt-2"></div>

    <div class="flex items-center justify-between mt-4">
      <label class="inline-flex items-center gap-2 text-sm text-gray-700 select-none">
        <input id="pw-remember" type="checkbox" class="rounded border-gray-300" />
        è¨˜ä½æˆ‘ï¼ˆåŒä¸€è£ç½®ï¼‰
      </label>
      <button id="pw-submit" class="rounded-xl bg-gray-900 text-white px-4 py-2 text-sm hover:bg-gray-800">
        é€²å…¥
      </button>
    </div>
  </div>
</div>

<script>
(function () {
  // ===== Password Gate Config =====
  // æ”¹æˆä½ æƒ³è¦çš„å›ºå®šå¯†ç¢¼ï¼ˆæ³¨æ„ï¼šé€™æ˜¯å‰ç«¯æª”æ¡ˆï¼Œå¯†ç¢¼ä»å¯èƒ½è¢«æ‡‚æŠ€è¡“çš„äººæ‰¾åˆ°ï¼‰
  const ACCESS_PASSWORD = "0707";
  const SESSION_KEY = "vietnam_trip_unlocked_session_v1";
  const REMEMBER_KEY = "vietnam_trip_unlocked_remember_v1";

  function isUnlocked() {
    return sessionStorage.getItem(SESSION_KEY) === "1" || localStorage.getItem(REMEMBER_KEY) === "1";
  }
  function unlock(remember) {
    sessionStorage.setItem(SESSION_KEY, "1");
    if (remember) localStorage.setItem(REMEMBER_KEY, "1");
    else localStorage.removeItem(REMEMBER_KEY);

    const overlay = document.getElementById("pw-overlay");
    const root = document.getElementById("app-root");
    if (overlay) overlay.style.display = "none";
    if (root) root.style.display = "";

    try { if (typeof window.__onAppUnlocked === "function") window.__onAppUnlocked(); } catch (e) {}
  }

  window.__isAppUnlocked = isUnlocked;

  document.addEventListener("DOMContentLoaded", function () {
    const overlay = document.getElementById("pw-overlay");
    const root = document.getElementById("app-root");

    if (isUnlocked()) {
      if (overlay) overlay.style.display = "none";
      if (root) root.style.display = "";
      try { if (typeof window.__onAppUnlocked === "function") window.__onAppUnlocked(); } catch (e) {}
      return;
    }

    if (overlay) {
      overlay.style.display = "flex";
    }
    if (root) {
      root.style.display = "none";
    }

    const input = document.getElementById("pw-input");
    const btn = document.getElementById("pw-submit");
    const remember = document.getElementById("pw-remember");
    const error = document.getElementById("pw-error");

    function attempt() {
      const v = (input && input.value ? input.value : "").trim();
      if (v === ACCESS_PASSWORD) {
        if (error) error.textContent = "";
        unlock(remember && remember.checked);
      } else {
        if (error) error.textContent = "å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡";
        if (input) { input.value = ""; input.focus(); }
      }
    }

    if (btn) btn.addEventListener("click", attempt);
    if (input) input.addEventListener("keydown", function (e) {
      if (e.key === "Enter") attempt();
    });
  });
})();
</script>

  <div id="app-root" style="display:none;">


    <header class="sticky top-0 z-20 bg-white shadow-md p-4 flex justify-between items-center border-b" style="border-color: var(--color-divider);">
        <h1 class="text-xl font-bold flex items-center space-x-2" style="color: var(--color-text-main);">
            <span id="title-display-area" class="flex items-center">
                <span id="app-title-display"></span>
                <button id="edit-title-btn" class="ml-2 text-base text-gray-500 hover:text-gray-700 p-1 rounded transition" title="ä¿®æ”¹æ¨™é¡Œ">
                    <i class="fas fa-edit text-sm"></i>
                </button>
            </span>
            
            <span id="title-edit-area" class="hidden flex items-center space-x-2">
                <input type="text" id="title-input" class="p-1 border rounded-lg text-base w-40" style="border-color: var(--color-divider);">
                <button id="save-title-btn" class="muji-btn text-xs px-2 py-1">å„²å­˜</button>
                <button id="cancel-edit-btn" class="muji-btn-light text-xs px-2 py-1" style="border-color: var(--color-divider);"><i class="fas fa-times"></i></button>
            </span>
        </h1>

        <div id="rate-badge" class="text-sm font-medium px-3 py-1 rounded-full" style="background-color: var(--color-bg-primary); color: var(--color-text-main);">
            VND/TWD: -
        </div>
    </header>

    <main id="app-content" class="p-4 pt-6 max-w-xl mx-auto">
        </main>

    <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-30">
        <nav class="flex justify-around items-center h-16 max-w-xl mx-auto">
            <button class="nav-item flex flex-col items-center p-2 active" data-tab="FLIGHTS_STAY">
                <i class="fas fa-plane-departure text-xl"></i>
                <span class="text-xs mt-1">èˆªç­ä½å®¿</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-tab="ITINERARY">
                <i class="fas fa-calendar-alt text-xl"></i>
                <span class="text-xs mt-1">è¡Œç¨‹è¡¨</span>
            </button>
<button class="nav-item flex flex-col items-center p-2" data-tab="WALLET">
                <i class="fas fa-calculator text-xl"></i>
                <span class="text-xs mt-1">è¨˜å¸³</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-tab="LISTS">
                <i class="fas fa-list-check text-xl"></i>
                <span class="text-xs mt-1">æ¸…å–®</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-tab="INFO">
                <i class="fas fa-info-circle text-xl"></i>
                <span class="text-xs mt-1">è³‡è¨Š</span>
            </button>
        </nav>
    </footer>

    <div id="itinerary-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30 p-4 hidden">
        <div class="muji-card p-6 w-full max-w-lg" style="border-color: var(--color-divider);">
            <h3 class="text-xl font-bold mb-4" id="modal-title" style="color: var(--color-text-main);">æ–°å¢è¡Œç¨‹é …ç›®</h3>
            <form id="itinerary-form" class="space-y-3">
                <input type="hidden" id="modal-day-index">
                <input type="hidden" id="modal-item-index">

                <div>
                    <label for="modal-name" class="block text-sm font-medium" style="color: var(--color-text-main);">é …ç›®åç¨±</label>
                    <input type="text" id="modal-name" required class="w-full p-2 border rounded-lg" placeholder="e.g. åŒ—æ‘å¤§ç“¦æˆ¿é†¬èŸ¹" style="border-color: var(--color-divider);">
                </div>
                
                <div class="flex space-x-3">
                    <div class="flex-1">
                        <label for="modal-time" class="block text-sm font-medium" style="color: var(--color-text-main);">æ™‚é–“</label>
                        <input type="text" id="modal-time" required class="w-full p-2 border rounded-lg" placeholder="e.g. åˆé¤, 10:00" style="border-color: var(--color-divider);">
                    </div>
                    <div class="flex-1">
                        <label for="modal-type" class="block text-sm font-medium" style="color: var(--color-text-main);">é¡å‹</label>
                        <select id="modal-type" required class="w-full p-2 border rounded-lg" style="border-color: var(--color-divider);">
                            <option value="Activity">æ´»å‹• (Activity)</option>
                            <option value="Food">é¤é£² (Food)</option>
                            <option value="Sightseeing">è§€å…‰ (Sightseeing)</option>
                            <option value="Travel">äº¤é€š (Travel)</option>
                            <option value="Shopping">è³¼ç‰© (Shopping)</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="modal-notes" class="block text-sm font-medium" style="color: var(--color-text-main);">å‚™è¨»</label>
                    <input type="text" id="modal-notes" class="w-full p-2 border rounded-lg" placeholder="é¡å¤–èªªæ˜, e.g. ç±³å…¶æ—ä¸€æ˜Ÿ" style="border-color: var(--color-divider);">
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <label for="modal-hours" class="block text-sm font-medium" style="color: var(--color-text-main);">ç‡Ÿæ¥­æ™‚é–“ (hours)</label>
                        <input type="text" id="modal-hours" class="w-full p-2 border rounded-lg" placeholder="e.g. 11:00â€“21:00" style="border-color: var(--color-divider);">
                    </div>
                    <div class="flex-1">
                        <label for="modal-address" class="block text-sm font-medium" style="color: var(--color-text-main);">åœ°å€ (address_copy)</label>
                        <input type="text" id="modal-address" class="w-full p-2 border rounded-lg" placeholder="éŸ“æ–‡æˆ–ä¸­æ–‡åœ°å€" style="border-color: var(--color-divider);">
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <label for="modal-gmap" class="block text-sm font-medium" style="color: var(--color-text-main);">Google Map Link (link)</label>
                        <input type="url" id="modal-gmap" class="w-full p-2 border rounded-lg text-xs" placeholder="http://googleusercontent.com/maps..." style="border-color: var(--color-divider);">
                    </div>
                    <div class="flex-1">
                        <label for="modal-naver" class="block text-sm font-medium" style="color: var(--color-text-main);">Naver Map Link (naver_link)</label>
                        <input type="url" id="modal-naver" class="w-full p-2 border rounded-lg text-xs" placeholder="https://naver.me/..." style="border-color: var(--color-divider);">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--color-text-main);">èƒŒæ™¯è‰²é¸æ“‡ (bgColor)</label>
                    <div id="modal-color-picker" class="flex flex-wrap gap-4">
                        <label class="flex items-center space-x-1 cursor-pointer">
                            <input type="radio" name="modal-bgColor" value="" class="h-4 w-4 text-gray-400 border-gray-300">
                            <span class="text-sm">é è¨­ (ç™½)</span>
                        </label>
                        <label class="flex items-center space-x-1 cursor-pointer">
                            <input type="radio" name="modal-bgColor" value="#FFF9E6" class="h-4 w-4 text-gray-400 border-gray-300">
                            <span class="w-6 h-6 rounded-full border shadow" style="background-color: #FFF9E6;" title="#FFF9E6"></span>
                        </label>
                        <label class="flex items-center space-x-1 cursor-pointer">
                            <input type="radio" name="modal-bgColor" value="#f5e0ce" class="h-4 w-4 text-gray-400 border-gray-300">
                            <span class="w-6 h-6 rounded-full border shadow" style="background-color: #f5e0ce;" title="#f5e0ce"></span>
                        </label>
                        <label class="flex items-center space-x-1 cursor-pointer">
                            <input type="radio" name="modal-bgColor" value="#A9B5A4" class="h-4 w-4 text-gray-400 border-gray-300">
                            <span class="w-6 h-6 rounded-full border shadow" style="background-color: #A9B5A4;" title="#A9B5A4"></span>
                        </label>
                        <label class="flex items-center space-x-1 cursor-pointer">
                            <input type="radio" name="modal-bgColor" value="#d7e4f7" class="h-4 w-4 text-gray-400 border-gray-300">
                            <span class="w-6 h-6 rounded-full border shadow" style="background-color: #d7e4f7;" title="#d7e4f7"></span>
                        </label>
                    </div>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="modal-highlight" class="h-4 w-4 rounded" style="color: var(--color-text-main); border-color: var(--color-divider);">
                    <label for="modal-highlight" class="ml-2 text-sm font-medium" style="color: var(--color-text-main);">é«˜äº®/é‡è¦é …ç›® (Highlight)</label>
                </div>


                <div class="flex justify-end space-x-3 mt-4">
                    <button type="button" id="modal-cancel-btn" class="muji-btn-light" style="border-color: var(--color-divider);">å–æ¶ˆ</button>
                    <button type="submit" id="modal-save-btn" class="muji-btn">å„²å­˜é …ç›®</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="list-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30 p-4 hidden">
        <div class="muji-card p-6 w-full max-w-sm" style="border-color: var(--color-divider);">
            <h3 class="text-xl font-bold mb-4" id="list-modal-title" style="color: var(--color-text-main);">æ–°å¢æ¸…å–®é …ç›®</h3>
            <form id="list-form" class="space-y-3">
                <input type="hidden" id="list-modal-category">
                <input type="hidden" id="list-modal-item-id">

                <div>
                    <label for="list-modal-text" class="block text-sm font-medium" style="color: var(--color-text-main);">é …ç›®åç¨±</label>
                    <input type="text" id="list-modal-text" required class="w-full p-2 border rounded-lg" placeholder="e.g. å…Œæ›éŸ“å…ƒ" style="border-color: var(--color-divider);">
                </div>
                
                <div>
                    <label for="list-modal-notes" class="block text-sm font-medium" style="color: var(--color-text-main);">å‚™è¨» (é¸å¡«)</label>
                    <input type="text" id="list-modal-notes" class="w-full p-2 border rounded-lg" placeholder="e.g. é ˆæ›å¤§éˆ”" style="border-color: var(--color-divider);">
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="list-modal-cancel-btn" class="muji-btn-light" style="border-color: var(--color-divider);">å–æ¶ˆ</button>
                    <button type="submit" id="list-modal-save-btn" class="muji-btn">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // --- å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ–è³‡æ–™ ---
        const APP_ID = 'VN_TRIP_APP'; // LocalStorage å‘½åç©ºé–“
        const exchangeRateKey = `${APP_ID}_EXCHANGE_RATE`;
        const daesagwanRateKey = `${APP_ID}_DAESAGWAN_RATE`; // NEW: æ˜æ´å¤§ä½¿é¤¨åŒ¯ç‡åƒè€ƒ
        const rateRecordNoteKey = `${APP_ID}_RATE_RECORD_NOTE`; // NEW: åŒ¯ç‡ç´€éŒ„å‚™è¨»
        const localInfoLinksKey = `${APP_ID}_LOCAL_INFO_LINKS`; // NEW: è³‡è¨Šé ç•¶åœ°è³‡è¨Šé€£çµ
        const expensesKey = `${APP_ID}_EXPENSES`;
        const checklistKey = `${APP_ID}_CHECKLIST`;
        const memoKey = `${APP_ID}_MEMO`;
        const memoInfoKey = `${APP_ID}_MEMO_INFO`; // NEW: è³‡è¨Šé å‚™è¨»
        const tripDataKey = `${APP_ID}_TRIP_DATA`; 
        const APP_TITLE_KEY = `${APP_ID}_APP_TITLE`; // NEW KEY

        let currentRate = 0.024; // é è¨­éŸ“å…ƒåˆ°å°å¹£åŒ¯ç‡ (å¯èª¿æ•´)
        const TWD_SYMBOL = 'NT$';
        
        // NEW: æ‡‰ç”¨ç¨‹å¼é è¨­æ¨™é¡Œ
        const DEFAULT_TITLE = 'ğŸ‡»ğŸ‡³ è¶Šå—å°æ—…è¡Œ';
        
        // å¯ç”¨çš„èƒŒæ™¯è‰²
        const ITINERARY_COLORS = ['#FFF9E6', '#f5e0ce', '#A9B5A4', '#d7e4f7'];

        // NEW: é–‹éŠ·åˆ†é¡åŠå…¶åœ–ç¤º
        const EXPENSE_CATEGORIES = [
            { key: 'Food', name: 'é£Ÿç‰© (æ­£é¤)', icon: 'fa-utensils' },
            { key: 'Snack', name: 'é»å¿ƒ/ç”œé»', icon: 'fa-cookie-bite' },
            { key: 'Drink', name: 'é£²æ–™/å’–å•¡', icon: 'fa-mug-hot' },
            { key: 'Transport', name: 'äº¤é€š/è»Šè³‡', icon: 'fa-train-subway' },
            { key: 'Clothes', name: 'è¡£æœ/é…ä»¶', icon: 'fa-shirt' },
            { key: 'Beauty', name: 'ç¾å¦/ä¿é¤Šå“', icon: 'fa-spray-can' },
            { key: 'Shopping', name: 'è³¼ç‰© (å…¶ä»–)', icon: 'fa-bag-shopping' },
            { key: 'Other', name: 'å…¶ä»–', icon: 'fa-ellipsis' },
        ];
        
        // è¼”åŠ©å‡½å¼ï¼šæ ¹æ“š key å–å¾—åˆ†é¡è³‡è¨Š
        function getCategoryInfo(key) {
            return EXPENSE_CATEGORIES.find(cat => cat.key === key) || { key: 'Other', name: 'å…¶ä»–', icon: 'fa-ellipsis' };
        

        // é˜²æ­¢ä½¿ç”¨è€…è¼¸å…¥é€ æˆ HTML æ³¨å…¥ï¼ˆç”¨æ–¼è¼¸å‡ºåˆ° innerHTMLï¼‰
        function escapeHTML(input) {
            return String(input ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
}

        // æ ¸å¿ƒè¡Œç¨‹æ•¸æ“š - åˆå§‹å€¼ (ä¿æŒä¸è®Š)
        const initialTripData = {
            flights: "å»ç¨‹ï¼šå»ç¨‹ï¼ˆå‡ºç™¼ï¼‰<br>çˆ&æ¹˜ï¼šé«˜é›„ â†’èƒ¡å¿—æ˜ï¼ˆè¶Šå—èˆªç©º VN 581ï¼‰07:30â€“09:30<br>æ¬£&èŠ·ï¼šæ¡ƒåœ’ â†’èƒ¡å¿—æ˜ï¼ˆæ˜Ÿå®‡èˆªç©º JX 711ï¼‰07:40â€“10:30ï¼›å›ç¨‹ï¼šå›ç¨‹ï¼ˆè¿”ç¨‹ï¼‰<br>å…¨é«”ï¼šèƒ¡å¿—æ˜â†’æ¡ƒåœ’ï¼ˆé•·æ¦®èˆªç©º BR 382ï¼‰01:55â€“06:10",
            flights_note: "å»ç¨‹è«‹æ–¼èµ·é£›å‰ææ—©åˆ°æ©Ÿå ´å®Œæˆå ±åˆ°ï¼›å›ç¨‹ç‚ºå‡Œæ™¨ 01:55 èµ·é£›ï¼Œå»ºè­°å‰ä¸€æ™šææ—©æ•´ç†è¡Œæä¸¦é ç•™å‰å¾€æ©Ÿå ´æ™‚é–“ã€‚",accommodation: [
    { date: "1/24-1/26", name: "KIN HOTEL DONG DU", address: "19â€’21 Dong Du Street, Sai Gon Ward, Ho Chi Minh City", address_copy: "19â€’21 Dong Du Street, Sai Gon Ward, Ho Chi Minh City", phone: "(028) 3535 4342", mapLink: "https://maps.app.goo.gl/ywuEv4Nd78Yi7FHH9" }
],
itinerary: [
    { date: "Day1-1/24(å…­)", items: []},
    { date: "Day2-1/25(æ—¥)", items: []},
    { date: "Day3-1/26(ä¸€)", items: []},
    { date: "Day4-1/27(äºŒ)", items: []},
],
guide_spots:
 [
                { name: "æ™¯ç¦å®®", intro: "æ™¯ç¦å®®æ˜¯æœé®®ç‹æœï¼ˆ1392-1897å¹´ï¼‰çš„æ­£å®®ï¼Œæ„ç‚ºã€Œå¤§å‰å¤§åˆ©ã€ç¦ç¥¿ç¶¿é•·ã€ã€‚å®ƒå»ºæ–¼1395å¹´ï¼Œæ˜¯éŸ“åœ‹äº”å¤§å®®ê¶ä¸­è¦æ¨¡æœ€å¤§ã€å»ºç¯‰è¨­è¨ˆæœ€ç²¾ç¾çš„ã€‚æœ€è‘—åçš„å‹¤æ”¿æ®¿æ˜¯ç”¨æ–¼åœ‹å®¶å„€å¼å’Œæ¥è¦‹å¤–åœ‹ä½¿ç¯€çš„åœ°æ–¹ï¼Œè€Œé¦™é äº­å‰‡æ˜¯æ¹–ç•”çš„å„ªç¾äº­é–£ã€‚å†·çŸ¥è­˜ï¼šåœ¨æ—¥æ²»æ™‚æœŸï¼Œå®®æ®¿çš„å¤§éƒ¨åˆ†è¢«æ¯€æï¼Œç¾ä»Šæ‰€è¦‹æ˜¯å¤šå¹´ä¾†ä¿®å¾©çš„çµæœï¼Œé«”ç¾äº†éŸ“åœ‹å°æ­·å²çš„å …å®ˆèˆ‡å¾©èˆˆã€‚", map: { lat: 37.58, lng: 126.98 } },
                { name: "DMZ éè»äº‹å€", intro: "DMZï¼ˆDemilitarized Zoneï¼‰æ˜¯åˆ†éš”å—åŒ—éŸ“çš„ç·©è¡å€ï¼Œé•·ç´„250å…¬é‡Œï¼Œå¯¬ç´„4å…¬é‡Œã€‚é›–ç„¶åç‚ºéè»äº‹å€ï¼Œä½†å®ƒæ˜¯ä¸–ç•Œä¸Šè»äº‹åŒ–ç¨‹åº¦æœ€é«˜çš„åœ°å€ä¹‹ä¸€ã€‚é€™è£åŒæ™‚ä¹Ÿæ˜¯ä¸€å€‹ç”Ÿæ…‹å¤©å ‚ï¼Œå› ç‚ºäººé¡æ´»å‹•çš„é™åˆ¶ï¼Œæˆç‚ºäº†è¨±å¤šçç¨€é‡ç”Ÿå‹•æ¤ç‰©çš„æ£²æ¯åœ°ã€‚åƒè§€è¡Œç¨‹é€šå¸¸åŒ…æ‹¬æ¿é–€åº—ã€ç¬¬ä¸‰åœ°é“å’Œéƒ½ç¾…å±•æœ›å°ã€‚å†·çŸ¥è­˜ï¼šDMZ å…§éƒ¨æœ‰ä¸€å€‹åç‚ºã€Œå’Œå¹³ä¹‹æ‘ã€ï¼ˆå¤§æˆæ´ï¼‰çš„æ‘èŠï¼Œæ˜¯å”¯ä¸€å…è¨±å¹³æ°‘å±…ä½åœ¨DMZå…§çš„ç‰¹ä¾‹ã€‚", map: { lat: 37.93, lng: 126.70 } },
            ]
        };
        
        let tripData = {}; // å°‡ç”± loadInitialData è¼‰å…¥ LocalStorage å„²å­˜çš„è³‡æ–™

        // åˆå§‹æ¸…å–®æ•¸æ“š (å·²æ›´æ–°ç‚ºå…©æ¬„çµæ§‹ï¼Œä¸¦åŠ å…¥å‚™è¨»æ¬„ä½)
        const initialChecklist = {
            luggage: [
                { id: 1, text: "è­·ç…§", notes: "ç¢ºèªæ•ˆæœŸå¤§æ–¼å…­å€‹æœˆ", checked: false },
                { id: 2, text: "esim (æˆ–å¯¦é«” SIM å¡)", notes: "å‡ºç™¼å‰é–‹é€š", checked: false },
                { id: 3, text: "å°å¹£ (ç”¨æ–¼æ›è¶Šå—ç›¾)", notes: "æ›éŒ¢æ‰€åªæ”¶å¤§éˆ”", checked: false },
                { id: 4, text: "ç¾½çµ¨å¤–å¥—", notes: "", checked: false },
                { id: 5, text: "è²¼èº«ä¿æš–è¡£ç‰© (ç™¼ç†±è¡£)", notes: "", checked: false },
                { id: 6, text: "å¸½å­, æ‰‹å¥—", notes: "éŸ“åœ‹å†¬å¤©å¿…å‚™", checked: false },
                { id: 7, text: "æ—…éŠå¸¸å‚™è—¥ (æ„Ÿå†’ã€è…¸èƒƒè—¥)", notes: "", checked: false },
                { id: 8, text: "ä¿å¥é£Ÿå“", notes: "", checked: false },
                { id: 9, text: "å€‹äººç›¥æ´—ç”¨å“", notes: "", checked: false },
                { id: 10, text: "åŒ–å¦å“, ä¿é¤Šå“, å¸å¦", notes: "", checked: false },
                { id: 11, text: "å‡¡å£«æ—, å”‡è†, èº«é«”ä¹³ (éŸ“åœ‹è¼ƒä¹¾ç‡¥)", notes: "", checked: false },
            ],
            todo: [
                { id: 101, text: "æ›è¶Šå—ç›¾", notes: "ç›®æ¨™æ› 100 è¬ VND(Ä‘)", checked: false },
                { id: 102, text: "ç·šä¸Šè¾¦ç† K-ETA/Q-CODE", notes: "å‡ºç™¼å‰ 72 å°æ™‚å…§å®Œæˆ", checked: false },
                { id: 103, text: "ä¿¡ç”¨å¡é–‹é€šåœ‹å¤–äº¤æ˜“", notes: "", checked: false },
                { id: 104, text: "è¨‚è³¼æ©Ÿå ´æ¥é€æœå‹™", notes: "ç¢ºèªè»Šå‹èˆ‡äººæ•¸", checked: false },
            ]
        };

        // è¡Œå‰æ¸…å–®ï¼šéœ€è¦å…¨å“¡ç¢ºèªçš„ 4 ä½ï¼ˆåœ“åœˆï¼‰
        const CHECKLIST_PEOPLE = ['æ¬£', 'çˆ', 'èŠ·', 'æ¹˜'];


        // --- LocalStorage è®€å¯«å·¥å…· ---
        function getLocalStorage(key, defVal) {
  try {
    const raw = localStorage.getItem(key);
    if (raw === null) return defVal;
    const parsed = JSON.parse(raw);
    return (parsed === null || parsed === undefined) ? defVal : parsed;
  } catch (e) {
    return defVal;
  }
}

        function setLocalStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error(`Error setting LocalStorage key ${key}`, e);
            }
        }
        
        
// ===============================
// Cloud Sync (Supabase)
// ===============================
// 1) Supabase å…©å€‹å€¼ï¼ˆä½ å·²å¡«å¥½ï¼‰ï¼š
const SUPABASE_URL = "https://iqkhvluwlkqmwgynwxnh.supabase.co"; // ä½ çš„ Supabase Project URL
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlxa2h2bHV3bGtxbXdneW53eG5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1OTM3NTMsImV4cCI6MjA4MTE2OTc1M30.3FCpo4LCfCQWBj3PcZP4IJTYLR1lp_xmqan9zG3BHz0"; // Supabase Settings â†’ API â†’ anon publicï¼ˆä¸è¦æ”¾ service_roleï¼‰
const ENABLE_CLOUD_SYNC = SUPABASE_ANON_KEY !== "PASTE_YOUR_SUPABASE_ANON_KEY_HERE";
// 2) åŒä¸€ç¾¤äººå…±ç”¨åŒä¸€ä»½è³‡æ–™ï¼ˆå¯æ”¹æˆä¸åŒåç¨±ï¼‰
const SHARED_DOC_ID = "vietnam-trip";

// 3) è¦åŒæ­¥çš„ localStorage keys
const SYNC_KEYS = [exchangeRateKey, daesagwanRateKey, expensesKey, checklistKey, memoKey, memoInfoKey, tripDataKey, APP_TITLE_KEY, rateRecordNoteKey, localInfoLinksKey];

let supabaseClient = null;
let cloudAutoSync = true;
let cloudPushTimer = null;
let cloudPollTimer = null;
let cloudLastPushedHash = "";
let cloudLastRemoteUpdatedAt = null;
let cloudApplyingRemoteSnapshot = false;

function initSupabaseClient() {
  try {
    if (!window.supabase || !window.supabase.createClient) {
      console.warn("[CloudSync] Supabase client not loaded.");
      return null;
    }
    return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  } catch (e) {
    console.error("[CloudSync] init failed:", e);
    return null;
  }
}

function buildLocalSnapshot() {
  const snap = {};
  for (const k of SYNC_KEYS) {
    // Only include keys that actually exist and are not null.
    // This prevents us from pushing lots of nulls and later overwriting defaults.
    const raw = localStorage.getItem(k);
    if (raw === null) continue;
    try {
      const v = JSON.parse(raw);
      if (v === null || v === undefined) continue;
      snap[k] = v;
    } catch (e) {
      // ignore invalid JSON
    }
  }
  return snap;
}

async function ensureSharedDocExists() {
  if (!supabaseClient) return;
  try {
    // è‹¥ä¸å­˜åœ¨å°±å»ºç«‹ä¸€ç­†ï¼ˆupsertï¼‰
    const now = new Date().toISOString();
    const empty = buildLocalSnapshot();
    await supabaseClient
      .from("shared_docs")
      .upsert({ id: SHARED_DOC_ID, data: empty, updated_at: now }, { onConflict: "id" });
  } catch (e) {
    console.error("[CloudSync] ensure doc failed:", e);
  }
}

function scheduleCloudPush() {
  if (!cloudAutoSync) return;
  if (cloudApplyingRemoteSnapshot) return;
  clearTimeout(cloudPushTimer);
  cloudPushTimer = setTimeout(pushToCloud, 800);
}

async function pushToCloud() {
  if (!supabaseClient) return;
  try {
    const snapshot = buildLocalSnapshot();
    const hash = JSON.stringify(snapshot);
    if (hash === cloudLastPushedHash) return;

    cloudLastPushedHash = hash;
    const now = new Date().toISOString();

    const { data, error } = await supabaseClient
      .from("shared_docs")
      .upsert({ id: SHARED_DOC_ID, data: snapshot, updated_at: now }, { onConflict: "id" })
      .select("updated_at")
      .single();

    if (error) throw error;
    cloudLastRemoteUpdatedAt = data?.updated_at || now;
  } catch (e) {
    console.error("[CloudSync] push failed:", e);
  }
}

async function pullFromCloud(force = false) {
  if (!supabaseClient) return;
  try {
    const { data, error } = await supabaseClient
      .from("shared_docs")
      .select("data, updated_at")
      .eq("id", SHARED_DOC_ID)
      .maybeSingle();

    if (error) throw error;
    if (!data) return;

    const remoteUpdatedAt = data.updated_at || null;
    if (!force && remoteUpdatedAt && cloudLastRemoteUpdatedAt && remoteUpdatedAt <= cloudLastRemoteUpdatedAt) {
      return;
    }

    // é˜²æ­¢è‡ªå·±å‰›æ¨ä¸Šå»åˆè¢«æ‹‰å›ä¾†é€ æˆå¾ªç’°
    cloudLastRemoteUpdatedAt = remoteUpdatedAt;

    if (data.data) {
      applyRemoteSnapshot(data.data);
    }
  } catch (e) {
    console.error("[CloudSync] pull failed:", e);
  }
}

function applyRemoteSnapshot(snapshot) {
  if (!snapshot || typeof snapshot !== "object") return;
  for (const k of SYNC_KEYS) {
    if (!(k in snapshot)) continue;
    const v = snapshot[k];
    // Never write null/undefined into localStorage; keep app defaults instead.
    if (v === null || v === undefined) continue;
    try {
      localStorage.setItem(k, JSON.stringify(v));
    } catch (e) {}
  }
}

function startCloudSync() {
  if (!cloudAutoSync) return;

  // åªåœ¨è§£é–å¾Œé–‹å§‹åŒæ­¥ï¼ˆé¿å…è¢«æœªæˆæ¬Šè€…ä¸€ç›´æ‰“ APIï¼‰
  if (window.__isAppUnlocked && !window.__isAppUnlocked()) return;

  if (!supabaseClient) {
    supabaseClient = initSupabaseClient();
  }
  if (!supabaseClient) return;

  ensureSharedDocExists().then(() => pullFromCloud(true));

  clearInterval(cloudPollTimer);
  cloudPollTimer = setInterval(() => pullFromCloud(false), 15000);
}

// è§£é–å¾Œè‡ªå‹•å•Ÿå‹•åŒæ­¥
(function bindUnlockHook() {
  const prev = window.__onAppUnlocked;
  window.__onAppUnlocked = function () {
    try { if (typeof prev === "function") prev(); } catch (e) {}
    startCloudSync();
  };
  // å¦‚æœä¸€é–‹å§‹å°±å·²ç¶“è§£é–ï¼Œç›´æ¥å•Ÿå‹•
  try { if (window.__isAppUnlocked && window.__isAppUnlocked()) startCloudSync(); } catch (e) {}
})();

// setLocalStorage åŒ…ä¸€å±¤ï¼šæ¯æ¬¡å¯«å…¥ localStorageï¼Œå°±è‡ªå‹•æ’ç¨‹æ¨é›²ç«¯
(function wrapSetLocalStorage() {
  const _orig = setLocalStorage;
  setLocalStorage = function (key, value) {
    _orig(key, value);
    // é¿å…ã€Œå¾é›²ç«¯å¥—ç”¨ã€åˆè§¸ç™¼ push
    if (!cloudApplyingRemoteSnapshot) {
      scheduleCloudPush();
    }
  };
})();

// --- é€šç”¨å‰ªè²¼ç°¿è¤‡è£½åŠŸèƒ½ ---
        function copyTextToClipboard(text, message) {
            try {
                // ä½¿ç”¨ document.execCommand('copy') ä½œç‚º iframe ç’°å¢ƒçš„é¦–é¸æ–¹æ³•
                const tempInput = document.createElement('textarea');
                tempInput.value = text;
                // è®“ textarea ä¸å¯è¦‹ä½†å¯é¸ä¸­
                tempInput.style.position = 'absolute';
                tempInput.style.left = '-9999px';
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                alertModal(message || 'åœ°å€å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            } catch (err) {
                console.error('Could not copy text: ', err);
                alertModal('ç„¡æ³•è¤‡è£½ï¼Œè«‹æ‰‹å‹•è¤‡è£½: ' + text);
            }
        }

        // --- æ¨™é¡Œç®¡ç†åŠŸèƒ½ (NEW) ---

        function loadTitle() {
            const title = getLocalStorage(APP_TITLE_KEY, DEFAULT_TITLE);
            document.getElementById('app-title-display').textContent = title;
            // æ›´æ–° HTML <title> æ¨™ç±¤
            document.title = title.includes('æ—…éŠå°å·¥å…·') ? title : `${title}ï¼šè¦ªå‹æ—…éŠå°å·¥å…·`; 
            document.getElementById('title-input').value = title;
        }

        function toggleTitleEdit(show) {
            const displayArea = document.getElementById('title-display-area');
            const editArea = document.getElementById('title-edit-area');
            const titleInput = document.getElementById('title-input');
            
            if (show) {
                displayArea.classList.add('hidden');
                editArea.classList.remove('hidden');
                titleInput.focus();
            } else {
                editArea.classList.add('hidden');
                displayArea.classList.remove('hidden');
            }
        }

        function saveTitle() {
            const titleInput = document.getElementById('title-input');
            const newTitle = titleInput.value.trim();
            
            if (newTitle.length > 0) {
                setLocalStorage(APP_TITLE_KEY, newTitle);
                loadTitle(); // Reloads title display and updates input value
                alertModal('æ¨™é¡Œå·²æ›´æ–°ï¼');
                toggleTitleEdit(false);
            } else {
                alertModal('æ¨™é¡Œä¸èƒ½ç‚ºç©ºã€‚');
                titleInput.focus();
            }
        }

        // --- åŒ¯ç‡èˆ‡è²»ç”¨è¨ˆç®—å·¥å…· ---
        function loadInitialData() {
            // åŠ è¼‰ä¸¦é¡¯ç¤ºåŒ¯ç‡
            currentRate = getLocalStorage(exchangeRateKey, 0.024);
            updateRateDisplay();

            // NEW: è¼‰å…¥è¡Œç¨‹è³‡æ–™
            tripData = getLocalStorage(tripDataKey, initialTripData);
        }

        function updateRateDisplay() {
  const badge = document.getElementById("rate-badge");
  if (!badge) return;

  const v = getLocalStorage(exchangeRateKey, 0.024);
  const rate = Number(v);

  if (!Number.isFinite(rate)) {
    badge.textContent = "VND/TWD: -";
    return;
  }
  badge.textContent = `VND/TWD: ${rate.toFixed(3)}`;
}

        function krwToTwd(amount) {
            const n = Number(amount) * Number(currentRate);
            return Number.isFinite(n) ? n : 0;
        }

        function formatTwd(amount, digits = 3) {
            const n = krwToTwd(amount);
            return n.toLocaleString(undefined, { minimumFractionDigits: digits, maximumFractionDigits: digits });
        }

        // --- è¡Œç¨‹è³‡æ–™ LocalStorage å„²å­˜ (ä¸è®Š) ---
        function setTripData(data) {
            tripData = data; // æ›´æ–°å…¨åŸŸè®Šæ•¸
            setLocalStorage(tripDataKey, data);
        }

        // --- è¡Œç¨‹ç·¨è¼¯/æ–°å¢/åˆªé™¤åŠŸèƒ½ (ä¸è®Š) ---
        function openItineraryItemModal(dayIndex, itemIndex = null) {
            const modal = document.getElementById('itinerary-modal');
            const form = document.getElementById('itinerary-form');
            const title = document.getElementById('modal-title');
            
            // æ¸…ç©ºè¡¨å–®èˆ‡éš±è—æ¬„ä½
            form.reset();
            document.getElementById('modal-day-index').value = dayIndex;
            document.getElementById('modal-item-index').value = itemIndex !== null ? itemIndex : '';
            
            // é‡è¨­é¡è‰²é¸æ“‡ç‚ºé è¨­
            document.querySelector(`input[name="modal-bgColor"][value=""]`).checked = true;


            if (itemIndex !== null) {
                // ç·¨è¼¯æ¨¡å¼
                title.textContent = "ç·¨è¼¯è¡Œç¨‹é …ç›®";
                const item = tripData.itinerary[dayIndex].items[itemIndex];
                document.getElementById('modal-name').value = item.name || '';
                document.getElementById('modal-time').value = item.time || '';
                document.getElementById('modal-type').value = item.type || 'Activity';
                document.getElementById('modal-notes').value = item.notes || '';
                document.getElementById('modal-hours').value = item.hours || '';
                document.getElementById('modal-address').value = item.address_copy || '';
                document.getElementById('modal-gmap').value = item.link || '';
                document.getElementById('modal-naver').value = item.naver_link || '';
                document.getElementById('modal-highlight').checked = item.highlight || false;
                
                // NEW: è¼‰å…¥èƒŒæ™¯è‰²
                const savedColor = item.bgColor || '';
                const colorRadio = document.querySelector(`input[name="modal-bgColor"][value="${savedColor}"]`);
                if(colorRadio) colorRadio.checked = true;

            } else {
                // æ–°å¢æ¨¡å¼
                title.textContent = `æ–°å¢é …ç›®åˆ° ${tripData.itinerary[dayIndex].date}`;
            }

            modal.classList.remove('hidden');
        }

        function handleItineraryItemSave(event) {
            event.preventDefault();
            
            const dayIndex = parseInt(document.getElementById('modal-day-index').value, 10);
            const itemIndexStr = document.getElementById('modal-item-index').value;
            const itemIndex = itemIndexStr === '' ? null : parseInt(itemIndexStr, 10);
            
            // NEW: å–å¾—é¸æ“‡çš„èƒŒæ™¯è‰²
            const selectedColor = document.querySelector('input[name="modal-bgColor"]:checked').value;

            const newItem = {
                time: document.getElementById('modal-time').value.trim(),
                name: document.getElementById('modal-name').value.trim(),
                type: document.getElementById('modal-type').value,
                notes: document.getElementById('modal-notes').value.trim() || undefined,
                link: document.getElementById('modal-gmap').value.trim() || undefined,
                naver_link: document.getElementById('modal-naver').value.trim() || undefined,
                hours: document.getElementById('modal-hours').value.trim() || undefined,
                address_copy: document.getElementById('modal-address').value.trim() || undefined,
                highlight: document.getElementById('modal-highlight').checked || undefined,
                bgColor: selectedColor || undefined // NEW: åŠ å…¥èƒŒæ™¯è‰²
            };
            
            // æ¸…é™¤ undefined æˆ–ç©ºå­—ä¸²çš„å±¬æ€§
            Object.keys(newItem).forEach(key => newItem[key] === undefined || newItem[key] === '' ? delete newItem[key] : {});
            
            // æ·±åº¦è¤‡è£½ tripData
            const updatedTripData = JSON.parse(JSON.stringify(tripData));

            if (itemIndex !== null) {
                // ç·¨è¼¯ç¾æœ‰é …ç›®
                updatedTripData.itinerary[dayIndex].items[itemIndex] = newItem;
                alertModal('è¡Œç¨‹é …ç›®å·²æ›´æ–°ï¼');
            } else {
                // æ–°å¢é …ç›® (é è¨­åŠ åœ¨ç•¶æ—¥è¡Œç¨‹æœ«å°¾)
                updatedTripData.itinerary[dayIndex].items.push(newItem);
                alertModal('æ–°çš„è¡Œç¨‹é …ç›®å·²åŠ å…¥ï¼');
            }

            setTripData(updatedTripData);
            document.getElementById('itinerary-modal').classList.add('hidden');
            // å¿…é ˆå‚³å…¥ç•¶å‰å®¹å™¨ï¼Œä»¥ä¾¿é‡æ–°æ¸²æŸ“
            renderItineraryTab(document.getElementById('app-content')); 
        }

        function deleteItineraryItem(dayIndex, itemIndex) {
            if (!confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹é …ç›®å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;

            // æ·±åº¦è¤‡è£½ tripData
            const updatedTripData = JSON.parse(JSON.stringify(tripData));
            
            updatedTripData.itinerary[dayIndex].items.splice(itemIndex, 1);

            setTripData(updatedTripData);
            alertModal('è¡Œç¨‹é …ç›®å·²åˆªé™¤ã€‚');
            // å¿…é ˆå‚³å…¥ç•¶å‰å®¹å™¨ï¼Œä»¥ä¾¿é‡æ–°æ¸²æŸ“
            renderItineraryTab(document.getElementById('app-content')); 
        }
        // --- å½±åƒå£“ç¸®èˆ‡ Base64 è™•ç† ---
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const MAX_WIDTH = 300; // ç¸®åœ–æœ€å¤§å¯¬åº¦
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // è¼¸å‡ºç‚º Base64 (JPEG, ç•«è³ª 70%)
                    const dataURL = canvas.toDataURL('image/jpeg', 0.7);
                    callback(dataURL);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- å°èˆªèˆ‡å…§å®¹æ¸²æŸ“ (ä¸è®Š) ---
        function changeTab(tabName) {
            const content = document.getElementById('app-content');
            const navItems = document.querySelectorAll('.nav-item');

            // ç§»é™¤èˆŠçš„ active ç‹€æ…‹
            navItems.forEach(item => item.classList.remove('active'));

            // è¨­ç½®æ–°çš„ active ç‹€æ…‹
            const activeNav = document.querySelector(`.nav-item[data-tab="${tabName}"]`);
            if (activeNav) {
                activeNav.classList.add('active');
            }

            content.innerHTML = ''; // æ¸…ç©ºå…§å®¹
            window.scrollTo(0, 0); // å›åˆ°é ‚éƒ¨

            // æ ¹æ“š tabName æ¸²æŸ“å…§å®¹ï¼ˆåŠ ä¸Šä¿è­·ï¼Œé¿å…å–®ä¸€éŒ¯èª¤å°è‡´æ•´é ç©ºç™½ï¼‰
            try {
                switch (tabName) {
                    case 'FLIGHTS_STAY':
                        renderFlightsStayTab(content);
                        break;
                    case 'ITINERARY':
                        renderItineraryTab(content);
                        break;
                    case 'WALLET':
                        renderWalletTab(content);
                        break;
                    case 'LISTS':
                        renderListsTab(content);
                        break;
                    case 'INFO':
                        renderInfoTab(content);
                        break;
                    default:
                        renderFlightsStayTab(content);
                        break;
                }
            } catch (e) {
                console.error("[UI] render tab failed:", e);
                content.innerHTML = `
                    <div class="muji-card p-4" style="border-color: var(--color-divider);">
                        <p class="text-lg font-bold mb-2" style="color: var(--color-text-main);">é é¢è¼‰å…¥å¤±æ•—</p>
                        <p class="text-sm text-gray-600">è«‹æŒ‰ Ctrl+F5 å¼·åˆ¶é‡æ•´ï¼Œæˆ–æ”¹é–‹ç„¡ç—•è¦–çª—å†è©¦ä¸€æ¬¡ã€‚</p>
                        <p class="text-xs text-gray-500 mt-2">éŒ¯èª¤ï¼š${String(e && (e.message || e)).slice(0, 200)}</p>
                    </div>
                `;
            }
        }


// --- Tab: FLIGHTS_STAY (èˆªç­èˆ‡ä½å®¿) æ¸²æŸ“ (ä¸è®Š) ---
        function renderFlightsStayTab(container) {
            const flightsNote = (tripData.flights_note && String(tripData.flights_note).trim()) ? String(tripData.flights_note) : "è«‹æ³¨æ„ï¼šå»ç¨‹CI164é è¨ˆ10:55æŠµé”ä»å·ï¼›å›ç¨‹CI165ç‚º12:00èµ·é£›ï¼Œè«‹å‹™å¿…é ç•™å……è¶³äº¤é€šèˆ‡å ±åˆ°æ™‚é–“ã€‚";

            function extractAddressCopy(addrHtml) {
                const txt = String(addrHtml || '')
                    .replace(/<br\s*\/?>/gi, '\n')
                    .replace(/<[^>]+>/g, '')
                    .trim();
                const m = txt.match(/åœ°å€[:ï¼š]\s*([^\n]+)/);
                return m ? m[1].trim() : txt;
            }

            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">âœˆï¸ èˆªç­èˆ‡ä½å®¿ç¸½è¦½</h2>

                <div class="muji-card p-4 mb-6">
                    <h3 class="text-xl font-bold mb-3 flex items-center" style="color: var(--color-text-main);">
                        <i class="fas fa-plane-departure mr-2 text-2xl" style="color: var(--color-accent);"></i> å‡ºå…¥å¢ƒèˆªç­
                    </h3>
                    <div class="text-sm p-3 rounded" style="background-color: var(--color-bg-primary);">
                        <p class="font-medium mb-2">${tripData.flights.split('ï¼›')[0].replace('å»ç¨‹ï¼š', 'ğŸ›« å»ç¨‹:')}</p>
                        <p class="font-medium">${tripData.flights.split('ï¼›')[1].replace('å›ç¨‹ï¼š', 'ğŸ›¬ å›ç¨‹:')}</p>
                    </div>
                    <div class="mt-3 p-3 rounded border" style="border-color: var(--color-divider);">
                        <div class="flex items-center justify-between gap-2">
                            <p class="text-xs font-semibold" style="color: var(--color-text-main);">èˆªç­å‚™è¨»</p>
                            <div class="flex items-center gap-2">
                                <button id="edit-flights-note-btn" type="button" class="muji-btn-light text-xs px-2 py-1 hover:shadow-md">
                                    <i class="fas fa-edit mr-1"></i>ç·¨è¼¯
                                </button>
                                <button id="hide-flights-note-editor-btn" type="button" class="muji-btn-light text-xs px-2 py-1 hover:shadow-md hidden">
                                    <i class="fas fa-chevron-up mr-1"></i>æ”¶èµ·
                                </button>
                            </div>
                        </div>

                        <div id="flights-note-view" class="text-xs text-gray-600 mt-2 whitespace-pre-wrap">${flightsNote}</div>

                        <div id="flights-note-editor" class="mt-2 hidden">
                            <textarea id="flights-note-input" class="w-full p-2 border rounded-lg text-xs" rows="3" style="border-color: var(--color-divider);">${flightsNote}</textarea>
                            <div class="flex gap-2 mt-2">
                                <button id="save-flights-note-btn" type="button" class="muji-btn text-xs px-3 py-1">
                                    <i class="fas fa-save mr-1"></i>å„²å­˜
                                </button>
                                <button id="cancel-flights-note-btn" type="button" class="muji-btn-light text-xs px-3 py-1" style="border-color: var(--color-divider);">
                                    å–æ¶ˆ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="muji-card p-4 mb-6">
                    <h3 class="text-xl font-bold mb-3 flex items-center" style="color: var(--color-text-main);">
                        <i class="fas fa-bed mr-2 text-2xl" style="color: var(--color-accent);"></i> ä½å®¿åœ°é» (å…± ${tripData.accommodation.length} è™•)
                    </h3>

                    ${tripData.accommodation.map((acc, index) => {
                        const addrCopy = (acc && acc.address_copy) ? String(acc.address_copy) : extractAddressCopy(acc.address);
                        const safeCopy = addrCopy.replace(/"/g, '&quot;');
                        const phoneCopy = (acc && acc.phone) ? String(acc.phone) : '';
                        const safePhone = phoneCopy.replace(/"/g, '&quot;');
                        return `
                        <div class="text-base mb-4 p-3 rounded-lg border-l-4" style="border-color: var(--color-highlight); background-color: var(--color-bg-primary);">
                            <p class="font-bold text-lg mb-1" style="color: var(--color-text-main);">
                                <span class="text-sm font-normal p-1 mr-1 rounded" style="background-color: var(--color-accent); color: white;">${acc.date}</span> ${acc.name}
                            </p>
                            <div class="flex items-start justify-between gap-2 acc-wrap" data-copy="${safeCopy}">
                                <p class="text-sm text-gray-600 acc-address flex-1">${acc.address}</p>
                                <button type="button" onclick="copyTextToClipboard(this.closest('.acc-wrap').dataset.copy || '', 'ä½å®¿åœ°å€å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼')" class="muji-btn-light text-xs mt-0 px-2 py-1 inline-flex items-center shrink-0 hover:shadow-md">
                                    <i class="fas fa-copy"></i>
                                </button>
                             </div>
                            ${phoneCopy ? `
                            <div class="flex items-start justify-between gap-2 mt-2 acc-phone-wrap" data-copy="${safePhone}">
                                <p class="text-sm text-gray-600 flex-1">é›»è©±ï¼š${acc.phone}</p>
                                <button type="button" onclick="copyTextToClipboard(this.closest('.acc-phone-wrap').dataset.copy || '', 'ä½å®¿é›»è©±å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼')" class="muji-btn-light text-xs mt-0 px-2 py-1 inline-flex items-center shrink-0 hover:shadow-md">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            ` : ''}

                            <a href="${acc.mapLink}" target="_blank" class="muji-btn-light text-xs mt-2 px-2 py-1 inline-flex items-center hover:shadow-md">
                                <i class="fas fa-location-dot mr-1"></i> æŸ¥çœ‹åœ°åœ– / å°èˆª
                            </a>
                        </div>
                    `;
                    }).join('')}
                </div>
            `;

            container.innerHTML = html;
            setupFlightsStayListeners();
        }


        // --- èˆªç­ä½å®¿é ï¼šå‚™è¨»å¯ç·¨è¼¯ + ç·¨è¼¯æ¬„æ”¶èµ· ---
        function setupFlightsStayListeners() {
            const view = document.getElementById('flights-note-view');
            const editorWrap = document.getElementById('flights-note-editor');
            const input = document.getElementById('flights-note-input');
            const editBtn = document.getElementById('edit-flights-note-btn');
            const hideBtn = document.getElementById('hide-flights-note-editor-btn');
            const saveBtn = document.getElementById('save-flights-note-btn');
            const cancelBtn = document.getElementById('cancel-flights-note-btn');

            if (!view || !editorWrap || !input || !editBtn || !hideBtn || !saveBtn || !cancelBtn) return;

            function openEditor() {
                editorWrap.classList.remove('hidden');
                hideBtn.classList.remove('hidden');
                editBtn.classList.add('hidden');
                input.focus();
            }

            function closeEditor(reset = true) {
                editorWrap.classList.add('hidden');
                hideBtn.classList.add('hidden');
                editBtn.classList.remove('hidden');
                if (reset) {
                    input.value = view.textContent || '';
                }
            }

            editBtn.onclick = openEditor;
            hideBtn.onclick = () => closeEditor(false);
            cancelBtn.onclick = () => closeEditor(true);

            saveBtn.onclick = () => {
                const v = (input.value || '').trim();
                const updatedTripData = JSON.parse(JSON.stringify(tripData || {}));
                updatedTripData.flights_note = v;
                setTripData(updatedTripData);

                view.textContent = v.length ? v : '-';
                closeEditor(false);
                alertModal('èˆªç­å‚™è¨»å·²æ›´æ–°ï¼');
            };
        }

        // --- Tab: ITINERARY (æ¯æ—¥è¡Œç¨‹è¡¨) æ¸²æŸ“ (ä¸è®Š) ---
        function renderItineraryTab(container) {

            function extractAddressCopy(addrHtml) {
                const txt = String(addrHtml || '')
                    .replace(/<br\s*\/?>/gi, '\n')
                    .replace(/<[^>]+>/g, '')
                    .trim();
                const m = txt.match(/åœ°å€[:ï¼š]\s*([^\n]+)/);
                return m ? m[1].trim() : txt;
            }

            // æ ¹æ“šæ—¥æœŸå–å¾—ä½å®¿è³‡è¨Šï¼ˆDay3 ç„¡ä½å®¿ï¼‰
            function getAccommodation(dateStr) {
                if (/^Day3-/i.test(String(dateStr || ''))) return null;

                const dateParts = String(dateStr || '').match(/(\d+)\/(\d+)/);
                const dayValue = dateParts ? parseInt(dateParts[2], 10) : 0;

                const hotel = (tripData.accommodation && tripData.accommodation[0]) ? tripData.accommodation[0] : null;
                if (!hotel) return null;

                // åªé¡¯ç¤º Day1(1/24) & Day2(1/25) çš„ä½å®¿
                if (dayValue === 24 || dayValue === 25) return hotel;

                return null;
            }

            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">ğŸ—“ï¸ æ¯æ—¥è¡Œç¨‹ç´°ç¯€</h2>

                <p class="text-sm mb-6 text-gray-600">è¡Œç¨‹ä»¥æ™‚é–“è»¸æ–¹å¼å‘ˆç¾ï¼Œé»æ“Šã€Œç·¨è¼¯ã€å¯ä¿®æ”¹é …ç›®ï¼Œé»æ“Šã€Œæ–°å¢ã€å¯å¢åŠ é …ç›®ã€‚</p>

                ${tripData.itinerary.map((day, dayIndex) => {
                    const currentAccommodation = getAccommodation(day.date);

                    const accommodationHtml = currentAccommodation ? (() => {
                        const addrCopy = (currentAccommodation && currentAccommodation.address_copy) ? String(currentAccommodation.address_copy) : extractAddressCopy(currentAccommodation.address);
                        const safeCopy = addrCopy.replace(/"/g, '&quot;');
                        return `
                        <div class="mt-4 pt-4 border-t border-dashed" style="border-color: var(--color-divider);">
                            <h5 class="text-sm font-bold p-1 rounded inline-flex items-center" style="background-color: var(--color-highlight); color: var(--color-text-main);">
                                <i class="fas fa-bed mr-1 text-base"></i> ç•¶æ™šä½å®¿ï¼š${currentAccommodation.name}
                            </h5>
                            <div class="mt-1 flex items-start justify-between gap-2 stay-wrap" data-copy="${safeCopy}">
                             <p class="text-xs text-gray-600 stay-address flex-1">${currentAccommodation.address}</p>
                             <button type="button" onclick="copyTextToClipboard(this.closest('.stay-wrap').dataset.copy || '', 'ä½å®¿åœ°å€å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼')" class="muji-btn-light text-[11px] px-2 py-1 inline-flex items-center shrink-0 hover:shadow-md" style="border-color: var(--color-divider);">
                                 <i class="fas fa-copy"></i>
                             </button>
                         </div>
                            <a href="${currentAccommodation.mapLink}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800">
                                <i class="fas fa-location-dot mr-1"></i>æŸ¥çœ‹åœ°åœ–
                            </a>
                        </div>
                        `;
                    })() : '';

                    return `
                        <div class="mb-8 p-3 muji-card">
                            <div class="flex justify-between items-center">
                                <h4 class="text-lg font-bold text-white p-2 rounded-t-lg mb-4" style="background-color: var(--color-accent);">
                                    ${day.date}
                                </h4>
                                <button onclick="openItineraryItemModal(${dayIndex})" class="muji-btn text-xs px-3 py-1 mb-3">
                                    <i class="fas fa-plus mr-1"></i> æ–°å¢é …ç›®
                                </button>
                            </div>

                            <div class="relative pl-8">
                                ${day.items.map((item, itemIndex) => {
                                    const highlightStyle = item.highlight ? `background-color: var(--color-highlight); font-weight: bold; color: var(--color-text-main);` : '';
                                    const dotClass = item.highlight ? 'bg-red-500' : 'bg-gray-400';

                                    const itemBgColor = item.bgColor && item.bgColor !== '' ? item.bgColor : 'white';
                                    const itemContainerStyle = `background-color: ${itemBgColor}; border-color: var(--color-divider);`;

                                    const naverLink = item.naver_link || (item.address_copy ? `https://map.naver.com/v5/search/${encodeURIComponent(item.address_copy)}` : `https://map.naver.com/v5/search/${encodeURIComponent(item.name)}`);

                                    const itemLink = (item.link || item.naver_link || item.type === 'Food' || item.type === 'Activity') ? `
                                        <div class="mt-2 flex flex-wrap gap-2">
                                            ${item.link ? `
                                                <a href="${item.link}" target="_blank" class="muji-btn-light text-xs px-2 py-1 flex items-center hover:shadow-md">
                                                    <i class="fas fa-map-pin mr-1"></i> Google Map
                                                </a>
                                            ` : ''}
                                            <a href="${naverLink}" target="_blank" class="muji-btn-light text-xs px-2 py-1 flex items-center hover:shadow-md">
                                                <i class="fas fa-map mr-1"></i> Naver Map
                                            </a>
                                            <a href="https://www.google.com/search?q=${encodeURIComponent(item.name)} é£Ÿè¨˜" target="_blank" class="muji-btn-light text-xs px-2 py-1 flex items-center hover:shadow-md">
                                                <i class="fas fa-utensils mr-1"></i> é£Ÿè¨˜/ä»‹ç´¹
                                            </a>
                                        </div>
                                    ` : '';

                                    return `
                                        <div class="timeline-item relative pb-6 ml-3">
                                            <div class="timeline-dot ${dotClass} ${item.highlight ? 'ring-4' : ''}" style="border-color: var(--color-divider); background-color: ${item.highlight ? 'var(--color-text-main)' : 'var(--color-divider)'}; top: 2px; ${item.highlight ? 'box-shadow: 0 0 0 3px var(--color-highlight);' : ''}"></div>
                                            <div class="ml-4 p-3 rounded-lg border-l-4 shadow-sm" style="border-color: var(--color-divider); ${itemContainerStyle}">

                                                <div class="flex justify-between items-start">
                                                    <p class="text-sm font-medium p-1 rounded inline-block" style="${highlightStyle}">${item.time}</p>
                                                    <div class="flex space-x-2">
                                                        <button onclick="openItineraryItemModal(${dayIndex}, ${itemIndex})" class="muji-btn-light text-xs px-2 py-1 flex items-center hover:shadow-md">
                                                            <i class="fas fa-edit text-gray-600"></i>
                                                        </button>
                                                        <button onclick="deleteItineraryItem(${dayIndex}, ${itemIndex})" class="muji-btn-light text-xs px-2 py-1 flex items-center hover:shadow-md" style="color: #dc2626; border-color: #fca5a5;">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    </div>
                                                </div>

                                                <p class="text-base font-semibold mt-1" style="color: var(--color-text-main);">${item.name}</p>
                                                <p class="text-xs text-gray-500">${item.notes || item.type}</p>

                                                ${item.hours || item.address_copy ? `
                                                    <div class="mt-2 p-3 rounded-lg border-l-2" style="border-color: var(--color-accent); background-color: var(--color-bg-primary);">
                                                        ${item.hours ? `<p class="text-xs text-gray-700 mb-1"><i class="far fa-clock mr-1 text-sm" style="color: var(--color-text-main);"></i> ç‡Ÿæ¥­æ™‚é–“: <span class="font-medium">${item.hours}</span></p>` : ''}
                                                        ${item.address_copy ? `
                                                            <div class="mt-2 pt-2 border-t border-dashed" style="border-color: var(--color-divider);">
                                                                <p class="text-xs font-medium mb-1" style="color: var(--color-text-main);">åœ°å€ (ä¸€éµè¤‡è£½):</p>
                                                                <div class="flex items-center space-x-2">
                                                                    <p class="text-xs text-gray-600 font-mono break-all flex-1">${item.address_copy}</p>
                                                                    <button onclick="copyTextToClipboard(this.previousElementSibling.textContent)" class="muji-btn-light text-xs px-2 py-1 flex items-center shrink-0 hover:shadow-md">
                                                                        <i class="fas fa-copy"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                ` : ''}

                                                ${itemLink}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${accommodationHtml}
                        </div>
                    `;
                }).join('')}
            `;
            container.innerHTML = html;
        }
        // --- (æ·±åº¦å°è¦½) æ¸²æŸ“ (ä¸è®Š) ---
        function renderGuideTab(container) {
            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">ğŸ“– æ·±åº¦å°è¦½èˆ‡æ—…éŠæ‰‹å†Š</h2>
                <p class="text-sm mb-6 text-gray-600">æä¾›é‡é»æ™¯é»çš„æ­·å²èƒŒæ™¯èˆ‡å†·çŸ¥è­˜ï¼Œæ’ç‰ˆæ¨¡æ“¬é›œèªŒé¢¨æ ¼ï¼Œè®“é–±è®€æ›´è¼•é¬†ã€‚</p>
                
                ${tripData.guide_spots.map((spot, index) => `
                    <div class="muji-card p-5 mb-8">
                        <div class="flex items-center mb-4">
                            <span class="text-3xl font-serif text-white px-3 py-1 mr-3 rounded" style="background-color: var(--color-accent);">
                                ${index + 1}
                            </span>
                            <h3 class="text-xl font-bold" style="color: var(--color-text-main);">${spot.name}</h3>
                        </div>

                        <div class="p-4 rounded border-l-4" style="background-color: var(--color-bg-primary); border-color: var(--color-divider);">
                            <p class="text-sm italic mb-3" style="color: var(--color-text-main);">#æ­·å²èˆ‡æ–‡åŒ–</p>
                            <p class="text-base whitespace-pre-wrap text-gray-700">${spot.intro}</p>
                        </div>
                        
                        <h4 class="text-lg font-semibold mt-6 mb-3" style="color: var(--color-text-main);">åœ°åœ–ä½ç½® (OpenStreetMap)</h4>
                        <div class="aspect-video overflow-hidden rounded-lg border" style="border-color: var(--color-divider); box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);">
                            <iframe 
                                width="100%" 
                                height="100%" 
                                frameborder="0" 
                                scrolling="no" 
                                marginheight="0" 
                                marginwidth="0" 
                                src="https://www.openstreetmap.org/export/embed.html?bbox=${spot.map.lng - 0.005}%2C${spot.map.lat - 0.003}%2C${spot.map.lng + 0.005}%2C${spot.map.lat + 0.003}&layer=mapnik&marker=${spot.map.lat}%2C${spot.map.lng}" 
                                style="border: 0;">
                            </iframe>
                            <small>
                                <a href="https://www.openstreetmap.org/?mlat=${spot.map.lat}&mlon=${spot.map.lng}#map=16/${spot.map.lat}/${spot.map.lng}" target="_blank" class="text-xs text-gray-500 block text-right mt-1">æŸ¥çœ‹å¤§åœ–</a>
                            </small>
                        </div>
                    </div>
                `).join('')}
            `;
            container.innerHTML = html;
        }


        // --- Tab: WALLET (è¨˜å¸³èˆ‡åŒ¯ç‡) æ¸²æŸ“ ---
        function renderWalletTab(container) {
            // è¼‰å…¥è¨˜å¸³è³‡æ–™
            let expenses = getLocalStorage(expensesKey, []);

            const rateRecord = getLocalStorage(daesagwanRateKey, '');
            const rateRecordNote = getLocalStorage(rateRecordNoteKey, '');

            const PEOPLE_MULTI = ['æ¬£', 'çˆ', 'èŠ·', 'æ¹˜', 'å…¨é«”'];
            const PAYERS_MULTI = ['æ¬£', 'çˆ', 'èŠ·', 'æ¹˜', 'å„è‡ª'];

            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">ğŸ’° è¨˜å¸³èˆ‡åŒ¯ç‡ä¸­å¿ƒ</h2>

                <div class="muji-card p-4 mb-6">
                    <div class="flex items-center justify-between gap-2">
                        <h3 class="text-lg font-semibold flex items-center" style="color: var(--color-text-main);">
                            <i class="fas fa-clipboard-list mr-2 text-xl" style="color: var(--color-accent);"></i> åŒ¯ç‡ç´€éŒ„
                        </h3>
                    </div>

                    <label for="daesagwan-rate-input" class="block text-sm font-medium mb-1 mt-3" style="color: var(--color-text-main);">åŒ¯ç‡ç´€éŒ„ (VND/TWD)ï¼š</label>
                    <input type="text" id="daesagwan-rate-input" class="w-full p-2 mb-3 border rounded-lg text-sm" placeholder="e.g. 0.0013 (åƒ…ä¾›ç´€éŒ„)" style="border-color: var(--color-divider);" value="${String(rateRecord || '')}">

                    <div class="p-3 rounded border" style="border-color: var(--color-divider);">
                        <div class="flex items-center justify-between gap-2">
                            <p class="text-xs font-semibold" style="color: var(--color-text-main);">å‚™è¨»</p>
                            <div class="flex items-center gap-2">
                                <button id="edit-rate-record-note-btn" type="button" class="muji-btn-light text-xs px-2 py-1 hover:shadow-md">
                                    <i class="fas fa-edit mr-1"></i>ç·¨è¼¯
                                </button>
                                <button id="hide-rate-record-note-editor-btn" type="button" class="muji-btn-light text-xs px-2 py-1 hover:shadow-md hidden">
                                    <i class="fas fa-chevron-up mr-1"></i>æ”¶èµ·
                                </button>
                            </div>
                        </div>

                        <div id="rate-record-note-view" class="text-xs text-gray-600 mt-2 whitespace-pre-wrap">${(rateRecordNote && String(rateRecordNote).trim()) ? String(rateRecordNote) : '-'}</div>

                        <div id="rate-record-note-editor" class="mt-2 hidden">
                            <textarea id="rate-record-note-input" class="w-full p-2 border rounded-lg text-xs" rows="3" style="border-color: var(--color-divider);">${String(rateRecordNote || '')}</textarea>
                            <div class="flex gap-2 mt-2">
                                <button id="save-rate-record-note-btn" type="button" class="muji-btn text-xs px-3 py-1">
                                    <i class="fas fa-save mr-1"></i>å„²å­˜
                                </button>
                                <button id="cancel-rate-record-note-btn" type="button" class="muji-btn-light text-xs px-3 py-1" style="border-color: var(--color-divider);">
                                    å–æ¶ˆ
                                </button>
                            </div>
                        </div>
                    </div>
</div>

                <div class="muji-card p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-3" style="color: var(--color-text-main);">åŒ¯ç‡æ›ç®—æ©Ÿ (VND â†’ TWD)</h3>
                    <div class="flex space-x-2 mb-2">
                        <input type="number" id="rate-input" value="${Number(currentRate).toFixed(4)}" step="0.0001" class="w-1/3 p-2 border rounded-lg focus:ring-1 focus:ring-red-300" placeholder="0.0013" style="border-color: var(--color-divider); color: var(--color-text-main);">
                        <button id="set-rate-btn" class="muji-btn text-sm w-2/3">è¨­å®šç•¶å‰ VND/TWD åŒ¯ç‡</button>
                    </div>
                    <p class="text-xs text-gray-500 mb-3">å‚™è¨»ï¼šè¨˜å¾—é»é¸è¨­å®šéˆ•æ‰æœƒæ›´æ–°</p>

                    <div class="grid grid-cols-4 gap-2 p-3 rounded-lg" style="background-color: var(--color-bg-primary);">
                        <input type="text" id="calc-display" class="col-span-4 text-right text-2xl p-2 mb-2 rounded border font-mono bg-white" value="0" readonly style="border-color: var(--color-divider);">
                        <div id="calc-result" class="col-span-4 text-right text-sm text-gray-500">
                            ${TWD_SYMBOL} <span id="calc-twd-result">0.000</span>
                        </div>

                        <button class="calc-btn muji-btn-light text-xl" data-value="C" style="background-color: var(--color-divider);">C</button>
                        <button class="calc-btn muji-btn-light text-xl" data-value="back"><i class="fas fa-backspace"></i></button>
                        <button class="calc-btn muji-btn-light text-xl" data-value="/">Ã·</button>
                        <button class="calc-btn muji-btn-light text-xl" data-value="*">Ã—</button>

                        <button class="calc-btn muji-btn text-xl" data-value="7">7</button>
                        <button class="calc-btn muji-btn text-xl" data-value="8">8</button>
                        <button class="calc-btn muji-btn text-xl" data-value="9">9</button>
                        <button class="calc-btn muji-btn-light text-xl" data-value="-">âˆ’</button>

                        <button class="calc-btn muji-btn text-xl" data-value="4">4</button>
                        <button class="calc-btn muji-btn text-xl" data-value="5">5</button>
                        <button class="calc-btn muji-btn text-xl" data-value="6">6</button>
                        <button class="calc-btn muji-btn-light text-xl" data-value="+">&plus;</button>

                        <button class="calc-btn muji-btn text-xl" data-value="1">1</button>
                        <button class="calc-btn muji-btn text-xl" data-value="2">2</button>
                        <button class="calc-btn muji-btn text-xl" data-value="3">3</button>
                        <button class="calc-btn muji-btn-light text-xl row-span-2" data-value="=">=</button>

                        <button class="calc-btn muji-btn text-xl" data-value="00">00</button>
                        <button class="calc-btn muji-btn text-xl" data-value="0">0</button>
                        <button class="calc-btn muji-btn text-xl" data-value=".">.</button>
                    </div>
                </div>

                                <div class="muji-card p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-3" style="color: var(--color-text-main);">æ–°å¢ä¸€ç­†é–‹éŠ·</h3>

                    <label class="block text-sm font-medium mb-1" style="color: var(--color-text-main);">æ¶ˆè²»æ™‚é–“ï¼ˆå¯ç·¨è¼¯ï¼‰</label>
                    <input type="datetime-local" id="expense-datetime" class="w-full p-2 mb-2 border rounded-lg"
                           style="border-color: var(--color-divider); color: var(--color-text-main);">

                    <select id="expense-category" class="w-full p-2 mb-2 border rounded-lg" style="border-color: var(--color-divider);">
                        ${EXPENSE_CATEGORIES.map(cat => `<option value="${cat.key}">${cat.name}</option>`).join('')}
                    </select>

                    <input type="text" id="expense-item" class="w-full p-2 mb-2 border rounded-lg"
                           placeholder="å“é …åç¨± (e.g. åˆé¤ã€å’–å•¡)" style="border-color: var(--color-divider);">
                    <input type="number" id="expense-krw" class="w-full p-2 mb-2 border rounded-lg"
                           placeholder="è¶Šå—ç›¾é‡‘é¡ VND(Ä‘)" style="border-color: var(--color-divider);">

                    <input type="text" id="expense-notes" class="w-full p-2 mb-2 border rounded-lg"
                           placeholder="å‚™è¨»ï¼ˆé¸å¡«ï¼‰" style="border-color: var(--color-divider);">

                    <div class="mt-2">
                        <p class="text-sm font-medium mb-1" style="color: var(--color-text-main);">èª°æ¶ˆè²»ï¼ˆå¯è¤‡é¸ï¼‰</p>
                        <div class="flex flex-wrap gap-2">
                            ${PEOPLE_MULTI.map(p => `
                                <label class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border text-sm"
                                       style="border-color: var(--color-divider); background-color: white;">
                                    <input type="checkbox" class="consume-checkbox h-4 w-4" value="${p}">
                                    <span>${p}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div class="mt-3">
                        <p class="text-sm font-medium mb-1" style="color: var(--color-text-main);">èª°çµå¸³ï¼ˆå¯è¤‡é¸ï¼‰</p>
                        <div class="flex flex-wrap gap-2">
                            ${PAYERS_MULTI.map(p => `
                                <label class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border text-sm"
                                       style="border-color: var(--color-divider); background-color: white;">
                                    <input type="checkbox" class="payer-checkbox h-4 w-4" value="${p}">
                                    <span>${p}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <label class="block text-sm font-medium mt-3 mb-2" style="color: var(--color-text-main);">ä¸Šå‚³æˆ–æ‹ç…§ (å£“ç¸®ç‚ºç¸®åœ–)</label>
                    <input type="file" id="expense-photo" accept="image/*" capture="environment"
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold"
                           style="--file-bg: var(--color-highlight);" onMouseOver="this.style.backgroundColor='var(--color-highlight)'" onMouseOut="this.style.backgroundColor='var(--color-bg-primary)'">
                    <div id="photo-preview" class="mt-2 text-center text-sm text-gray-400">ï¼ˆåœ–ç‰‡å£“ç¸®å¾Œä¸æœƒä½”ç”¨å¤ªå¤šå®¹é‡ï¼Œæœ‰ç…§ç‰‡æ™‚ä¸æœƒé¡¯ç¤ºåˆ†é¡åœ–ç¤ºï¼‰</div>

                    <button id="add-expense-btn" class="muji-btn w-full mt-4">ç´€éŒ„é–‹éŠ·</button>
                </div>

                <h3 class="text-xl font-bold mb-3" style="color: var(--color-text-main);">ğŸ“œ è¨˜å¸³æ­·å²</h3>
                <div id="expense-list-container">
                    ${expenses.length === 0 ? '<p class="text-center text-gray-500 p-4">ç›®å‰æ²’æœ‰è¨˜å¸³ç´€éŒ„ã€‚</p>' : ''}
                </div>
            `;
            container.innerHTML = html;
            setupWalletListeners();
            renderExpenseList();
        }

        // æ¸²æŸ“è¨˜å¸³æ­·å²åˆ—è¡¨ (æ›´æ–°: é¡¯ç¤ºåˆ†é¡åœ–ç¤ºå’Œåˆªé™¤æŒ‰éˆ•)
        function _getExpenseTimeMs(exp) {
            // å„ªå…ˆä½¿ç”¨ spentAtï¼ˆnumber or parseableï¼‰
            if (exp && typeof exp.spentAt === 'number' && !Number.isNaN(exp.spentAt)) return exp.spentAt;
            if (exp && typeof exp.spentAt === 'string') {
                const t = Date.parse(exp.spentAt);
                if (!Number.isNaN(t)) return t;
            }
            // ç›¸å®¹èˆŠè³‡æ–™ï¼štimestampï¼ˆISOï¼‰
            if (exp && exp.timestamp) {
                const t = Date.parse(exp.timestamp);
                if (!Number.isNaN(t)) return t;
            }
            // æœ€å¾Œé€€å› idï¼ˆDate.now()ï¼‰
            if (exp && typeof exp.id === 'number') return exp.id;
            return Date.now();
        }

        function _fmtDateKey(ms) {
            const d = new Date(ms);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function _fmtDateLabel(ms) {
            const d = new Date(ms);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const wk = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][d.getDay()];
            return `${y}/${m}/${day}ï¼ˆ${wk}ï¼‰`;
        }

        function _fmtTime(ms) {
            const d = new Date(ms);
            const hh = String(d.getHours()).padStart(2, '0');
            const mi = String(d.getMinutes()).padStart(2, '0');
            return `${hh}:${mi}`;
        }

        function _formatVND(n) {
            return (Number(n || 0)).toLocaleString('en-US');
        }

        function _formatTWD(n) {
            const v = Number(n || 0);
            return v.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
        }

        function toggleExpenseEdit(expenseId) {
            const el = document.getElementById(`expense-edit-${expenseId}`);
            if (!el) return;
            el.classList.toggle('hidden');
        }

        function handleExpenseEditPhotoChange(evt, expenseId) {
            const file = evt && evt.target ? (evt.target.files && evt.target.files[0]) : null;
            if (!file) return;

            try {
                compressImage(file, (dataURL) => {
                    window.__expenseEditPhotoBuffer = window.__expenseEditPhotoBuffer || {};
                    window.__expenseEditPhotoBuffer[expenseId] = dataURL;

                    const preview = document.getElementById(`edit-photo-preview-${expenseId}`);
                    if (preview) {
                        preview.innerHTML = `<img src="${dataURL}" class="w-16 h-16 object-cover rounded-md mt-2 border" style="border-color: var(--color-divider);">`;
                    }
                });
            } catch (e) {
                console.error(e);
                alertModal('åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹æ”¹ç”¨è¼ƒå°çš„åœ–ç‰‡æˆ–é‡è©¦ã€‚');
            }
        }

        function saveExpenseEdit(expenseId) {
            const itemInp = document.getElementById(`edit-expense-item-${expenseId}`);
            const amountInp = document.getElementById(`edit-expense-krw-${expenseId}`);
            const categoryInp = document.getElementById(`edit-expense-category-${expenseId}`);
            const notesInp = document.getElementById(`edit-expense-notes-${expenseId}`);
            const timeInp = document.getElementById(`edit-expense-time-${expenseId}`);
            const removePhotoEl = document.getElementById(`edit-expense-remove-photo-${expenseId}`);

            const item = itemInp ? itemInp.value.trim() : '';
            const amount = amountInp ? parseInt(amountInp.value, 10) : NaN;
            const category = categoryInp ? categoryInp.value : '';
            const notes = notesInp ? notesInp.value.trim() : '';

            if (!item || isNaN(amount) || amount <= 0) {
                alertModal('è«‹è¼¸å…¥æœ‰æ•ˆçš„å“é …åç¨±èˆ‡è¶Šå—ç›¾é‡‘é¡ã€‚');
                return;
            }

            const consumers = Array.from(document.querySelectorAll(`.edit-consume-checkbox[data-id="${expenseId}"]:checked`)).map(el => el.value);
            const payers = Array.from(document.querySelectorAll(`.edit-payer-checkbox[data-id="${expenseId}"]:checked`)).map(el => el.value);

            let spentAtMs = null;
            if (timeInp && timeInp.value) {
                const t = Date.parse(timeInp.value);
                if (!Number.isNaN(t)) spentAtMs = t;
            }

            let expenses = getLocalStorage(expensesKey, []);
            if (!Array.isArray(expenses)) expenses = [];

            const idx = expenses.findIndex(x => x && x.id === expenseId);
            if (idx === -1) {
                alertModal('æ‰¾ä¸åˆ°é€™ç­†ç´€éŒ„ï¼Œè«‹é‡æ–°æ•´ç†å¾Œå†è©¦ã€‚');
                return;
            }

            window.__expenseEditPhotoBuffer = window.__expenseEditPhotoBuffer || {};
            const bufferedPhoto = window.__expenseEditPhotoBuffer[expenseId];

            const shouldRemove = !!(removePhotoEl && removePhotoEl.checked);

            expenses[idx] = {
                ...expenses[idx],
                item,
                krw: amount,
                category,
                notes: notes || '',
                consumers,
                payers,
                spentAt: spentAtMs !== null ? spentAtMs : _getExpenseTimeMs(expenses[idx]),
                // æœ‰å‹¾ç§»é™¤å°±æ¸…ç©ºï¼›æœ‰æ–°ä¸Šå‚³å°±ç”¨æ–°åœ–ï¼›å¦å‰‡ä¿ç•™åŸåœ–
                photo: shouldRemove ? null : (bufferedPhoto || expenses[idx].photo || null)
            };

            setLocalStorage(expensesKey, expenses);

            // æ¸…é™¤æš«å­˜åœ–
            delete window.__expenseEditPhotoBuffer[expenseId];

            renderExpenseList();
            alertModal('é–‹éŠ·ç´€éŒ„å·²æ›´æ–°ï¼');
        }

        function deleteExpense(expenseId) {
            if (!confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†é–‹éŠ·ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;

            let expenses = getLocalStorage(expensesKey, []);
            if (!Array.isArray(expenses)) expenses = [];

            const updated = expenses.filter(exp => exp && exp.id !== expenseId);
            setLocalStorage(expensesKey, updated);

            alertModal('é–‹éŠ·ç´€éŒ„å·²åˆªé™¤ã€‚');
            renderExpenseList();
        }

        function renderExpenseList() {
            const container = document.getElementById('expense-list-container');
            let expenses = getLocalStorage(expensesKey, []);

            if (!container) return;
            if (!Array.isArray(expenses)) expenses = [];

            if (expenses.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-4">ç›®å‰æ²’æœ‰è¨˜å¸³ç´€éŒ„ã€‚</p>';
                return;
            }

            // æ¨™æº–åŒ–æ™‚é–“ä¸¦ä¾æ¶ˆè²»æ™‚é–“æ’åºï¼ˆæ–°åˆ°èˆŠï¼‰
            const normalized = expenses.map(e => ({ ...e, _t: _getExpenseTimeMs(e) }))
                                      .sort((a, b) => b._t - a._t);

            const PEOPLE_BASE = PEOPLE_MULTI.filter(p => p !== 'å…¨é«”');
            const _allocByConsumers = (exp) => {
                const amount = Number(exp.krw || 0);
                let consumers = Array.isArray(exp.consumers) ? exp.consumers.slice() : [];
                consumers = consumers.filter(Boolean);

                // è¦å‰‡ï¼šå‹¾é¸ã€Œå…¨é«”ã€æˆ–æœªå‹¾é¸ä»»ä½•äºº -> è¦–ç‚º 4 äººå‡åˆ†
                let participants;
                if (consumers.includes('å…¨é«”') || consumers.length === 0) {
                    participants = PEOPLE_BASE.slice();
                } else {
                    participants = consumers.filter(p => PEOPLE_BASE.includes(p));
                    if (participants.length === 0) participants = PEOPLE_BASE.slice();
                }

                const share = participants.length ? (amount / participants.length) : 0;
                const by = {};
                for (const p of PEOPLE_BASE) by[p] = participants.includes(p) ? share : 0;

                return { amount, by, participants };
            };

            const _calcAllocTotals = (items) => {
                const rate = Number(currentRate) || 0;
                const byPersonVND = Object.fromEntries(PEOPLE_BASE.map(p => [p, 0]));
                let sumVND = 0;

                for (const exp of items) {
                    const { amount, by } = _allocByConsumers(exp);
                    sumVND += amount;
                    for (const p of PEOPLE_BASE) byPersonVND[p] += (by[p] || 0);
                }

                const sumTWD = sumVND * rate;
                const byPersonTWD = Object.fromEntries(PEOPLE_BASE.map(p => [p, byPersonVND[p] * rate]));
                return { sumVND, sumTWD, byPersonVND, byPersonTWD };
            };

            const allAgg = _calcAllocTotals(normalized);
            const totalVND = allAgg.sumVND;
            const totalTWD = allAgg.sumTWD;
            const totalByPerson = allAgg.byPersonVND;
            const totalByPersonTWD = allAgg.byPersonTWD;

            // åˆ†çµ„ï¼šä¸€å¤©ä¸€å¡Š
            const groups = new Map();
            for (const exp of normalized) {
                const key = _fmtDateKey(exp._t);
                if (!groups.has(key)) groups.set(key, []);
                groups.get(key).push(exp);
            }

            const dayKeys = Array.from(groups.keys()).sort((a, b) => (a < b ? 1 : -1)); // è¿‘åˆ°é 

            // ä¾éœ€æ±‚ï¼šæœ€å¤šé¡¯ç¤º 4 å¤©å€å¡Šï¼›è‹¥é‚„æœ‰æ›´æ—©çš„ï¼Œæ”¶åœ¨ã€Œæ›´æ—©ã€å¯å±•é–‹å€
            const primaryKeys = dayKeys.slice(0, 4);
            const olderKeys = dayKeys.slice(4);

            let html = `
                <div class="muji-card p-4 mb-4" style="border-color: var(--color-divider);">
                    <div class="flex items-center justify-between gap-3">
                        <div>
                            <p class="text-lg font-bold" style="color: var(--color-text-main);">å…¨æ—¥ç¸½è¨ˆ</p>
                            <p class="text-xs text-gray-600 mt-1">ä¾ã€Œèª°æ¶ˆè²»ã€è‡ªå‹•åˆ†æ”¤åˆ°å€‹äºº</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-black" style="color: var(--color-accent);">${_formatVND(totalVND)} VND</p>
                            <p class="text-sm text-gray-600 mt-1">â‰ˆ ${TWD_SYMBOL} ${_formatTWD(totalTWD)}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mt-3">
                        ${PEOPLE_BASE.map(p => `
                            <div class="flex items-center justify-between px-3 py-2 rounded-xl border" style="border-color: var(--color-divider); background-color: white;">
                                <span class="text-sm font-semibold" style="color: var(--color-text-main);">${p}</span>
                                <div class="text-right">
                                    <div class="text-sm font-bold" style="color: var(--color-accent);">${_formatVND(Math.round(totalByPerson[p] || 0))} VND</div>
                                    <div class="text-xs text-gray-600">â‰ˆ ${TWD_SYMBOL} ${_formatTWD(totalByPersonTWD[p] || 0)}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // ä¾æ—¥æœŸè¼¸å‡ºï¼ˆæ¯ä¸€å¤©ä¸€å¡Šï¼Œå«ç•¶å¤©ç¸½è¨ˆï¼‰
            for (const key of primaryKeys) {
                const items = groups.get(key) || [];
                const dayAgg = _calcAllocTotals(items);
                const dayVND = dayAgg.sumVND;
                const dayTWD = dayAgg.sumTWD;
                const dayByPerson = dayAgg.byPersonVND;
                const dayByPersonTWD = dayAgg.byPersonTWD;

                const labelMs = items.length ? items[0]._t : Date.now();

                html += `
                    <div class="muji-card p-4 mb-4" style="border-color: var(--color-divider);">
                        <div class="flex items-start justify-between gap-3 border-b pb-2" style="border-color: var(--color-divider);">
                            <div>
                                <p class="text-lg font-bold" style="color: var(--color-text-main);">${_fmtDateLabel(labelMs)}</p>
                                <p class="text-xs text-gray-500 mt-0.5">ä¾æ¶ˆè²»æ™‚é–“æ’åºï¼ˆæ–°åˆ°èˆŠï¼‰</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold" style="color: var(--color-text-main);">ç•¶å¤©ç¸½è¨ˆ</p>
                                <p class="text-lg font-black" style="color: var(--color-accent);">${_formatVND(dayVND)} VND</p>
                                <p class="text-xs text-gray-600">â‰ˆ ${TWD_SYMBOL} ${_formatTWD(dayTWD)}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2 mt-3">
                            ${PEOPLE_BASE.map(p => `
                                <div class="flex items-center justify-between px-3 py-2 rounded-xl border" style="border-color: var(--color-divider); background-color: white;">
                                    <span class="text-sm font-semibold" style="color: var(--color-text-main);">${p}</span>
                                    <div class="text-right">
                                        <div class="text-sm font-bold" style="color: var(--color-accent);">${_formatVND(Math.round(dayByPerson[p] || 0))} VND</div>
                                        <div class="text-xs text-gray-600">â‰ˆ ${TWD_SYMBOL} ${_formatTWD(dayByPersonTWD[p] || 0)}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="space-y-3 mt-3">
                            ${items.map(exp => {
                                const catInfo = getCategoryInfo(exp.category);
                                const consumers = Array.isArray(exp.consumers) ? exp.consumers : [];
                                const payers = Array.isArray(exp.payers) ? exp.payers : [];
                                const notes = (exp.notes || '').trim();

                                const whoLine = (consumers.length || payers.length)
                                    ? `<p class="text-xs text-gray-500 mt-1">æ¶ˆè²»ï¼š${consumers.length ? consumers.join('ã€') : '-'} ï½œ çµå¸³ï¼š${payers.length ? payers.join('ã€') : '-'}</p>`
                                    : '';

                                const notesLine = notes ? `<p class="text-xs text-gray-600 mt-1">å‚™è¨»ï¼š${escapeHTML(notes)}</p>` : '';

                                const timeLabel = _fmtTime(exp._t);

                                return `
                                    <div class="muji-card p-3 border" style="border-color: var(--color-divider);">
                                        <div class="flex items-start justify-between gap-3">
                                            <div class="flex items-center space-x-3 flex-1 min-w-0">
                                                ${exp.photo ?
                                                    `<img src="${exp.photo}" class="w-12 h-12 object-cover rounded-md border" style="border-color: var(--color-divider);">` :
                                                    `<div class="w-12 h-12 rounded-md flex items-center justify-center border" style="border-color: var(--color-divider); background-color: var(--color-bg-primary);">
                                                        <i class="fas ${catInfo.icon} text-lg" style="color: var(--color-accent);"></i>
                                                     </div>`
                                                }
                                                <div class="min-w-0">
                                                    <p class="font-semibold truncate" style="color: var(--color-text-main);">${escapeHTML(exp.item || '')}</p>
                                                    <p class="text-xs text-gray-500 mt-0.5">${timeLabel} ï½œ ${catInfo.name}</p>
                                                    ${whoLine}
                                                    ${notesLine}
                                                </div>
                                            </div>

                                            <div class="flex flex-col items-end gap-2 shrink-0">
                                                <div class="text-right">
                                                    <p class="font-bold" style="color: var(--color-text-main);">${_formatVND(exp.krw)} VND</p>
                                                    <p class="text-xs text-gray-600">â‰ˆ ${TWD_SYMBOL} ${_formatTWD((Number(exp.krw) || 0) * (Number(currentRate) || 0))}</p>
                                                </div>

                                                <div class="flex items-center gap-3">
                                                    <button type="button" class="text-gray-500 hover:text-indigo-600" title="ç·¨è¼¯"
                                                            onclick="toggleExpenseEdit(${exp.id})">
                                                        <i class="fas fa-pen"></i>
                                                    </button>
                                                    <button type="button" class="text-gray-500 hover:text-red-600" title="åˆªé™¤"
                                                            onclick="deleteExpense(${exp.id})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="expense-edit-${exp.id}" class="hidden mt-3 pt-3 border-t" style="border-color: var(--color-divider);">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                <div>
                                                    <label class="block text-xs font-medium mb-1" style="color: var(--color-text-main);">æ¶ˆè²»æ™‚é–“</label>
                                                    <input type="datetime-local" id="edit-expense-time-${exp.id}" class="w-full p-2 border rounded-lg text-sm"
                                                           style="border-color: var(--color-divider); color: var(--color-text-main);"
                                                           value="${(() => {
                                                               const d = new Date(exp._t);
                                                               const pad = (n) => String(n).padStart(2,'0');
                                                               return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
                                                           })()}">
                                                </div>

                                                <div>
                                                    <label class="block text-xs font-medium mb-1" style="color: var(--color-text-main);">åˆ†é¡</label>
                                                    <select id="edit-expense-category-${exp.id}" class="w-full p-2 border rounded-lg text-sm" style="border-color: var(--color-divider);">
                                                        ${EXPENSE_CATEGORIES.map(cat => `<option value="${cat.key}" ${cat.key === exp.category ? 'selected' : ''}>${cat.name}</option>`).join('')}
                                                    </select>
                                                </div>

                                                <div>
                                                    <label class="block text-xs font-medium mb-1" style="color: var(--color-text-main);">å“é …</label>
                                                    <input type="text" id="edit-expense-item-${exp.id}" class="w-full p-2 border rounded-lg text-sm"
                                                           style="border-color: var(--color-divider); color: var(--color-text-main);" value="${escapeHTML(exp.item || '')}">
                                                </div>

                                                <div>
                                                    <label class="block text-xs font-medium mb-1" style="color: var(--color-text-main);">é‡‘é¡ (VND)</label>
                                                    <input type="number" id="edit-expense-krw-${exp.id}" class="w-full p-2 border rounded-lg text-sm"
                                                           style="border-color: var(--color-divider); color: var(--color-text-main);" value="${Number(exp.krw || 0)}">
                                                </div>

                                                <div class="md:col-span-2">
                                                    <label class="block text-xs font-medium mb-1" style="color: var(--color-text-main);">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                                                    <input type="text" id="edit-expense-notes-${exp.id}" class="w-full p-2 border rounded-lg text-sm"
                                                           style="border-color: var(--color-divider); color: var(--color-text-main);" value="${escapeHTML(exp.notes || '')}">
                                                </div>
                                            </div>

                                            <div class="mt-3">
                                                <p class="text-xs font-medium mb-1" style="color: var(--color-text-main);">èª°æ¶ˆè²»ï¼ˆå¯è¤‡é¸ï¼‰</p>
                                                <div class="flex flex-wrap gap-2">
                                                    ${PEOPLE_MULTI.map(p => {
                                                        const checked = consumers.includes(p) ? 'checked' : '';
                                                        return `
                                                            <label class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border text-sm"
                                                                   style="border-color: var(--color-divider); background-color: white;">
                                                                <input type="checkbox" class="edit-consume-checkbox h-4 w-4" data-id="${exp.id}" value="${p}" ${checked}>
                                                                <span>${p}</span>
                                                            </label>
                                                        `;
                                                    }).join('')}
                                                </div>
                                            </div>

                                            <div class="mt-3">
                                                <p class="text-xs font-medium mb-1" style="color: var(--color-text-main);">èª°çµå¸³ï¼ˆå¯è¤‡é¸ï¼‰</p>
                                                <div class="flex flex-wrap gap-2">
                                                    ${PAYERS_MULTI.map(p => {
                                                        const checked = payers.includes(p) ? 'checked' : '';
                                                        return `
                                                            <label class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border text-sm"
                                                                   style="border-color: var(--color-divider); background-color: white;">
                                                                <input type="checkbox" class="edit-payer-checkbox h-4 w-4" data-id="${exp.id}" value="${p}" ${checked}>
                                                                <span>${p}</span>
                                                            </label>
                                                        `;
                                                    }).join('')}
                                                </div>
                                            </div>

                                            <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2 items-start">
                                                <div>
                                                    <label class="block text-xs font-medium mb-1" style="color: var(--color-text-main);">æ›´æ›ç…§ç‰‡ï¼ˆé¸å¡«ï¼‰</label>
                                                    <input type="file" id="edit-expense-photo-${exp.id}" accept="image/*"
                                                           class="block w-full text-sm text-gray-500"
                                                           onchange="handleExpenseEditPhotoChange(event, ${exp.id})">
                                                    <div class="mt-2" id="edit-photo-preview-${exp.id}">
                                                        ${exp.photo ? `<img src="${exp.photo}" class="w-16 h-16 object-cover rounded-md border" style="border-color: var(--color-divider);">` : `<span class="text-xs text-gray-400">ç›®å‰ç„¡ç…§ç‰‡</span>`}
                                                    </div>
                                                </div>

                                                <div class="pt-6">
                                                    <label class="inline-flex items-center gap-2 text-sm">
                                                        <input type="checkbox" id="edit-expense-remove-photo-${exp.id}" class="h-4 w-4">
                                                        <span class="text-gray-700">ç§»é™¤ç›®å‰ç…§ç‰‡</span>
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="flex gap-2 mt-4">
                                                <button type="button" class="muji-btn flex-1" onclick="saveExpenseEdit(${exp.id})">å„²å­˜</button>
                                                <button type="button" class="muji-btn-light flex-1" onclick="toggleExpenseEdit(${exp.id})">æ”¶èµ·</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // è¨­ç½® Wallet Tab çš„äº‹ä»¶ç›£è½å™¨ (å·²åŠ å…¥å„²å­˜æˆåŠŸæç¤º)
        function setupWalletListeners() {
            // --- åŒ¯ç‡è¨­å®š ---
            document.getElementById('set-rate-btn').addEventListener('click', () => {
                const input = document.getElementById('rate-input');
                const newRate = parseFloat(input.value);
                if (newRate > 0) {
                    currentRate = newRate;
                    setLocalStorage(exchangeRateKey, newRate);
                    updateRateDisplay();
                    renderExpenseList();
                    alertModal('åŒ¯ç‡å·²æ›´æ–°ï¼');
                } else {
                    alertModal("è«‹è¼¸å…¥æœ‰æ•ˆçš„åŒ¯ç‡ã€‚");
                }
            });

            // --- åŒ¯ç‡ç´€éŒ„ï¼šå¯ç·¨è¼¯ ---
            const rateRecordInput = document.getElementById('daesagwan-rate-input');
            if (rateRecordInput) {
                const persist = () => setLocalStorage(daesagwanRateKey, rateRecordInput.value.trim());
                rateRecordInput.addEventListener('input', persist);
                rateRecordInput.addEventListener('change', persist);
            }

            // --- åŒ¯ç‡ç´€éŒ„å‚™è¨»ï¼šç·¨è¼¯æ¬„å¯æ”¶èµ·ï¼Œåƒ…é¡¯ç¤ºç·¨è¼¯å¾Œå…§å®¹ ---
            const noteView = document.getElementById('rate-record-note-view');
            const noteEditorWrap = document.getElementById('rate-record-note-editor');
            const noteInput = document.getElementById('rate-record-note-input');
            const editBtn = document.getElementById('edit-rate-record-note-btn');
            const hideBtn = document.getElementById('hide-rate-record-note-editor-btn');
            const saveBtn = document.getElementById('save-rate-record-note-btn');
            const cancelBtn = document.getElementById('cancel-rate-record-note-btn');

            if (noteView && noteEditorWrap && noteInput && editBtn && hideBtn && saveBtn && cancelBtn) {
                function openEditor() {
                    noteEditorWrap.classList.remove('hidden');
                    hideBtn.classList.remove('hidden');
                    editBtn.classList.add('hidden');
                    noteInput.focus();
                }
                function closeEditor(reset = true) {
                    noteEditorWrap.classList.add('hidden');
                    hideBtn.classList.add('hidden');
                    editBtn.classList.remove('hidden');
                    if (reset) noteInput.value = String(getLocalStorage(rateRecordNoteKey, '') || '');
                }
                editBtn.onclick = openEditor;
                hideBtn.onclick = () => closeEditor(false);
                cancelBtn.onclick = () => closeEditor(true);
                saveBtn.onclick = () => {
                    const v = (noteInput.value || '').trim();
                    setLocalStorage(rateRecordNoteKey, v);
                    noteView.textContent = v.length ? v : '-';
                    closeEditor(false);
                    alertModal('å‚™è¨»å·²æ›´æ–°ï¼');
                };
            }

            // --- è¨ˆç®—æ©Ÿé‚è¼¯ ---
            const display = document.getElementById('calc-display');
            const twdResult = document.getElementById('calc-twd-result');
            const buttons = document.querySelectorAll('.calc-btn');

            buttons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const value = e.currentTarget.dataset.value;
                    let current = display.value === '0' ? '' : display.value;

                    try {
                        if (value === 'C') {
                            display.value = '0';
                        } else if (value === 'back') {
                            display.value = current.length > 1 ? current.slice(0, -1) : '0';
                        } else if (value === '=') {
                            const safeExpression = current.replace(/[^-()\d/*+. ]/g, '');
                            const amountTotal = eval(safeExpression);
                            if (isNaN(amountTotal) || !isFinite(amountTotal)) throw new Error('Invalid calculation');
                            display.value = Math.floor(amountTotal).toString(); // è¶Šå—ç›¾ä»¥æ•´æ•¸ç‚ºä¸»
                        } else {
                            if (current === '0' && value !== '.') current = '';
                            display.value = current + value;
                        }

                        let amount = 0;
                        try {
                            const safeExpression = display.value.replace(/[^-()\d/*+. ]/g, '');
                            amount = eval(safeExpression) || 0;
                        } catch (e) {
                            amount = 0;
                        }

                        twdResult.textContent = formatTwd(Math.floor(amount), 3);

                    } catch (e) {
                        display.value = 'Error';
                        twdResult.textContent = '0.000';
                        console.error('Calculator error:', e);
                    }
                });
            });

            // --- è¨˜å¸³åŠŸèƒ½ ---
            const photoInput = document.getElementById('expense-photo');
            let base64Photo = null;
            // é è¨­æ¶ˆè²»æ™‚é–“ï¼šç¾åœ¨ï¼ˆå¯è‡ªè¡Œæ”¹ï¼‰
            const dtInput = document.getElementById('expense-datetime');
            if (dtInput && !dtInput.value) {
                const d = new Date();
                const pad = (n) => String(n).padStart(2,'0');
                dtInput.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
            }


            photoInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    compressImage(file, (dataURL) => {
                        base64Photo = dataURL;
                        const preview = document.getElementById('photo-preview');
                        preview.innerHTML = `<img src="${dataURL}" class="w-20 h-20 object-cover mx-auto rounded-md mt-2 border" style="border-color: var(--color-divider);">`;
                    });
                }
            });

            document.getElementById('add-expense-btn').addEventListener('click', () => {
                const dtInput = document.getElementById('expense-datetime');
                const itemInput = document.getElementById('expense-item');
                const amountInput = document.getElementById('expense-krw');
                const categoryInput = document.getElementById('expense-category');
                const notesInput = document.getElementById('expense-notes');

                const item = itemInput ? itemInput.value.trim() : '';
                const amount = amountInput ? parseInt(amountInput.value, 10) : NaN;
                const category = categoryInput ? categoryInput.value : (EXPENSE_CATEGORIES[0] ? EXPENSE_CATEGORIES[0].key : '');
                const notes = notesInput ? notesInput.value.trim() : '';

                const consumers = Array.from(document.querySelectorAll('.consume-checkbox:checked')).map(el => el.value);
                const payers = Array.from(document.querySelectorAll('.payer-checkbox:checked')).map(el => el.value);

                if (!item || isNaN(amount) || amount <= 0) {
                    alertModal("è«‹è¼¸å…¥æœ‰æ•ˆçš„å“é …åç¨±å’Œè¶Šå—ç›¾é‡‘é¡ã€‚");
                    return;
                }

                // ç”±ä½¿ç”¨è€…è¼¸å…¥çš„æ¶ˆè²»æ™‚é–“æ±ºå®šæ’åºï¼›è‹¥æœªå¡«ï¼Œé è¨­ç¾åœ¨
                let spentAt = Date.now();
                if (dtInput && dtInput.value) {
                    const t = Date.parse(dtInput.value);
                    if (!Number.isNaN(t)) spentAt = t;
                }

                const newExpense = {
                    id: Date.now(),
                    item,
                    krw: amount, // ä¿ç•™åŸæ¬„ä½åä»¥å…¼å®¹èˆŠè³‡æ–™ï¼ˆæ­¤è™•ä»£è¡¨ VNDï¼‰
                    category,
                    notes,
                    consumers,
                    payers,
                    photo: base64Photo,
                    spentAt,
                    timestamp: new Date().toISOString()
                };

                let expenses = getLocalStorage(expensesKey, []);
                if (!Array.isArray(expenses)) expenses = [];
                expenses.push(newExpense);
                setLocalStorage(expensesKey, expenses);

                // æ¸…ç©ºè¡¨å–®
                if (itemInput) itemInput.value = '';
                if (amountInput) amountInput.value = '';
                if (categoryInput) categoryInput.value = EXPENSE_CATEGORIES[0] ? EXPENSE_CATEGORIES[0].key : '';
                if (notesInput) notesInput.value = '';
                if (photoInput) photoInput.value = '';
                const pv = document.getElementById('photo-preview');
                if (pv) pv.innerHTML = 'ï¼ˆåœ–ç‰‡å£“ç¸®å¾Œä¸æœƒä½”ç”¨å¤ªå¤šå®¹é‡ï¼Œæœ‰ç…§ç‰‡æ™‚ä¸æœƒé¡¯ç¤ºåˆ†é¡åœ–ç¤ºï¼‰';
                base64Photo = null;

                // é‡è¨­è¤‡é¸
                document.querySelectorAll('.consume-checkbox').forEach(el => el.checked = false);
                document.querySelectorAll('.payer-checkbox').forEach(el => el.checked = false);

                // é‡è¨­æ¶ˆè²»æ™‚é–“ç‚ºç¾åœ¨
                if (dtInput) {
                    const d = new Date();
                    const pad = (n) => String(n).padStart(2,'0');
                    dtInput.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
                }

                renderExpenseList();
                alertModal('é–‹éŠ·é …ç›®å·²æˆåŠŸç´€éŒ„ï¼');
            });
        }


        // --- Tab: LISTS (æ¸…å–®) æ¸²æŸ“ (å·²é‡æ§‹) ---
        // --- (æ¸…å–®) æ¸²æŸ“ (å·²é‡æ§‹) ---
        function renderListsTab(container) {
            // è¼‰å…¥æ¸…å–®å’Œå‚™å¿˜éŒ„
            const checklist = getLocalStorage(checklistKey, initialChecklist);
            const memoText = getLocalStorage(memoKey, "æ­¡è¿ä½¿ç”¨å‚™å¿˜éŒ„ï¼å¯ä»¥åœ¨é€™è£¡è¨˜éŒ„ç¶²å€ï¼Œæœƒè‡ªå‹•è½‰æ›æˆé€£çµæŒ‰éˆ•ã€‚\n\nä¾‹å¦‚ï¼š\nNaver åœ°åœ–: https://map.naver.com/");

            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">ğŸ“ è¡Œå‰æ¸…å–®èˆ‡å‚™å¿˜éŒ„</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div id="luggage-list-card" class="muji-card p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-bold" style="color: var(--color-text-main);">è¡Œææ¸…å–® (Luggage)</h3>
                            <button onclick="openListItemModal('luggage')" class="muji-btn text-xs px-3 py-1" style=" height: 40px; display: flex; align-items: center;width: 100px;justify-content: space-around;background-color: #D8C6BA;">
                                <i class="fas fa-plus mr-1"></i> æ–°å¢
                            </button>
                        </div>
                        <p id="luggage-count" class="text-xs text-gray-500 mb-3"></p>
                        <div id="luggage-container" class="space-y-3">
                            </div>
                    </div>

                    <div id="todo-list-card" class="muji-card p-4">
                        <div class="flex justify-between items-center mb-3">
                          <div>
                            <h3 class="text-lg font-bold" style="color: var(--color-text-main);">ä»£è¾¦äº‹é …</h3>
                            <h3 class="text-lg font-bold" style="color: var(--color-text-main);">(To-do)</h3>
                          </div>
                            <button onclick="openListItemModal('todo')" class="muji-btn text-xs px-3 py-1"style=" height: 40px; display: flex; align-items: center;width: 90px;justify-content: space-around;background-color: #D8C6BA;">
                                <i class="fas fa-plus mr-1"></i> æ–°å¢
                            </button>
                        </div>
                        <p id="todo-count" class="text-xs text-gray-500 mb-3"></p>
                        <div id="todo-container" class="space-y-3">
                            </div>
                    </div>
                </div>

                <div class="muji-card p-4">
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2" style="color: var(--color-text-main); border-color: var(--color-divider);">å€‹äººå‚™å¿˜éŒ„</h3>
                    <textarea id="memo-input" class="w-full p-3 h-40 border rounded-lg focus:ring-1 focus:ring-red-300 text-sm" placeholder="è¼¸å…¥æ‚¨çš„å‚™å¿˜å…§å®¹..." style="border-color: var(--color-divider); color: var(--color-text-main);">${memoText}</textarea>
                    <button id="save-memo-btn" class="muji-btn w-full mt-3">å„²å­˜å‚™å¿˜éŒ„</button>
                    <div class="mt-4 p-3 rounded-lg" id="memo-output" style="background-color: var(--color-bg-primary);">
                        <h4 class="font-medium mb-2" style="color: var(--color-text-main);">é€£çµé è¦½ (è‡ªå‹•è½‰æ›)</h4>
                        </div>
                </div>
            `;
            container.innerHTML = html;
            setupListsListeners();
        }

        // æ¸²æŸ“å–®ä¸€ CheckList é …ç›®ï¼ˆåŠ å…¥ 4 äººåœ“åœˆç¢ºèªï¼‰
        function renderChecklist(category) {
            const container = document.getElementById(`${category}-container`);
            const countDisplay = document.getElementById(`${category}-count`);
            if (!container || !countDisplay) return;

            let checklist = getLocalStorage(checklistKey, initialChecklist);
            const items = checklist[category] || [];

            // æ­£è¦åŒ–ï¼šè£œé½Š personChecksï¼Œä¸¦åŒæ­¥ checked <-> 4 äººåœ“åœˆ
            let changed = false;
            items.forEach(item => {
                if (!item.personChecks || typeof item.personChecks !== 'object') {
                    item.personChecks = {};
                    CHECKLIST_PEOPLE.forEach(p => item.personChecks[p] = !!item.checked);
                    changed = true;
                } else {
                    CHECKLIST_PEOPLE.forEach(p => {
                        if (typeof item.personChecks[p] !== 'boolean') {
                            item.personChecks[p] = !!item.checked;
                            changed = true;
                        }
                    });
                }

                const allChecked = CHECKLIST_PEOPLE.every(p => !!item.personChecks[p]);
                if (item.checked !== allChecked) {
                    item.checked = allChecked;
                    changed = true;
                }
            });

            if (changed) {
                setLocalStorage(checklistKey, checklist);
            }

            const checkedCount = items.filter(item => item.checked).length;
            const totalCount = items.length;

            // æ›´æ–°è¨ˆæ•¸å™¨
            countDisplay.innerHTML = `å·²å®Œæˆ <span class="font-bold text-lg" style="color: var(--color-text-main);">${checkedCount}</span> / ç¸½é …ç›® <span class="font-bold text-lg">${totalCount}</span>`;

            container.innerHTML = items.map((item) => {
                const dots = CHECKLIST_PEOPLE.map(p => `
                    <label class="inline-flex items-center gap-1 cursor-pointer select-none" title="${p}">
                        <input type="checkbox"
                               class="h-4 w-4 rounded-full border-gray-300 focus:ring-red-500 cursor-pointer"
                               style="color: var(--color-text-main); border-color: var(--color-divider);"
                               ${item.personChecks && item.personChecks[p] ? 'checked' : ''}
                               onclick="toggleChecklistPerson('${category}', ${item.id}, '${p}')">
                        <span class="text-[11px] text-gray-600">${p}</span>
                    </label>
                `).join('');

                return `
                <div class="p-2 rounded border transition duration-150" style="border-color: var(--color-divider); background-color: ${item.checked ? 'var(--color-bg-primary)' : 'white'};">
                    <div class="flex items-start justify-between gap-2">
                        <div class="flex items-start flex-1 min-w-0">
                            <input type="checkbox" id="check-${category}-${item.id}" data-id="${item.id}" data-category="${category}"
                                   class="h-5 w-5 border-gray-300 rounded focus:ring-red-500 cursor-pointer"
                                   style="color: var(--color-text-main); border-color: var(--color-divider);"
                                   ${item.checked ? 'checked' : ''}
                                   onclick="toggleChecklistItem('${category}', ${item.id})">

                            <div class="ml-3 flex-1 min-w-0">
                                <div class="flex items-center gap-3 flex-wrap mb-1">
                                    ${dots}
                                </div>

                                <label for="check-${category}-${item.id}" class="text-sm block break-words cursor-pointer">
                                    <p class="font-medium ${item.checked ? 'line-through text-gray-500' : 'text-gray-800'}" style="color: ${item.checked ? 'gray' : 'var(--color-text-main)'};">${item.text}</p>
                                    ${item.notes ? `<p class="text-xs text-gray-400 mt-0.5">${item.notes}</p>` : ''}
                                </label>
                            </div>
                        </div>

                        <div class="flex space-x-1.5 ml-2 shrink-0">
                            <button onclick="openListItemModal('${category}', ${item.id})" class="muji-btn-light text-xs px-2 py-1 flex items-center hover:shadow-md" style="background-color: white;">
                                <i class="fas fa-edit text-gray-600"></i>
                            </button>
                            <button onclick="deleteListItem('${category}', ${item.id})" class="muji-btn-light text-xs px-2 py-1 flex items-center hover:shadow-md" style="background-color: white; color: #dc2626; border-color: #fca5a5;">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // åˆ‡æ›æ¸…å–®é …ç›®ç‹€æ…‹ï¼ˆä¸»æ–¹æ¡†ï¼šåŒæ­¥ 4 å€‹åœ“åœˆï¼‰
        function toggleChecklistItem(category, itemId) {
            let checklist = getLocalStorage(checklistKey, initialChecklist);
            const item = checklist[category].find(i => i.id === itemId);
            if (item) {
                if (!item.personChecks || typeof item.personChecks !== 'object') item.personChecks = {};
                const newChecked = !item.checked;
                CHECKLIST_PEOPLE.forEach(p => item.personChecks[p] = newChecked);
                item.checked = newChecked;
                setLocalStorage(checklistKey, checklist);
                renderChecklist(category);
            }
        }

        // åˆ‡æ›æŒ‡å®šäººçš„åœ“åœˆï¼ˆ4 å€‹å…¨å‹¾æ‰æœƒè‡ªå‹•å‹¾ä¸»æ–¹æ¡†ï¼‰
        function toggleChecklistPerson(category, itemId, person) {
            let checklist = getLocalStorage(checklistKey, initialChecklist);
            const item = checklist[category].find(i => i.id === itemId);
            if (item) {
                if (!item.personChecks || typeof item.personChecks !== 'object') item.personChecks = {};
                CHECKLIST_PEOPLE.forEach(p => {
                    if (typeof item.personChecks[p] !== 'boolean') item.personChecks[p] = false;
                });
                item.personChecks[person] = !item.personChecks[person];
                item.checked = CHECKLIST_PEOPLE.every(p => item.personChecks[p]);
                setLocalStorage(checklistKey, checklist);
                renderChecklist(category);
            }
        }

        // é–‹å•Ÿæ¸…å–®ç·¨è¼¯ Modal (æ–°å¢)
        function openListItemModal(category, itemId = null) {
            const modal = document.getElementById('list-modal');
            const form = document.getElementById('list-form');
            const title = document.getElementById('list-modal-title');
            
            form.reset();
            document.getElementById('list-modal-category').value = category;
            document.getElementById('list-modal-item-id').value = itemId !== null ? itemId : '';
            
            if (itemId !== null) {
                // ç·¨è¼¯æ¨¡å¼
                title.textContent = "ç·¨è¼¯æ¸…å–®é …ç›®";
                const checklist = getLocalStorage(checklistKey, initialChecklist);
                const item = checklist[category].find(i => i.id === itemId);
                if (item) {
                    document.getElementById('list-modal-text').value = item.text || '';
                    document.getElementById('list-modal-notes').value = item.notes || '';
                }
            } else {
                // æ–°å¢æ¨¡å¼
                title.textContent = `æ–°å¢ ${category === 'luggage' ? 'è¡Œæ' : 'ä»£è¾¦'} é …ç›®`;
            }

            modal.classList.remove('hidden');
        }
        
        // å„²å­˜æ¸…å–®é …ç›® (æ–°å¢)
        function handleListItemSave(event) {
            event.preventDefault();
            
            const category = document.getElementById('list-modal-category').value;
            const itemIdStr = document.getElementById('list-modal-item-id').value;
            const itemId = itemIdStr === '' ? null : parseInt(itemIdStr, 10);
            
            const text = document.getElementById('list-modal-text').value.trim();
            const notes = document.getElementById('list-modal-notes').value.trim();
            
            if (!text) {
                alertModal('é …ç›®åç¨±ä¸èƒ½ç‚ºç©ºï¼');
                return;
            }
            
            let checklist = getLocalStorage(checklistKey, initialChecklist);
            
            const newItem = {
                text: text,
                notes: notes,
                checked: false,
                personChecks: { 'æ¬£': false, 'çˆ': false, 'èŠ·': false, 'æ¹˜': false }
            };

            if (itemId !== null) {
                // ç·¨è¼¯ç¾æœ‰é …ç›®
                const index = checklist[category].findIndex(i => i.id === itemId);
                if (index !== -1) {
                    checklist[category][index].text = newItem.text;
                    checklist[category][index].notes = newItem.notes;
                    alertModal('é …ç›®å·²æ›´æ–°ï¼');
                }
            } else {
                // æ–°å¢é …ç›®
                // ç°¡æ˜“ ID ç”Ÿæˆï¼Œå–ç•¶å‰æœ€å¤§ ID + 1
                const maxId = checklist[category].reduce((max, item) => Math.max(max, item.id), category === 'luggage' ? 0 : 100);
                newItem.id = maxId + 1;
                checklist[category].push(newItem);
                alertModal('æ–°é …ç›®å·²åŠ å…¥ï¼');
            }

            setLocalStorage(checklistKey, checklist);
            document.getElementById('list-modal').classList.add('hidden');
            renderChecklist(category); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        }

        // åˆªé™¤æ¸…å–®é …ç›® (æ–°å¢)
        function deleteListItem(category, itemId) {
            if (!confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤æ¸…å–®é …ç›®å—ï¼Ÿ')) return;
            
            let checklist = getLocalStorage(checklistKey, initialChecklist);
            
            checklist[category] = checklist[category].filter(item => item.id !== itemId);
            
            setLocalStorage(checklistKey, checklist);
            alertModal('é …ç›®å·²åˆªé™¤ã€‚');
            renderChecklist(category);
        }

        // æ¸²æŸ“å‚™å¿˜éŒ„è¼¸å‡º (è‡ªå‹•è½‰æ›é€£çµ) (ä¸è®Š)
        function renderMemoOutput(memoText, outputId, linkPrefix = '<i class="fas fa-link mr-2"></i>') {
            const outputDiv = document.getElementById(outputId);
            if (!outputDiv) return;

            // åŒ¹é… URLï¼ŒåŒæ™‚åŒ¹é…é›»è©±è™Ÿç¢¼ (tel:xxx)
            const urlRegex = /(https?:\/\/[^\s]+|tel:\+?\d[\d\s-]*)/g;
            const lines = memoText.split('\n');
            
            let outputHtml = '<h4 class="font-medium mb-2" style="color: var(--color-text-main);">é€£çµ/é›»è©±é è¦½ (è‡ªå‹•è½‰æ›)</h4><div class="space-y-2">';
            let hasMatch = false;

            lines.forEach(line => {
                const matches = line.match(urlRegex);
                if (matches) {
                    matches.forEach(url => {
                        hasMatch = true;
                        
                        // å˜—è©¦å¾è¡Œé¦–æå–é€£çµåç¨±ï¼Œå¦‚æœè¡Œå°¾æ˜¯é€£çµï¼Œå‰‡å–é€£çµå‰çš„æ–‡å­—
                        let linkName = line.replace(url, '').trim();
                        let icon = linkPrefix;
                        let displayUrl = url;

                        if (url.startsWith('tel:')) {
                            icon = '<i class="fas fa-phone mr-2"></i>';
                            // ç§»é™¤ tel: å‰ç¶´ä½œç‚ºé¡¯ç¤ºåç¨±
                            linkName = linkName || url.substring(4);
                        } else {
                            // å¦‚æœæ²’æœ‰å…¶ä»–æ–‡å­—ï¼Œå‰‡ç›´æ¥ä½¿ç”¨é€£çµçš„ç°¡åŒ–å½¢å¼
                            if (linkName === '') {
                                try {
                                    const urlObj = new URL(url);
                                    linkName = urlObj.hostname + urlObj.pathname.substring(0, 15) + '...';
                                } catch (e) {
                                    linkName = url;
                                }
                            }
                        }

                        outputHtml += `
                            <a href="${url}" target="${url.startsWith('tel:') ? '_self' : '_blank'}" class="muji-btn-light w-full text-left flex items-center justify-between text-sm" style="border-color: var(--color-divider); background-color: white;">
                                <span>${icon} ${linkName}</span>
                                <i class="fas ${url.startsWith('tel:') ? 'fa-mobile-alt' : 'fa-external-link-alt'} text-xs"></i>
                            </a>
                        `;
                    });
                }
            });

            if (!hasMatch) {
                outputHtml += '<p class="text-sm text-gray-400">æ²’æœ‰åµæ¸¬åˆ°å¯è½‰æ›çš„ç¶²å€æˆ–é›»è©±é€£çµã€‚</p>';
            }

            outputHtml += '</div>';
            outputDiv.innerHTML = outputHtml;
        }

        // è¨­ç½® Lists Tab çš„äº‹ä»¶ç›£è½å™¨ (å·²é‡æ§‹)
        function setupListsListeners() {
            // 1. CheckList æ¸²æŸ“
            renderChecklist('luggage');
            renderChecklist('todo');

            // 2. Memo è¼‰å…¥èˆ‡äº‹ä»¶
            const memoText = getLocalStorage(memoKey, "æ­¡è¿ä½¿ç”¨å‚™å¿˜éŒ„ï¼å¯ä»¥åœ¨é€™è£¡è¨˜éŒ„ç¶²å€ï¼Œæœƒè‡ªå‹•è½‰æ›æˆé€£çµæŒ‰éˆ•ã€‚\n\nä¾‹å¦‚ï¼š\nNaver åœ°åœ–: https://map.naver.com/");
            renderMemoOutput(memoText, 'memo-output');

            document.getElementById('save-memo-btn').addEventListener('click', () => {
                const input = document.getElementById('memo-input');
                const newMemoText = input.value;
                setLocalStorage(memoKey, newMemoText);
                renderMemoOutput(newMemoText, 'memo-output');
                alertModal("å‚™å¿˜éŒ„å·²å„²å­˜ã€‚");
            });

            // 3. æ¸…å–®ç·¨è¼¯ Modal ç›£è½å™¨
            const listModal = document.getElementById('list-modal');
            if (listModal) {
                // ç¶å®šå„²å­˜æŒ‰éˆ•
                document.getElementById('list-form').addEventListener('submit', handleListItemSave);
                // ç¶å®šå–æ¶ˆæŒ‰éˆ•
                document.getElementById('list-modal-cancel-btn').addEventListener('click', () => {
                    listModal.classList.add('hidden');
                });
            }
        }


        // --- Tab: INFO (è³‡è¨Š) æ¸²æŸ“ (æ–°å¢å€‹äººç·Šæ€¥å‚™è¨»æ¬„) ---
        function renderInfoTab(container) {
             const infoMemoText = getLocalStorage(memoInfoKey, "ä¾‹å¦‚ï¼š\n1. æ—…éŠä¿éšªå–®è™Ÿï¼šPL-1234567\n2. ä¿¡ç”¨å¡å®¢æœé›»è©±ï¼š+886-2-2500-XXXX\n3. å‚™ç”¨è¯çµ¡äººï¼šå°æ˜ï¼Œæ‰‹æ©Ÿï¼štel:+886-912-345-678");

             const localLinks = getLocalStorage(localInfoLinksKey, [
                { text: "ç•¶åœ°å¤©æ°£ï¼ˆå¯è‡ªè¡Œæ›´æ”¹ï¼‰", url: "" }
             ]);


             const editLinks = (Array.isArray(localLinks) && localLinks.length) ? localLinks : [{ text: "", url: "" }];

            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">ğŸ’¡ æ—…éŠå¯¦ç”¨è³‡è¨Š</h2>

                <div class="muji-card p-4 mb-6">
                    <div class="flex items-center justify-between gap-2 border-b pb-2" style="border-color: var(--color-divider);">
                        <h3 class="text-lg font-semibold" style="color: var(--color-text-main);">ç•¶åœ°è³‡è¨Šé€£çµ</h3>
                        <div class="flex items-center gap-2">
                            <button id="edit-local-links-btn" type="button" class="muji-btn-light text-xs px-2 py-1 hover:shadow-md">
                                <i class="fas fa-edit mr-1"></i>ç·¨è¼¯
                            </button>
                            <button id="hide-local-links-editor-btn" type="button" class="muji-btn-light text-xs px-2 py-1 hover:shadow-md hidden">
                                <i class="fas fa-chevron-up mr-1"></i>æ”¶èµ·
                            </button>
                        </div>
                    </div>

                    <div id="local-links-view" class="space-y-2 mt-3">
                        ${(Array.isArray(localLinks) && localLinks.length ? localLinks : []).filter(x => (x && (String(x.text||'').trim() || String(x.url||'').trim()))).map((x, idx) => `
                            <div class="flex items-center justify-between gap-2 p-3 rounded-lg border" style="border-color: var(--color-divider); background-color: var(--color-bg-primary);">
                                <div class="text-sm font-medium text-gray-700 flex-1 min-w-0 truncate">${String(x.text || 'æœªå‘½å')}</div>
                                ${String(x.url || '').trim()
                                    ? `<a href="${String(x.url).trim()}" target="_blank" class="muji-btn-light px-3 py-2 inline-flex items-center justify-center hover:shadow-md" style="border-color: var(--color-divider); background-color: white;" title="é–‹å•Ÿé€£çµ">
                                            <i class="fas fa-arrow-up-right-from-square"></i>
                                       </a>`
                                    : `<span class="text-xs text-gray-400">ï¼ˆæœªå¡«ç¶²ç«™ï¼‰</span>`
                                }
                            </div>
                        `).join('') || `<p class="text-sm text-gray-400">å°šæœªè¨­å®šä»»ä½•é€£çµã€‚</p>`}
                    </div>

                    <div id="local-links-editor" class="mt-3 hidden">
    <p class="text-xs text-gray-500 mb-2">ä¸é™ç­†æ•¸ï¼Œå¯è‡ªè¡Œæ–°å¢/åˆªé™¤ï¼›ã€Œç¶²ç«™ã€æœ‰å¡«æ™‚ï¼Œé¡¯ç¤ºåªæœƒä»¥å°åœ–ç¤ºå‘ˆç¾ã€‚</p>

    <div id="local-links-rows" class="space-y-2">
        ${editLinks.map((row) => `
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-2" data-local-link-row>
                <input type="text" class="w-full p-2 border rounded-lg text-sm" data-role="text"
                       placeholder="æ–‡å­— (ä¾‹å¦‚ï¼šå¤©æ°£ / åœ°éµåœ– / Grab)" style="border-color: var(--color-divider);"
                       value="${String(row.text || '').replace(/"/g,'&quot;')}">
                <div class="flex gap-2">
                    <input type="url" class="flex-1 p-2 border rounded-lg text-sm" data-role="url"
                           placeholder="ç¶²ç«™ (https://...)" style="border-color: var(--color-divider);"
                           value="${String(row.url || '').replace(/"/g,'&quot;')}">
                    <button type="button" data-action="delete-local-link"
                            class="muji-btn-light px-3 py-2 inline-flex items-center justify-center hover:shadow-md"
                            style="border-color: #fca5a5; background-color: white; color: #dc2626;" title="åˆªé™¤">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
        `).join('')}
    </div>

    <button id="add-local-link-btn" type="button" class="muji-btn-light text-xs px-3 py-2 mt-2 inline-flex items-center hover:shadow-md"
            style="border-color: var(--color-divider); background-color: white;">
        <i class="fas fa-plus mr-1"></i>æ–°å¢ä¸€ç­†
    </button>

    <div class="flex gap-2 mt-3">
        <button id="save-local-links-btn" type="button" class="muji-btn text-xs px-3 py-2">
            <i class="fas fa-save mr-1"></i>å„²å­˜
        </button>
        <button id="cancel-local-links-btn" type="button" class="muji-btn-light text-xs px-3 py-2" style="border-color: var(--color-divider);">
            å–æ¶ˆ
        </button>
    </div>
</div>

                    <h3 class="text-lg font-semibold mt-6 mb-3 border-b pb-2" style="color: var(--color-text-main); border-color: var(--color-divider);">ç·Šæ€¥è¯çµ¡è³‡è¨Š</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 rounded-lg border" style="border-color: var(--color-divider); background-color: var(--color-bg-primary);">
                            <p class="font-semibold mb-3" style="color: var(--color-text-main);">1. è¶Šå—ç·Šæ€¥é›»è©±ï¼ˆå…¨åœ‹é€šç”¨ï¼‰</p>

                            <div class="space-y-2 text-sm">
                                <div class="flex items-center justify-between gap-2">
                                    <div class="flex-1">ğŸš‘ æ•‘è­·è»Š / é†«ç™‚æ€¥æ•‘ï¼š<span class="font-bold">115</span></div>
                                    <button type="button" onclick="copyTextToClipboard('115','å·²è¤‡è£½ï¼')" class="muji-btn-light text-xs px-2 py-1 inline-flex items-center hover:shadow-md" style="border-color: var(--color-divider); background-color: white;"><i class="fas fa-copy"></i></button>
                                </div>
                                <div class="flex items-center justify-between gap-2">
                                    <div class="flex-1">ğŸ‘® è­¦å¯Ÿï¼š<span class="font-bold">113</span></div>
                                    <button type="button" onclick="copyTextToClipboard('113','å·²è¤‡è£½ï¼')" class="muji-btn-light text-xs px-2 py-1 inline-flex items-center hover:shadow-md" style="border-color: var(--color-divider); background-color: white;"><i class="fas fa-copy"></i></button>
                                </div>
                                <div class="flex items-center justify-between gap-2">
                                    <div class="flex-1">ğŸš’ æ¶ˆé˜² / æ•‘æ´ï¼š<span class="font-bold">114</span></div>
                                    <button type="button" onclick="copyTextToClipboard('114','å·²è¤‡è£½ï¼')" class="muji-btn-light text-xs px-2 py-1 inline-flex items-center hover:shadow-md" style="border-color: var(--color-divider); background-color: white;"><i class="fas fa-copy"></i></button>
                                </div>
                                <div class="flex items-center justify-between gap-2">
                                    <div class="flex-1">ğŸ†˜ æœæ•‘ï¼ˆå¤©ç½/äº‹æ•…æœæ•‘ï¼‰ï¼š<span class="font-bold">112</span></div>
                                    <button type="button" onclick="copyTextToClipboard('112','å·²è¤‡è£½ï¼')" class="muji-btn-light text-xs px-2 py-1 inline-flex items-center hover:shadow-md" style="border-color: var(--color-divider); background-color: white;"><i class="fas fa-copy"></i></button>
                                </div>
                            </div>

                            <div class="mt-3 text-sm text-gray-700">
                                <div class="flex items-center justify-between gap-2">
                                <div class="flex-1">æ—…éŠè³‡è¨Š/æ”¯æ´ï¼š<span class="font-bold">1022 è½‰ 8</span></div>
                                <button type="button" onclick="copyTextToClipboard('1022 è½‰ 8','å·²è¤‡è£½ï¼')" class="muji-btn-light text-xs px-2 py-1 inline-flex items-center hover:shadow-md" style="border-color: var(--color-divider); background-color: white;"><i class="fas fa-copy"></i></button>
                            </div>
                            </div>

                            <div class="mt-3 p-3 rounded-lg border text-xs text-gray-700" style="border-color: var(--color-divider); background-color: white;">
                                å°æé†’ï¼šè¶Šå—çš„ç·Šæ€¥é›»è©±å¤šä»¥è¶Šå—èªæ‡‰å°è¼ƒå¸¸è¦‹ï¼Œå ±æ¡ˆæ™‚ç›¡é‡è¬›æ¸…æ¥šã€Œä½ åœ¨å“ªè£¡ï¼ˆåœ°æ¨™/é£¯åº—å/è¡—é“é–€ç‰Œï¼‰ã€èˆ‡ã€Œç™¼ç”Ÿä»€éº¼äº‹ã€ã€‚
                            </div>
                        </div>

                        <div class="p-4 rounded-lg border" style="border-color: var(--color-divider); background-color: var(--color-bg-primary);">
                            <p class="font-semibold mb-3" style="color: var(--color-text-main);">2. å°ç£åœ¨èƒ¡å¿—æ˜å¸‚çš„é§è™•ï¼ˆTECOï¼‰</p>

                            <div class="space-y-2 text-sm">
                                <div class="flex items-center justify-between gap-2">
                                    <div class="flex-1">åç¨±ï¼š<span class="font-medium">Taipei Economic and Cultural Office in Ho Chi Minh Cityï¼ˆé§èƒ¡å¿—æ˜å¸‚å°åŒ—ç¶“æ¿Ÿæ–‡åŒ–è¾¦äº‹è™• TECOï¼‰</span></div>
                                    <button type="button" onclick="copyTextToClipboard('Taipei Economic and Cultural Office in Ho Chi Minh Cityï¼ˆé§èƒ¡å¿—æ˜å¸‚å°åŒ—ç¶“æ¿Ÿæ–‡åŒ–è¾¦äº‹è™• TECOï¼‰','å·²è¤‡è£½ï¼')" class="muji-btn-light text-xs px-2 py-1 inline-flex items-center hover:shadow-md" style="border-color: var(--color-divider); background-color: white;"><i class="fas fa-copy"></i></button>
                                </div>

                                <div class="flex items-center justify-between gap-2">
                                    <div class="flex-1">åœ°å€ï¼š<span class="font-medium">336 Nguyá»…n Tri PhÆ°Æ¡ng, PhÆ°á»ng VÆ°á»n LÃ i, TP. Há»“ ChÃ­ Minh, Viá»‡t Namï¼ˆå¸¸è¦‹å¯«æ³•ï¼šDistrict 10, HCMCï¼‰</span></div>
                                    <button type="button" onclick="copyTextToClipboard('336 Nguyá»…n Tri PhÆ°Æ¡ng, PhÆ°á»ng VÆ°á»n LÃ i, TP. Há»“ ChÃ­ Minh, Viá»‡t Namï¼ˆå¸¸è¦‹å¯«æ³•ï¼šDistrict 10, HCMCï¼‰','å·²è¤‡è£½ï¼')" class="muji-btn-light text-xs px-2 py-1 inline-flex items-center hover:shadow-md" style="border-color: var(--color-divider); background-color: white;"><i class="fas fa-copy"></i></button>
                                </div>

                                <div class="mt-2 pt-2 border-t border-dashed" style="border-color: var(--color-divider);">
                                    <p class="font-semibold" style="color: var(--color-text-main);">é›»è©±ï¼ˆä¸Šç­æ™‚é–“ï¼‰ï¼š</p>
                                    <div class="flex items-center justify-between gap-2 mt-2">
                                        <div class="flex-1">è¶Šå—å¢ƒå…§ï¼š<span class="font-bold">(028) 3834-9160ï½65</span></div>
                                        <button type="button" onclick="copyTextToClipboard('(028) 3834-9160ï½65','å·²è¤‡è£½ï¼')" class="muji-btn-light text-xs px-2 py-1 inline-flex items-center hover:shadow-md" style="border-color: var(--color-divider); background-color: white;"><i class="fas fa-copy"></i></button>
                                    </div>
                                    <div class="flex items-center justify-between gap-2 mt-2">
                                        <div class="flex-1">è¶Šå—å¢ƒå¤–ï¼š<span class="font-bold">+84-28-3834-9160ï½65</span></div>
                                        <button type="button" onclick="copyTextToClipboard('+84-28-3834-9160ï½65','å·²è¤‡è£½ï¼')" class="muji-btn-light text-xs px-2 py-1 inline-flex items-center hover:shadow-md" style="border-color: var(--color-divider); background-color: white;"><i class="fas fa-copy"></i></button>
                                    </div>
                                </div>

                                <div class="mt-2 pt-2 border-t border-dashed" style="border-color: var(--color-divider);">
                                    <p class="font-semibold" style="color: var(--color-text-main);">ç·Šæ€¥è¯çµ¡æ‰‹æ©Ÿï¼ˆæ€¥é›£æ•‘åŠ©ç”¨ï¼‰ï¼š</p>
                                    <div class="flex items-center justify-between gap-2 mt-2">
                                        <div class="flex-1">è¶Šå—å¢ƒå…§ç›´æ’¥ï¼š<span class="font-bold">0903-927-019</span></div>
                                        <button type="button" onclick="copyTextToClipboard('0903-927-019','å·²è¤‡è£½ï¼')" class="muji-btn-light text-xs px-2 py-1 inline-flex items-center hover:shadow-md" style="border-color: var(--color-divider); background-color: white;"><i class="fas fa-copy"></i></button>
                                    </div>
                                    <div class="flex items-center justify-between gap-2 mt-2">
                                        <div class="flex-1">è¶Šå—å¢ƒå¤–æ’¥æ‰“ï¼š<span class="font-bold">+84-903-927-019</span></div>
                                        <button type="button" onclick="copyTextToClipboard('+84-903-927-019','å·²è¤‡è£½ï¼')" class="muji-btn-light text-xs px-2 py-1 inline-flex items-center hover:shadow-md" style="border-color: var(--color-divider); background-color: white;"><i class="fas fa-copy"></i></button>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between gap-2 mt-2 pt-2 border-t border-dashed" style="border-color: var(--color-divider);">
                                    <div class="flex-1">Emailï¼š<span class="font-bold">tecohcmc@mofa.gov.tw</span></div>
                                    <button type="button" onclick="copyTextToClipboard('tecohcmc@mofa.gov.tw','å·²è¤‡è£½ï¼')" class="muji-btn-light text-xs px-2 py-1 inline-flex items-center hover:shadow-md" style="border-color: var(--color-divider); background-color: white;"><i class="fas fa-copy"></i></button>
                                </div>

                                <div class="mt-2 text-sm text-gray-700">
                                    æœå‹™æ™‚é–“ï¼šé€±ä¸€ï½é€±äº” 08:00â€“11:30ã€13:30â€“16:00ï¼ˆé€±æœ«èˆ‡è¶Šå—åœ‹å®šå‡æ—¥ä¼‘ï¼‰
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="muji-card p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2" style="color: var(--color-text-main); border-color: var(--color-divider);"> å‚™è¨»æ¬„</h3>
                    <textarea id="memo-info-input" class="w-full p-3 h-40 border rounded-lg focus:ring-1 focus:ring-red-300 text-sm" placeholder="è¼¸å…¥æ‚¨çš„å‚™è¨»å…§å®¹" style="border-color: var(--color-divider); color: var(--color-text-main);">${infoMemoText}</textarea>
                    <button id="save-memo-info-btn" class="muji-btn w-full mt-3">å„²å­˜å‚™è¨»</button>
                    <div class="mt-4 p-3 rounded-lg" id="memo-info-output" style="background-color: var(--color-bg-primary);">
                        </div>
                </div>
            `;
            container.innerHTML = html;
            setupInfoListeners();
        }

        // NEW: è¨­ç½® Info Tab çš„äº‹ä»¶ç›£è½å™¨
        function setupInfoListeners() {  
            const infoMemoText = getLocalStorage(memoInfoKey, "");
            renderMemoOutput(infoMemoText, 'memo-info-output', '<i class="fas fa-shield-halved mr-2"></i>');

            const saveMemoBtn = document.getElementById('save-memo-info-btn');
            if (saveMemoBtn) {
                saveMemoBtn.addEventListener('click', () => {
                    const input = document.getElementById('memo-info-input');
                    const newMemoText = input.value;
                    setLocalStorage(memoInfoKey, newMemoText);
                    renderMemoOutput(newMemoText, 'memo-info-output', '<i class="fas fa-shield-halved mr-2"></i>');
                    alertModal("å‚™è¨»å·²å„²å­˜ã€‚");
                });
            }

            // ç•¶åœ°è³‡è¨Šé€£çµï¼šç·¨è¼¯/æ”¶èµ·/å„²å­˜/å–æ¶ˆï¼ˆä¸é™ç­†æ•¸ï¼Œå¯æ–°å¢/åˆªé™¤ï¼‰
            const view = document.getElementById('local-links-view');
            const editor = document.getElementById('local-links-editor');
            const editBtn = document.getElementById('edit-local-links-btn');
            const hideBtn = document.getElementById('hide-local-links-editor-btn');
            const saveBtn = document.getElementById('save-local-links-btn');
            const cancelBtn = document.getElementById('cancel-local-links-btn');
            const addBtn = document.getElementById('add-local-link-btn');
            const rowsWrap = document.getElementById('local-links-rows');

            if (view && editor && editBtn && hideBtn && saveBtn && cancelBtn && addBtn && rowsWrap) {
                const openEditor = () => {
                    editor.classList.remove('hidden');
                    hideBtn.classList.remove('hidden');
                    editBtn.classList.add('hidden');
                };
                const closeEditor = () => {
                    editor.classList.add('hidden');
                    hideBtn.classList.add('hidden');
                    editBtn.classList.remove('hidden');
                };

                const escapeAttr = (str) => String(str ?? '')
                    .replace(/&/g, '&amp;')
                    .replace(/"/g, '&quot;')
                    .replace(/</g, '&lt;');

                const makeRowHTML = (t = '', u = '') => `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-2" data-local-link-row>
                        <input type="text" class="w-full p-2 border rounded-lg text-sm" data-role="text"
                               placeholder="æ–‡å­— (ä¾‹å¦‚ï¼šå¤©æ°£ / åœ°éµåœ– / Grab)" style="border-color: var(--color-divider);"
                               value="${escapeAttr(t)}">
                        <div class="flex gap-2">
                            <input type="url" class="flex-1 p-2 border rounded-lg text-sm" data-role="url"
                                   placeholder="ç¶²ç«™ (https://...)" style="border-color: var(--color-divider);"
                                   value="${escapeAttr(u)}">
                            <button type="button" data-action="delete-local-link"
                                    class="muji-btn-light px-3 py-2 inline-flex items-center justify-center hover:shadow-md"
                                    style="border-color: #fca5a5; background-color: white; color: #dc2626;" title="åˆªé™¤">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `;

                // ç¢ºä¿è‡³å°‘æœ‰ä¸€åˆ—
                if (rowsWrap.querySelectorAll('[data-local-link-row]').length === 0) {
                    rowsWrap.insertAdjacentHTML('beforeend', makeRowHTML());
                }

                editBtn.onclick = openEditor;
                hideBtn.onclick = closeEditor;

                addBtn.onclick = () => {
                    rowsWrap.insertAdjacentHTML('beforeend', makeRowHTML());
                };

                // åˆªé™¤æŒ‡å®šåˆ—ï¼ˆè‡³å°‘ä¿ç•™ä¸€åˆ—ï¼‰
                rowsWrap.addEventListener('click', (e) => {
                    const delBtn = e.target.closest('[data-action="delete-local-link"]');
                    if (!delBtn) return;
                    const row = delBtn.closest('[data-local-link-row]');
                    if (!row) return;

                    const count = rowsWrap.querySelectorAll('[data-local-link-row]').length;
                    if (count <= 1) {
                        row.querySelector('[data-role="text"]').value = '';
                        row.querySelector('[data-role="url"]').value = '';
                    } else {
                        row.remove();
                    }
                });

                cancelBtn.onclick = () => {
                    // é‡æ–°æ¸²æŸ“å›åŸç‹€
                    renderInfoTab(document.getElementById('app-content'));
                };

                saveBtn.onclick = () => {
                    const rows = Array.from(rowsWrap.querySelectorAll('[data-local-link-row]')).map(row => {
                        const t = (row.querySelector('[data-role="text"]')?.value || '').trim();
                        const u = (row.querySelector('[data-role="url"]')?.value || '').trim();
                        return { text: t, url: u };
                    }).filter(x => x.text || x.url);

                    setLocalStorage(localInfoLinksKey, rows);
                    alertModal('ç•¶åœ°è³‡è¨Šé€£çµå·²æ›´æ–°ï¼');
                    renderInfoTab(document.getElementById('app-content'));
                };
            }


        }


        // --- Custom Alert Modal (å–ä»£ alert()) ---
        function alertModal(message) {
            let modal = document.getElementById('custom-alert-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'custom-alert-modal';
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30 p-4 hidden';
                modal.innerHTML = `
                    <div class="muji-card p-6 w-full max-w-xs text-center" style="border-color: var(--color-divider);">
                        <p class="text-lg font-medium mb-4" id="alert-message" style="color: var(--color-text-main);"></p>
                        <button id="alert-close-btn" class="muji-btn w-full">ç¢ºèª</button>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('alert-close-btn').onclick = () => {
                    modal.classList.add('hidden');
                };
            }
            document.getElementById('alert-message').textContent = message;
            modal.classList.remove('hidden');
        }

        // --- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š ---
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData(); // åŠ è¼‰åŒ¯ç‡å’Œè¡Œç¨‹è³‡æ–™
            loadTitle(); // NEW: åŠ è¼‰ä¸¦é¡¯ç¤ºæ¨™é¡Œ
            
            // åˆå§‹è¼‰å…¥ FLIGHTS_STAY tab (æ–°çš„é¦–é )
            changeTab('FLIGHTS_STAY');

            // ç¶å®šåº•éƒ¨å°èˆªåˆ—äº‹ä»¶
            document.querySelectorAll('.nav-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tab = e.currentTarget.dataset.tab;
                    changeTab(tab);
                });
            });
            
            // NEW: æ¨™é¡Œç·¨è¼¯äº‹ä»¶ç¶å®š
            document.getElementById('edit-title-btn').addEventListener('click', () => {
                toggleTitleEdit(true);
            });
            
            document.getElementById('save-title-btn').addEventListener('click', saveTitle);
            
            document.getElementById('cancel-edit-btn').addEventListener('click', () => {
                // é‡ç½®è¼¸å…¥æ¡†å…§å®¹
                loadTitle();
                toggleTitleEdit(false);
            });
            
            // åˆå§‹åŒ– LocalStorage é è¨­å€¼ (å¦‚æœæ²’æœ‰çš„è©±)
            if (!localStorage.getItem(checklistKey)) {
                setLocalStorage(checklistKey, initialChecklist);
            }

            // Itinerary Modal Listeners
            const itineraryModal = document.getElementById('itinerary-modal');
            if (itineraryModal) {
                // ç¶å®šå„²å­˜æŒ‰éˆ•
                document.getElementById('itinerary-form').addEventListener('submit', handleItineraryItemSave);
                // ç¶å®šå–æ¶ˆæŒ‰éˆ•
                document.getElementById('modal-cancel-btn').addEventListener('click', () => {
                    itineraryModal.classList.add('hidden');
                });
            }
        });
</script>

  </div>
</body>
</html>