<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ“åœ‹ä¹‹æ—…ï¼šè¦ªå‹æ—…éŠå°å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* è¨­ç½®å…¨åŸŸå­—é«”ç‚º Noto Sans TC */
        /* === æ›´æ–°ç‚ºæ–°çš„é¡è‰²é…ç½® === */
        :root {
            --color-bg-primary: #faf8f5; /* ä¿æŒæ¥µæ·ºåº•è‰² */
            --color-bg-card: #ffffff; /* ç´”ç™½ */
            --color-text-main: #514378; /* æ·±ç´« (Primary Text/Dark Contrast) */
            --color-accent: #EBC79A; /* æš–é‡‘è‰² (Main Accent/Headers) */
            --color-divider: #eac9b8; /* æŸ”å’Œç²‰è‰² (Soft Divider/Border) */
            --color-highlight: #F8D77A; /* ç¶“å…¸æš–é»ƒ (Highlight/Important Time) */
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--color-bg-primary);
            color: var(--color-text-main);
            padding-bottom: 4rem; /* åº•éƒ¨ç©ºé–“ç•™çµ¦å°èˆªåˆ— */
            line-height: 1.6;
        }

        /* å°èˆªåˆ—æ¨£å¼ */
        .nav-item {
            color: var(--color-text-main);
            transition: color 0.2s, background-color 0.2s;
        }
        .nav-item.active {
            color: var(--color-text-main); /* å°èˆªé¸ä¸­æ™‚ä½¿ç”¨æ·±ç´« */
            background-color: var(--color-highlight);
            border-radius: 8px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .muji-card {
            background-color: var(--color-bg-card);
            border: 1px solid var(--color-divider);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.03);
            transition: transform 0.1s;
        }

        /* æŒ‰éˆ•é€šç”¨æ¨£å¼ */
        .muji-btn {
            background-color: var(--color-text-main); /* ä½¿ç”¨æœ€æ·±çš„é¡è‰²ä½œæŒ‰éˆ•èƒŒæ™¯ï¼Œç¢ºä¿å¯è¦–æ€§ */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .muji-btn:hover {
            background-color: #3d3151; /* Slightly darker deep purple */
        }
        .muji-btn-light {
             background-color: var(--color-bg-primary);
             color: var(--color-text-main);
             border: 1px solid var(--color-divider);
        }

        /* æ™‚é–“è»¸ç·šæ¢ */
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--color-divider);
        }
        .timeline-dot {
            position: absolute;
            left: 14px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: var(--color-text-main);
            border: 2px solid var(--color-bg-primary);
            z-index: 10;
        }
    </style>

    <!-- Supabase client (for cloud sync) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

</head>
<body class="min-h-screen">
<!-- Password Gate (æ–¹æ¡ˆBï¼šå‰ç«¯å›ºå®šå¯†ç¢¼) -->
<div id="pw-overlay" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/60 backdrop-blur-sm px-4">
  <div class="w-full max-w-sm rounded-2xl bg-white shadow-xl p-6">
    <div class="flex items-center gap-2 mb-3">
      <div class="w-9 h-9 rounded-xl bg-gray-100 flex items-center justify-center">
        <span class="text-lg">ğŸ”’</span>
      </div>
      <div>
        <div class="text-base font-semibold text-gray-900">è¼¸å…¥å¯†ç¢¼ä»¥é€²å…¥</div>
        <div class="text-xs text-gray-500">ï¼ˆæç¤ºï¼šé€™æ˜¯å‰ç«¯é–ï¼Œæ‡‚æŠ€è¡“çš„äººä»å¯å¾åŸå§‹ç¢¼æ‰¾åˆ°ï¼‰</div>
      </div>
    </div>

    <label class="block text-sm text-gray-700 mb-1">å¯†ç¢¼</label>
    <input id="pw-input" type="password" inputmode="numeric" autocomplete="current-password"
      class="w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900/20"
      placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
    <div id="pw-error" class="text-sm text-red-600 mt-2"></div>

    <div class="flex items-center justify-between mt-4">
      <label class="inline-flex items-center gap-2 text-sm text-gray-700 select-none">
        <input id="pw-remember" type="checkbox" class="rounded border-gray-300" />
        è¨˜ä½æˆ‘ï¼ˆåŒä¸€è£ç½®ï¼‰
      </label>
      <button id="pw-submit" class="rounded-xl bg-gray-900 text-white px-4 py-2 text-sm hover:bg-gray-800">
        é€²å…¥
      </button>
    </div>
  </div>
</div>

<script>
(function () {
  // ===== Password Gate Config =====
  // æ”¹æˆä½ æƒ³è¦çš„å›ºå®šå¯†ç¢¼ï¼ˆæ³¨æ„ï¼šé€™æ˜¯å‰ç«¯æª”æ¡ˆï¼Œå¯†ç¢¼ä»å¯èƒ½è¢«æ‡‚æŠ€è¡“çš„äººæ‰¾åˆ°ï¼‰
  const ACCESS_PASSWORD = "0707";
  const SESSION_KEY = "seoul_trip_unlocked_session_v1";
  const REMEMBER_KEY = "seoul_trip_unlocked_remember_v1";

  function isUnlocked() {
    return sessionStorage.getItem(SESSION_KEY) === "1" || localStorage.getItem(REMEMBER_KEY) === "1";
  }
  function unlock(remember) {
    sessionStorage.setItem(SESSION_KEY, "1");
    if (remember) localStorage.setItem(REMEMBER_KEY, "1");
    else localStorage.removeItem(REMEMBER_KEY);

    const overlay = document.getElementById("pw-overlay");
    const root = document.getElementById("app-root");
    if (overlay) overlay.style.display = "none";
    if (root) root.style.display = "";

    try { if (typeof window.__onAppUnlocked === "function") window.__onAppUnlocked(); } catch (e) {}
  }

  window.__isAppUnlocked = isUnlocked;

  document.addEventListener("DOMContentLoaded", function () {
    const overlay = document.getElementById("pw-overlay");
    const root = document.getElementById("app-root");

    if (isUnlocked()) {
      if (overlay) overlay.style.display = "none";
      if (root) root.style.display = "";
      try { if (typeof window.__onAppUnlocked === "function") window.__onAppUnlocked(); } catch (e) {}
      return;
    }

    if (overlay) {
      overlay.style.display = "flex";
    }
    if (root) {
      root.style.display = "none";
    }

    const input = document.getElementById("pw-input");
    const btn = document.getElementById("pw-submit");
    const remember = document.getElementById("pw-remember");
    const error = document.getElementById("pw-error");

    function attempt() {
      const v = (input && input.value ? input.value : "").trim();
      if (v === ACCESS_PASSWORD) {
        if (error) error.textContent = "";
        unlock(remember && remember.checked);
      } else {
        if (error) error.textContent = "å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡";
        if (input) { input.value = ""; input.focus(); }
      }
    }

    if (btn) btn.addEventListener("click", attempt);
    if (input) input.addEventListener("keydown", function (e) {
      if (e.key === "Enter") attempt();
    });
  });
})();
</script>

  <div id="app-root" style="display:none;">


    <header class="sticky top-0 z-20 bg-white shadow-md p-4 flex justify-between items-center border-b" style="border-color: var(--color-divider);">
        <h1 class="text-xl font-bold flex items-center space-x-2" style="color: var(--color-text-main);">
            <span id="title-display-area" class="flex items-center">
                <span id="app-title-display"></span>
                <button id="edit-title-btn" class="ml-2 text-base text-gray-500 hover:text-gray-700 p-1 rounded transition" title="ä¿®æ”¹æ¨™é¡Œ">
                    <i class="fas fa-edit text-sm"></i>
                </button>
            </span>
            
            <span id="title-edit-area" class="hidden flex items-center space-x-2">
                <input type="text" id="title-input" class="p-1 border rounded-lg text-base w-40" style="border-color: var(--color-divider);">
                <button id="save-title-btn" class="muji-btn text-xs px-2 py-1">å„²å­˜</button>
                <button id="cancel-edit-btn" class="muji-btn-light text-xs px-2 py-1" style="border-color: var(--color-divider);"><i class="fas fa-times"></i></button>
            </span>
        </h1>

        <div id="rate-badge" class="text-sm font-medium px-3 py-1 rounded-full" style="background-color: var(--color-bg-primary); color: var(--color-text-main);">
            KRW/TWD: -
        </div>
    </header>

    <main id="app-content" class="p-4 pt-6 max-w-xl mx-auto">
        </main>

    <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-30">
        <nav class="flex justify-around items-center h-16 max-w-xl mx-auto">
            <button class="nav-item flex flex-col items-center p-2 active" data-tab="FLIGHTS_STAY">
                <i class="fas fa-plane-departure text-xl"></i>
                <span class="text-xs mt-1">èˆªç­ä½å®¿</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-tab="ITINERARY">
                <i class="fas fa-calendar-alt text-xl"></i>
                <span class="text-xs mt-1">è¡Œç¨‹è¡¨</span>
            </button>
<button class="nav-item flex flex-col items-center p-2" data-tab="WALLET">
                <i class="fas fa-calculator text-xl"></i>
                <span class="text-xs mt-1">è¨˜å¸³</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-tab="LISTS">
                <i class="fas fa-list-check text-xl"></i>
                <span class="text-xs mt-1">æ¸…å–®</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-tab="INFO">
                <i class="fas fa-info-circle text-xl"></i>
                <span class="text-xs mt-1">è³‡è¨Š</span>
            </button>
        </nav>
    </footer>

    <div id="itinerary-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30 p-4 hidden">
        <div class="muji-card p-6 w-full max-w-lg" style="border-color: var(--color-divider);">
            <h3 class="text-xl font-bold mb-4" id="modal-title" style="color: var(--color-text-main);">æ–°å¢è¡Œç¨‹é …ç›®</h3>
            <form id="itinerary-form" class="space-y-3">
                <input type="hidden" id="modal-day-index">
                <input type="hidden" id="modal-item-index">

                <div>
                    <label for="modal-name" class="block text-sm font-medium" style="color: var(--color-text-main);">é …ç›®åç¨±</label>
                    <input type="text" id="modal-name" required class="w-full p-2 border rounded-lg" placeholder="e.g. åŒ—æ‘å¤§ç“¦æˆ¿é†¬èŸ¹" style="border-color: var(--color-divider);">
                </div>
                
                <div class="flex space-x-3">
                    <div class="flex-1">
                        <label for="modal-time" class="block text-sm font-medium" style="color: var(--color-text-main);">æ™‚é–“</label>
                        <input type="text" id="modal-time" required class="w-full p-2 border rounded-lg" placeholder="e.g. åˆé¤, 10:00" style="border-color: var(--color-divider);">
                    </div>
                    <div class="flex-1">
                        <label for="modal-type" class="block text-sm font-medium" style="color: var(--color-text-main);">é¡å‹</label>
                        <select id="modal-type" required class="w-full p-2 border rounded-lg" style="border-color: var(--color-divider);">
                            <option value="Activity">æ´»å‹• (Activity)</option>
                            <option value="Food">é¤é£² (Food)</option>
                            <option value="Sightseeing">è§€å…‰ (Sightseeing)</option>
                            <option value="Travel">äº¤é€š (Travel)</option>
                            <option value="Shopping">è³¼ç‰© (Shopping)</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="modal-notes" class="block text-sm font-medium" style="color: var(--color-text-main);">å‚™è¨»</label>
                    <input type="text" id="modal-notes" class="w-full p-2 border rounded-lg" placeholder="é¡å¤–èªªæ˜, e.g. ç±³å…¶æ—ä¸€æ˜Ÿ" style="border-color: var(--color-divider);">
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <label for="modal-hours" class="block text-sm font-medium" style="color: var(--color-text-main);">ç‡Ÿæ¥­æ™‚é–“ (hours)</label>
                        <input type="text" id="modal-hours" class="w-full p-2 border rounded-lg" placeholder="e.g. 11:00â€“21:00" style="border-color: var(--color-divider);">
                    </div>
                    <div class="flex-1">
                        <label for="modal-address" class="block text-sm font-medium mb-1" style="color: var(--color-text-main);">åœ°å€ (address_copy)</label>
                        <input type="text" id="modal-address" class="w-full p-2 border rounded-lg text-sm" placeholder="éŸ“æ–‡æˆ–ä¸­æ–‡åœ°å€" style="border-color: var(--color-divider);">
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <label for="modal-gmap" class="block text-sm font-medium mb-1" style="color: var(--color-text-main);">Google Map Link (link)</label>
                        <input type="url" id="modal-gmap" class="w-full p-2 border rounded-lg text-xs" placeholder="https://maps.app.goo.gl/..." style="border-color: var(--color-divider);">
                    </div>
                    <div class="flex-1">
                        <label for="modal-naver" class="block text-sm font-medium mb-1" style="color: var(--color-text-main);">Naver Map Link (naver_link)</label>
                        <input type="url" id="modal-naver" class="w-full p-2 border rounded-lg text-xs" placeholder="https://naver.me/..." style="border-color: var(--color-divider);">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--color-text-main);">èƒŒæ™¯è‰²é¸æ“‡ (bgColor)</label>
                    <div id="modal-color-picker" class="flex flex-wrap gap-4">
                        <label class="flex items-center space-x-1 cursor-pointer">
                            <input type="radio" name="modal-bgColor" value="" class="h-4 w-4 text-gray-400 border-gray-300">
                            <span class="text-sm">é è¨­ (ç™½)</span>
                        </label>
                        <label class="flex items-center space-x-1 cursor-pointer">
                            <input type="radio" name="modal-bgColor" value="#FFF9E6" class="h-4 w-4 text-gray-400 border-gray-300">
                            <span class="w-6 h-6 rounded-full border shadow" style="background-color: #FFF9E6;" title="#FFF9E6"></span>
                        </label>
                        <label class="flex items-center space-x-1 cursor-pointer">
                            <input type="radio" name="modal-bgColor" value="#f5e0ce" class="h-4 w-4 text-gray-400 border-gray-300">
                            <span class="w-6 h-6 rounded-full border shadow" style="background-color: #f5e0ce;" title="#f5e0ce"></span>
                        </label>
                        <label class="flex items-center space-x-1 cursor-pointer">
                            <input type="radio" name="modal-bgColor" value="#A9B5A4" class="h-4 w-4 text-gray-400 border-gray-300">
                            <span class="w-6 h-6 rounded-full border shadow" style="background-color: #A9B5A4;" title="#A9B5A4"></span>
                        </label>
                        <label class="flex items-center space-x-1 cursor-pointer">
                            <input type="radio" name="modal-bgColor" value="#d7e4f7" class="h-4 w-4 text-gray-400 border-gray-300">
                            <span class="w-6 h-6 rounded-full border shadow" style="background-color: #d7e4f7;" title="#d7e4f7"></span>
                        </label>
                    </div>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="modal-highlight" class="h-4 w-4 rounded" style="color: var(--color-text-main); border-color: var(--color-divider);">
                    <label for="modal-highlight" class="ml-2 text-sm font-medium" style="color: var(--color-text-main);">é«˜äº®/é‡è¦é …ç›® (Highlight)</label>
                </div>

                <!-- è¡Œç¨‹ç…§ç‰‡ (å¯å¤šé¸ã€ä¸é™æ•¸é‡) -->
                <div>
                    <label for="modal-photos" class="block text-sm font-medium" style="color: var(--color-text-main);">ç…§ç‰‡ï¼ˆå¯å¤šé¸ã€ä¸é™æ•¸é‡ï¼‰</label>
                    <input type="file" id="modal-photos" accept="image/*" multiple class="w-full p-2 border rounded-lg text-sm bg-white" style="border-color: var(--color-divider);">
                    <p class="text-xs text-gray-500 mt-1">æç¤ºï¼šå¯æ‹–æ›³ç¸®åœ–æˆ–ç”¨ã€Œâ†‘ â†“ã€èª¿æ•´é †åºï¼›å¯åˆªé™¤å–®å¼µç…§ç‰‡ã€‚</p>
                    <div id="modal-photo-manager" class="mt-2 grid grid-cols-4 gap-2"></div>
                </div>



                <div class="flex justify-end space-x-3 mt-4">
                    <button type="button" id="modal-cancel-btn" class="muji-btn-light" style="border-color: var(--color-divider);">å–æ¶ˆ</button>
                    <button type="submit" id="modal-save-btn" class="muji-btn">å„²å­˜é …ç›®</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="list-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30 p-4 hidden">
        <div class="muji-card p-6 w-full max-w-sm" style="border-color: var(--color-divider);">
            <h3 class="text-xl font-bold mb-4" id="list-modal-title" style="color: var(--color-text-main);">æ–°å¢æ¸…å–®é …ç›®</h3>
            <form id="list-form" class="space-y-3">
                <input type="hidden" id="list-modal-category">
                <input type="hidden" id="list-modal-item-id">

                <div>
                    <label for="list-modal-text" class="block text-sm font-medium" style="color: var(--color-text-main);">é …ç›®åç¨±</label>
                    <input type="text" id="list-modal-text" required class="w-full p-2 border rounded-lg" placeholder="e.g. å…Œæ›éŸ“å…ƒ" style="border-color: var(--color-divider);">
                </div>
                
                <div>
                    <label for="list-modal-notes" class="block text-sm font-medium" style="color: var(--color-text-main);">å‚™è¨» (é¸å¡«)</label>
                    <input type="text" id="list-modal-notes" class="w-full p-2 border rounded-lg" placeholder="e.g. é ˆæ›å¤§éˆ”" style="border-color: var(--color-divider);">
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="list-modal-cancel-btn" class="muji-btn-light" style="border-color: var(--color-divider);">å–æ¶ˆ</button>
                    <button type="submit" id="list-modal-save-btn" class="muji-btn">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // --- å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ–è³‡æ–™ ---
        const APP_ID = 'KR_TRIP_APP'; // LocalStorage å‘½åç©ºé–“
        const exchangeRateKey = `${APP_ID}_EXCHANGE_RATE`;
        const daesagwanRateKey = `${APP_ID}_DAESAGWAN_RATE`; // NEW: æ˜æ´å¤§ä½¿é¤¨åŒ¯ç‡åƒè€ƒ
        const expensesKey = `${APP_ID}_EXPENSES`;
        const checklistKey = `${APP_ID}_CHECKLIST`;
        const memoKey = `${APP_ID}_MEMO`;
        const memoInfoKey = `${APP_ID}_MEMO_INFO`; // NEW: è³‡è¨Šé å‚™è¨»
        const tripDataKey = `${APP_ID}_TRIP_DATA`; 
        const APP_TITLE_KEY = `${APP_ID}_APP_TITLE`; // NEW KEY

        let currentRate = 0.024; // é è¨­éŸ“å…ƒåˆ°å°å¹£åŒ¯ç‡ (å¯èª¿æ•´)
        const TWD_SYMBOL = 'NT$';
        
        // NEW: æ‡‰ç”¨ç¨‹å¼é è¨­æ¨™é¡Œ
        const DEFAULT_TITLE = 'ğŸ‡°ğŸ‡· é¦–çˆ¾è¼•æ—…è¡Œ';
        
        // å¯ç”¨çš„èƒŒæ™¯è‰²
        const ITINERARY_COLORS = ['#FFF9E6', '#f5e0ce', '#A9B5A4', '#d7e4f7'];

        // NEW: é–‹éŠ·åˆ†é¡åŠå…¶åœ–ç¤º
        const EXPENSE_CATEGORIES = [
            { key: 'Food', name: 'é£Ÿç‰© (æ­£é¤)', icon: 'fa-utensils' },
            { key: 'Snack', name: 'é»å¿ƒ/ç”œé»', icon: 'fa-cookie-bite' },
            { key: 'Drink', name: 'é£²æ–™/å’–å•¡', icon: 'fa-mug-hot' },
            { key: 'Transport', name: 'äº¤é€š/è»Šè³‡', icon: 'fa-train-subway' },
            { key: 'Clothes', name: 'è¡£æœ/é…ä»¶', icon: 'fa-shirt' },
            { key: 'Beauty', name: 'ç¾å¦/ä¿é¤Šå“', icon: 'fa-spray-can' },
            { key: 'Shopping', name: 'è³¼ç‰© (å…¶ä»–)', icon: 'fa-bag-shopping' },
            { key: 'Other', name: 'å…¶ä»–', icon: 'fa-ellipsis' },
        ];
        
        // è¼”åŠ©å‡½å¼ï¼šæ ¹æ“š key å–å¾—åˆ†é¡è³‡è¨Š
        function getCategoryInfo(key) {
            return EXPENSE_CATEGORIES.find(cat => cat.key === key) || { key: 'Other', name: 'å…¶ä»–', icon: 'fa-ellipsis' };
        }

        // æ ¸å¿ƒè¡Œç¨‹æ•¸æ“š - åˆå§‹å€¼ (ä¿æŒä¸è®Š)
        const initialTripData = {
            flights: "å»ç¨‹ï¼š2026/2/13 è¯èˆªCI164 é«˜é›„-ä»å· (07:10 - 10:55)ï¼›å›ç¨‹ï¼š2026/2/21 è¯èˆªCI165 ä»å·-é«˜é›„ (12:00 - 14:10)",
            flights_note: "è«‹æ³¨æ„ï¼šå»ç¨‹CI164é è¨ˆ10:55æŠµé”ä»å·ï¼›å›ç¨‹CI165ç‚º12:00èµ·é£›ï¼Œè«‹å‹™å¿…é ç•™å……è¶³äº¤é€šèˆ‡å ±åˆ°æ™‚é–“ã€‚",
            accommodation: [
                // [0] å¤§è‡ªç„¶éŸ“å±‹æ—…é¤¨
                { date: "2/13 - 2/15", name: "å¤§è‡ªç„¶éŸ“å±‹æ—…é¤¨ (Dajayon Hanok Stay)", address: "81-3, Yulgok-ro 10-gil, Jongro-gu, é˜è·¯, é¦–çˆ¾, éŸ“åœ‹", mapLink: "https://www.google.com/maps/place/Dajayon+Hanok+Stay/data=!4m2!3m1!1s0x357ca352a7cdd2d5:0x5c2a92c61f4e3531?sa=X&ved=1t:242&ictx=111" },
                // [1] Airbnb
                { date: "2/15 - 2/21", name: "Airbnb æ—…é¤¨ (éº»æµ¦å€)", address: "29 Dohwa 2-gil, Dohwa-dong, Mapo-gu, Seoul, South Korea", mapLink: "https://www.google.com/maps/place/29+Dohwa+2-gil,+Mapo-gu,+Seoul,+%E5%8D%97%E9%9F%93/@37.5394541,126.9496077,17z/data=!3m1!4b1!4m6!3m5!1s0x357c98a8a4569029:0x95d15235dbbefdfc!8m2!3d37.5394541!4d126.9496077!16s%2Fg%2F11bzgc92fl?entry=ttu&g_ep=EgoyMDI1MTEyMy4xIKXMDSoASAFQAw%3D%3D" }
            ],
            itinerary: [
                { date: "2/13 (äº”)", items: [
                    { time: "ä¸­åˆå‰", name: "æŠµé”ä»å·ã€åŒ…è»Šè‡³ä½å®¿é»", type: "Travel", highlight: true, notes: "CI164 é è¨ˆ 10:55 æŠµé”ï¼Œç›´æ¥æ­è»Šå‰å¾€å¸‚å€", bgColor: ITINERARY_COLORS[3] }, 
                    { time: "åˆé¤", name: "í°ê¸°ì™€ì§‘(å¤§ç“¦æˆ¿é†¬èŸ¹-åŒ—æ‘)", type: "Food", notes: "ç±³å…¶æ—ä¸€æ˜Ÿ", link: "https://maps.app.goo.gl/cnKvroKdRau3itxz5", hours: "æ¯æ—¥ 12:00â€“21:00 (å¹³æ—¥ä¼‘æ¯ 15:00â€“17:00)", address_copy: "ì„œìš¸ ì¢…ë¡œêµ¬ ë¶ì´Œë¡œ 22 1ì¸µ", bgColor: ITINERARY_COLORS[0] },
                    { time: "ä¸‹åˆ", name: "ëŒ€ì‚¬ê´€ì•í™˜ì „ (æ˜æ´å¤§ä½¿é¤¨æ›éŒ¢)", type: "Activity", hours: "æ¯æ—¥ 09:00â€“20:00", address_copy: "ì„œìš¸ ì¤‘êµ¬ ëª…ë™2ê¸¸ 26" },
                    { time: "ä¸‹åˆ", name: "æ˜æ´é€›è¡—", type: "Activity" },
                    { time: "æ™šé¤", name: "ì¡°ì¡°ì¹¼êµ­ìˆ˜ ì‹œì²­ì  (æœæœåˆ€å‰Šéºµ å¸‚æ”¿å»³åº—)", type: "Food", link: "https://maps.app.goo.gl/3A2X4Y8k2T5eP8wQ7", hours: "æ¯æ—¥ 11:00â€“21:00 (ä¼‘æ¯æ™‚é–“ 15:00â€“17:00)", address_copy: "27 Sejong-daero 11-gil, Jung District, Seoul, å—éŸ“", bgColor: ITINERARY_COLORS[0] }
                ]},
                { date: "2/14 (å…­)", items: [
                    { time: "08:30", name: "æ˜æœˆæ ¼éŸ“æœè£é«®", type: "Activity", highlight: true, bgColor: ITINERARY_COLORS[1] },
                    { time: "10:00-12:00", name: "æ™¯ç¦å®®éŸ“æœæ‹ç…§", type: "Activity", link: "https://maps.app.goo.gl/3hJ5D7NqZ4pLg6F8A" },
                    { time: "åˆé¤", name: "í† ì†ì´Œ ì‚¼ê³„íƒ• (åœŸä¿—æ‘è”˜é›æ¹¯)", type: "Food", link: "https://maps.app.goo.gl/5z4B1wUuLu6eK8tY8", naver_link: "https://naver.me/FM6Bdfws", hours: "æ¯æ—¥ 10:00â€“22:00", address_copy: "5 Jahamun-ro 5-gil, JongnoDistrict, Seoul, å—éŸ“", bgColor: ITINERARY_COLORS[0] },
                    { time: "ä¸‹åˆ", name: "å¤å®®åšç‰©é¤¨", type: "Sightseeing" },
                    { time: "ä¸‹åˆ", name: "æ­·å²åšç‰©é¤¨", type: "Sightseeing" },
                    { time: "æ™šé¤", name: "ê³„ë¦¼ è¾£é›æ¹¯ (Gyerim)", type: "Food", notes: "åœ°å€: ì„œìš¸ ì¢…ë¡œêµ¬ ëˆí™”ë¬¸ë¡œ4ê¸¸ 39", link: "https://maps.app.goo.gl/A7F8U3x5L9JpY4kC9", bgColor: ITINERARY_COLORS[0] }
                ]},
                { date: "2/15 (æ—¥)", items: [
                    { time: "ä¸Šåˆ", name: "åŒ—æ‘é€›è¡—", type: "Activity" },
                    { time: "ä¸‹åˆ", name: "æ›ä½å®¿ (é·å¾€ Airbnb)", type: "Travel", highlight: true, bgColor: ITINERARY_COLORS[3] },
                    { time: "ä¸‹åˆ", name: "å¼˜å¤§é€›è¡—", type: "Activity" },
                    { time: "æ™šé¤", name: "í’ì²œì¥ì–´ (å¼˜å¤§çƒ¤é°»é­š)", type: "Food", hours: "æ¯æ—¥ 11:30â€“22:00", address_copy: "ì„œìš¸ ë§ˆí¬êµ¬ ë™êµë¡œ27ê¸¸ 39", bgColor: ITINERARY_COLORS[0] }
                ]},
                { date: "2/16 (ä¸€)", items: [
                    { time: "å…¨å¤©", name: "åŒ…è»Š: å—æ€¡å³¶, ä¸‰å²³å±±çºœè»Š", type: "Sightseeing", highlight: true, link: "https://maps.app.goo.gl/5tY8H7kG6R9pV2wD8", bgColor: ITINERARY_COLORS[2] }
                ]},
                { date: "2/17 (äºŒ)", items: [
                    { time: "å…¨å¤©", name: "DMZ ä¸€æ—¥éŠ", type: "Sightseeing", highlight: true, bgColor: ITINERARY_COLORS[2] }
                ]},
                { date: "2/18 (ä¸‰)", items: [
                    { time: "ä¸Šåˆ", name: "æœ›é å¸‚å ´", type: "Activity", link: "https://maps.app.goo.gl/W7H8U3x5L9JpZ4jB9" },
                    { time: "ä¸‹åˆ", name: "é¦–çˆ¾ç«™æ¨‚å¤©è¶…å¸‚", type: "Shopping" }
                ]},
                { date: "2/19 (å››)", items: [
                    { time: "å…¨å¤©", name: "åŒ…è»Š: å¤§é—œå¶º ä¸‰é¤Šç‰§å ´, éŸ“åœ‹æ±ŸåŸé“æœˆç²¾å¯º", type: "Sightseeing", highlight: true, link: "https://maps.app.goo.gl/H5J8K7oL6M2nT4xP9", bgColor: ITINERARY_COLORS[2] }
                ]},
                { date: "2/20 (äº”)", items: [
                    { time: "å…¨å¤©", name: "è‡ªç”±æ´»å‹•", type: "Activity" }
                ]},
                { date: "2/21 (å…­)", items: [
                    { time: "09:00", name: "é€€æˆ¿ä¸¦å‰å¾€ä»å·æ©Ÿå ´", type: "Travel", highlight: true, notes: "CI165 12:00 èµ·é£›ï¼Œè«‹é ç•™å……è¶³æ™‚é–“è¾¦ç†ç™»æ©Ÿæ‰‹çºŒ", bgColor: ITINERARY_COLORS[3] },
                    { time: "12:00", name: "è¯èˆªCI165 ä»å·-é«˜é›„", type: "Travel", highlight: true, bgColor: ITINERARY_COLORS[3] }
                ]},
            ],
            guide_spots: [
                { name: "æ™¯ç¦å®®", intro: "æ™¯ç¦å®®æ˜¯æœé®®ç‹æœï¼ˆ1392-1897å¹´ï¼‰çš„æ­£å®®ï¼Œæ„ç‚ºã€Œå¤§å‰å¤§åˆ©ã€ç¦ç¥¿ç¶¿é•·ã€ã€‚å®ƒå»ºæ–¼1395å¹´ï¼Œæ˜¯éŸ“åœ‹äº”å¤§å®®ê¶ä¸­è¦æ¨¡æœ€å¤§ã€å»ºç¯‰è¨­è¨ˆæœ€ç²¾ç¾çš„ã€‚æœ€è‘—åçš„å‹¤æ”¿æ®¿æ˜¯ç”¨æ–¼åœ‹å®¶å„€å¼å’Œæ¥è¦‹å¤–åœ‹ä½¿ç¯€çš„åœ°æ–¹ï¼Œè€Œé¦™é äº­å‰‡æ˜¯æ¹–ç•”çš„å„ªç¾äº­é–£ã€‚å†·çŸ¥è­˜ï¼šåœ¨æ—¥æ²»æ™‚æœŸï¼Œå®®æ®¿çš„å¤§éƒ¨åˆ†è¢«æ¯€æï¼Œç¾ä»Šæ‰€è¦‹æ˜¯å¤šå¹´ä¾†ä¿®å¾©çš„çµæœï¼Œé«”ç¾äº†éŸ“åœ‹å°æ­·å²çš„å …å®ˆèˆ‡å¾©èˆˆã€‚", map: { lat: 37.58, lng: 126.98 } },
                { name: "DMZ éè»äº‹å€", intro: "DMZï¼ˆDemilitarized Zoneï¼‰æ˜¯åˆ†éš”å—åŒ—éŸ“çš„ç·©è¡å€ï¼Œé•·ç´„250å…¬é‡Œï¼Œå¯¬ç´„4å…¬é‡Œã€‚é›–ç„¶åç‚ºéè»äº‹å€ï¼Œä½†å®ƒæ˜¯ä¸–ç•Œä¸Šè»äº‹åŒ–ç¨‹åº¦æœ€é«˜çš„åœ°å€ä¹‹ä¸€ã€‚é€™è£åŒæ™‚ä¹Ÿæ˜¯ä¸€å€‹ç”Ÿæ…‹å¤©å ‚ï¼Œå› ç‚ºäººé¡æ´»å‹•çš„é™åˆ¶ï¼Œæˆç‚ºäº†è¨±å¤šçç¨€é‡ç”Ÿå‹•æ¤ç‰©çš„æ£²æ¯åœ°ã€‚åƒè§€è¡Œç¨‹é€šå¸¸åŒ…æ‹¬æ¿é–€åº—ã€ç¬¬ä¸‰åœ°é“å’Œéƒ½ç¾…å±•æœ›å°ã€‚å†·çŸ¥è­˜ï¼šDMZ å…§éƒ¨æœ‰ä¸€å€‹åç‚ºã€Œå’Œå¹³ä¹‹æ‘ã€ï¼ˆå¤§æˆæ´ï¼‰çš„æ‘èŠï¼Œæ˜¯å”¯ä¸€å…è¨±å¹³æ°‘å±…ä½åœ¨DMZå…§çš„ç‰¹ä¾‹ã€‚", map: { lat: 37.93, lng: 126.70 } },
            ]
        };
        
        let tripData = {}; // å°‡ç”± loadInitialData è¼‰å…¥ LocalStorage å„²å­˜çš„è³‡æ–™

        // åˆå§‹æ¸…å–®æ•¸æ“š (å·²æ›´æ–°ç‚ºå…©æ¬„çµæ§‹ï¼Œä¸¦åŠ å…¥å‚™è¨»æ¬„ä½)
        const initialChecklist = {
            luggage: [
                { id: 1, text: "è­·ç…§", notes: "ç¢ºèªæ•ˆæœŸå¤§æ–¼å…­å€‹æœˆ", checked: false },
                { id: 2, text: "esim (æˆ–å¯¦é«” SIM å¡)", notes: "å‡ºç™¼å‰é–‹é€š", checked: false },
                { id: 3, text: "å°å¹£ (ç”¨æ–¼æ›éŸ“å¹£)", notes: "æ›éŒ¢æ‰€åªæ”¶å¤§éˆ”", checked: false },
                { id: 4, text: "ç¾½çµ¨å¤–å¥—", notes: "", checked: false },
                { id: 5, text: "è²¼èº«ä¿æš–è¡£ç‰© (ç™¼ç†±è¡£)", notes: "", checked: false },
                { id: 6, text: "å¸½å­, æ‰‹å¥—", notes: "éŸ“åœ‹å†¬å¤©å¿…å‚™", checked: false },
                { id: 7, text: "æ—…éŠå¸¸å‚™è—¥ (æ„Ÿå†’ã€è…¸èƒƒè—¥)", notes: "", checked: false },
                { id: 8, text: "ä¿å¥é£Ÿå“", notes: "", checked: false },
                { id: 9, text: "å€‹äººç›¥æ´—ç”¨å“", notes: "", checked: false },
                { id: 10, text: "åŒ–å¦å“, ä¿é¤Šå“, å¸å¦", notes: "", checked: false },
                { id: 11, text: "å‡¡å£«æ—, å”‡è†, èº«é«”ä¹³ (éŸ“åœ‹è¼ƒä¹¾ç‡¥)", notes: "", checked: false },
            ],
            todo: [
                { id: 101, text: "æ›éŸ“å¹£", notes: "ç›®æ¨™æ› 100 è¬ KRW", checked: false },
                { id: 102, text: "ç·šä¸Šè¾¦ç† K-ETA/Q-CODE", notes: "å‡ºç™¼å‰ 72 å°æ™‚å…§å®Œæˆ", checked: false },
                { id: 103, text: "ä¿¡ç”¨å¡é–‹é€šåœ‹å¤–äº¤æ˜“", notes: "", checked: false },
                { id: 104, text: "è¨‚è³¼æ©Ÿå ´æ¥é€æœå‹™", notes: "ç¢ºèªè»Šå‹èˆ‡äººæ•¸", checked: false },
            ]
        };


        // --- LocalStorage è®€å¯«å·¥å…· ---
        function getLocalStorage(key, defVal) {
  try {
    const raw = localStorage.getItem(key);
    if (raw === null) return defVal;
    const parsed = JSON.parse(raw);
    return (parsed === null || parsed === undefined) ? defVal : parsed;
  } catch (e) {
    return defVal;
  }
}

        function setLocalStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error(`Error setting LocalStorage key ${key}`, e);
            }
        }
        
        
// ===============================
// Cloud Sync (Supabase)
// ===============================
// 1) Supabase å…©å€‹å€¼ï¼ˆä½ å·²å¡«å¥½ï¼‰ï¼š
const SUPABASE_URL = "https://iqkhvluwlkqmwgynwxnh.supabase.co"; // ä½ çš„ Supabase Project URL
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlxa2h2bHV3bGtxbXdneW53eG5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1OTM3NTMsImV4cCI6MjA4MTE2OTc1M30.3FCpo4LCfCQWBj3PcZP4IJTYLR1lp_xmqan9zG3BHz0"; // Supabase Settings â†’ API â†’ anon publicï¼ˆä¸è¦æ”¾ service_roleï¼‰
const ENABLE_CLOUD_SYNC = SUPABASE_ANON_KEY !== "PASTE_YOUR_SUPABASE_ANON_KEY_HERE";
// 2) åŒä¸€ç¾¤äººå…±ç”¨åŒä¸€ä»½è³‡æ–™ï¼ˆå¯æ”¹æˆä¸åŒåç¨±ï¼‰
const SHARED_DOC_ID = "seoul-trip";

// 3) è¦åŒæ­¥çš„ localStorage keys
const SYNC_KEYS = [exchangeRateKey, daesagwanRateKey, expensesKey, checklistKey, memoKey, memoInfoKey, tripDataKey, APP_TITLE_KEY];

let supabaseClient = null;
let cloudAutoSync = true;
let cloudPushTimer = null;
let cloudPollTimer = null;
let cloudLastPushedHash = "";
let cloudLastRemoteUpdatedAt = null;
let cloudApplyingRemoteSnapshot = false;

function initSupabaseClient() {
  try {
    if (!window.supabase || !window.supabase.createClient) {
      console.warn("[CloudSync] Supabase client not loaded.");
      return null;
    }
    return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  } catch (e) {
    console.error("[CloudSync] init failed:", e);
    return null;
  }
}

function buildLocalSnapshot() {
  const snap = {};
  for (const k of SYNC_KEYS) {
    // Only include keys that actually exist and are not null.
    // This prevents us from pushing lots of nulls and later overwriting defaults.
    const raw = localStorage.getItem(k);
    if (raw === null) continue;
    try {
      const v = JSON.parse(raw);
      if (v === null || v === undefined) continue;
      snap[k] = v;
    } catch (e) {
      // ignore invalid JSON
    }
  }
  return snap;
}

async function ensureSharedDocExists() {
  if (!supabaseClient) return;
  try {
    // è‹¥ä¸å­˜åœ¨å°±å»ºç«‹ä¸€ç­†ï¼ˆupsertï¼‰
    const now = new Date().toISOString();
    const empty = buildLocalSnapshot();
    await supabaseClient
      .from("shared_docs")
      .upsert({ id: SHARED_DOC_ID, data: empty, updated_at: now }, { onConflict: "id" });
  } catch (e) {
    console.error("[CloudSync] ensure doc failed:", e);
  }
}

function scheduleCloudPush() {
  if (!cloudAutoSync) return;
  if (cloudApplyingRemoteSnapshot) return;
  clearTimeout(cloudPushTimer);
  cloudPushTimer = setTimeout(pushToCloud, 800);
}

async function pushToCloud() {
  if (!supabaseClient) return;
  try {
    const snapshot = buildLocalSnapshot();
    const hash = JSON.stringify(snapshot);
    if (hash === cloudLastPushedHash) return;

    cloudLastPushedHash = hash;
    const now = new Date().toISOString();

    const { data, error } = await supabaseClient
      .from("shared_docs")
      .upsert({ id: SHARED_DOC_ID, data: snapshot, updated_at: now }, { onConflict: "id" })
      .select("updated_at")
      .single();

    if (error) throw error;
    cloudLastRemoteUpdatedAt = data?.updated_at || now;
  } catch (e) {
    console.error("[CloudSync] push failed:", e);
  }
}

async function pullFromCloud(force = false) {
  if (!supabaseClient) return;
  try {
    const { data, error } = await supabaseClient
      .from("shared_docs")
      .select("data, updated_at")
      .eq("id", SHARED_DOC_ID)
      .single();

    if (error) throw error;
    if (!data) return;

    const remoteUpdatedAt = data.updated_at || null;
    if (!force && remoteUpdatedAt && cloudLastRemoteUpdatedAt && remoteUpdatedAt <= cloudLastRemoteUpdatedAt) {
      return;
    }

    // é˜²æ­¢è‡ªå·±å‰›æ¨ä¸Šå»åˆè¢«æ‹‰å›ä¾†é€ æˆå¾ªç’°
    cloudLastRemoteUpdatedAt = remoteUpdatedAt;

    if (data.data) {
      applyRemoteSnapshot(data.data);
    }
  } catch (e) {
    console.error("[CloudSync] pull failed:", e);
  }
}

function applyRemoteSnapshot(snapshot) {
  if (!snapshot || typeof snapshot !== "object") return;
  for (const k of SYNC_KEYS) {
    if (!(k in snapshot)) continue;
    const v = snapshot[k];
    // Never write null/undefined into localStorage; keep app defaults instead.
    if (v === null || v === undefined) continue;
    try {
      localStorage.setItem(k, JSON.stringify(v));
    } catch (e) {}
  }
}

function startCloudSync() {
  if (!cloudAutoSync) return;

  // åªåœ¨è§£é–å¾Œé–‹å§‹åŒæ­¥ï¼ˆé¿å…è¢«æœªæˆæ¬Šè€…ä¸€ç›´æ‰“ APIï¼‰
  if (window.__isAppUnlocked && !window.__isAppUnlocked()) return;

  if (!supabaseClient) {
    supabaseClient = initSupabaseClient();
  }
  if (!supabaseClient) return;

  ensureSharedDocExists().then(() => pullFromCloud(true));

  clearInterval(cloudPollTimer);
  cloudPollTimer = setInterval(() => pullFromCloud(false), 15000);
}

// è§£é–å¾Œè‡ªå‹•å•Ÿå‹•åŒæ­¥
(function bindUnlockHook() {
  const prev = window.__onAppUnlocked;
  window.__onAppUnlocked = function () {
    try { if (typeof prev === "function") prev(); } catch (e) {}
    startCloudSync();
  };
  // å¦‚æœä¸€é–‹å§‹å°±å·²ç¶“è§£é–ï¼Œç›´æ¥å•Ÿå‹•
  try { if (window.__isAppUnlocked && window.__isAppUnlocked()) startCloudSync(); } catch (e) {}
})();

// setLocalStorage åŒ…ä¸€å±¤ï¼šæ¯æ¬¡å¯«å…¥ localStorageï¼Œå°±è‡ªå‹•æ’ç¨‹æ¨é›²ç«¯
(function wrapSetLocalStorage() {
  const _orig = setLocalStorage;
  setLocalStorage = function (key, value) {
    _orig(key, value);
    // é¿å…ã€Œå¾é›²ç«¯å¥—ç”¨ã€åˆè§¸ç™¼ push
    if (!cloudApplyingRemoteSnapshot) {
      scheduleCloudPush();
    }
  };
})();

// --- é€šç”¨å‰ªè²¼ç°¿è¤‡è£½åŠŸèƒ½ ---
        function copyTextToClipboard(text, message) {
            try {
                // ä½¿ç”¨ document.execCommand('copy') ä½œç‚º iframe ç’°å¢ƒçš„é¦–é¸æ–¹æ³•
                const tempInput = document.createElement('textarea');
                tempInput.value = text;
                // è®“ textarea ä¸å¯è¦‹ä½†å¯é¸ä¸­
                tempInput.style.position = 'absolute';
                tempInput.style.left = '-9999px';
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                alertModal(message || 'åœ°å€å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            } catch (err) {
                console.error('Could not copy text: ', err);
                alertModal('ç„¡æ³•è¤‡è£½ï¼Œè«‹æ‰‹å‹•è¤‡è£½: ' + text);
            }
        }

        // --- æ¨™é¡Œç®¡ç†åŠŸèƒ½ (NEW) ---

        function loadTitle() {
            const title = getLocalStorage(APP_TITLE_KEY, DEFAULT_TITLE);
            document.getElementById('app-title-display').textContent = title;
            // æ›´æ–° HTML <title> æ¨™ç±¤
            document.title = title.includes('æ—…éŠå°å·¥å…·') ? title : `${title}ï¼šè¦ªå‹æ—…éŠå°å·¥å…·`; 
            document.getElementById('title-input').value = title;
        }

        function toggleTitleEdit(show) {
            const displayArea = document.getElementById('title-display-area');
            const editArea = document.getElementById('title-edit-area');
            const titleInput = document.getElementById('title-input');
            
            if (show) {
                displayArea.classList.add('hidden');
                editArea.classList.remove('hidden');
                titleInput.focus();
            } else {
                editArea.classList.add('hidden');
                displayArea.classList.remove('hidden');
            }
        }

        function saveTitle() {
            const titleInput = document.getElementById('title-input');
            const newTitle = titleInput.value.trim();
            
            if (newTitle.length > 0) {
                setLocalStorage(APP_TITLE_KEY, newTitle);
                loadTitle(); // Reloads title display and updates input value
                alertModal('æ¨™é¡Œå·²æ›´æ–°ï¼');
                toggleTitleEdit(false);
            } else {
                alertModal('æ¨™é¡Œä¸èƒ½ç‚ºç©ºã€‚');
                titleInput.focus();
            }
        }

        // --- åŒ¯ç‡èˆ‡è²»ç”¨è¨ˆç®—å·¥å…· ---
        function loadInitialData() {
            // åŠ è¼‰ä¸¦é¡¯ç¤ºåŒ¯ç‡
            currentRate = getLocalStorage(exchangeRateKey, 0.024);
            updateRateDisplay();

            // NEW: è¼‰å…¥è¡Œç¨‹è³‡æ–™
            tripData = getLocalStorage(tripDataKey, initialTripData);
        }

        function updateRateDisplay() {
  const badge = document.getElementById("rate-badge");
  if (!badge) return;

  const v = getLocalStorage(exchangeRateKey, 0.024);
  const rate = Number(v);

  if (!Number.isFinite(rate)) {
    badge.textContent = "KRW/TWD: -";
    return;
  }
  badge.textContent = `KRW/TWD: ${rate.toFixed(3)}`;
}

        function krwToTwd(krw) {
            return (krw * currentRate).toFixed(0);
        }

        // --- è¡Œç¨‹è³‡æ–™ LocalStorage å„²å­˜ (ä¸è®Š) ---
        function setTripData(data) {
            tripData = data; // æ›´æ–°å…¨åŸŸè®Šæ•¸
            setLocalStorage(tripDataKey, data);
        }

        // --- è¡Œç¨‹ç·¨è¼¯/æ–°å¢/åˆªé™¤åŠŸèƒ½ (ä¸è®Š) ---
        function openItineraryItemModal(dayIndex, itemIndex = null) {
            const modal = document.getElementById('itinerary-modal');
            const form = document.getElementById('itinerary-form');
            const title = document.getElementById('modal-title');
            
            // æ¸…ç©ºè¡¨å–®èˆ‡éš±è—æ¬„ä½
            form.reset();
            // ç¶å®šç…§ç‰‡ä¸Šå‚³èˆ‡ lightboxï¼ˆåªç¶ä¸€æ¬¡ï¼‰
            _bindItineraryPhotoInputOnce();
            _bindLightboxOnce();
            // åˆå§‹åŒ–æœ¬æ¬¡ modal çš„ç…§ç‰‡æ¸…å–®
            modalPhotoList = [];
            document.getElementById('modal-photos').value = '';
            document.getElementById('modal-day-index').value = dayIndex;
            document.getElementById('modal-item-index').value = itemIndex !== null ? itemIndex : '';
            
            // é‡è¨­é¡è‰²é¸æ“‡ç‚ºé è¨­
            document.querySelector(`input[name="modal-bgColor"][value=""]`).checked = true;


            if (itemIndex !== null) {
                // ç·¨è¼¯æ¨¡å¼
                title.textContent = "ç·¨è¼¯è¡Œç¨‹é …ç›®";
                const item = tripData.itinerary[dayIndex].items[itemIndex];
                document.getElementById('modal-name').value = item.name || '';
                document.getElementById('modal-time').value = item.time || '';
                document.getElementById('modal-type').value = item.type || 'Activity';
                document.getElementById('modal-notes').value = item.notes || '';
                document.getElementById('modal-hours').value = item.hours || '';
                document.getElementById('modal-address').value = item.address_copy || '';
                document.getElementById('modal-gmap').value = item.link || '';
                document.getElementById('modal-naver').value = item.naver_link || '';
                document.getElementById('modal-highlight').checked = item.highlight || false;
                
                // NEW: è¼‰å…¥èƒŒæ™¯è‰²
                const savedColor = item.bgColor || '';
                const colorRadio = document.querySelector(`input[name="modal-bgColor"][value="${savedColor}"]`);
                if(colorRadio) colorRadio.checked = true;

                // NEW: è¼‰å…¥æ—¢æœ‰ç…§ç‰‡åˆ°ç®¡ç†å€ï¼ˆå¯æ’åº/åˆªé™¤ï¼‰
                modalPhotoList = (Array.isArray(item.photos) ? item.photos : []).map(src => ({ id: _newPhotoId(), src }));
                renderModalPhotoManager();

            } else {
                // æ–°å¢æ¨¡å¼
                title.textContent = `æ–°å¢é …ç›®åˆ° ${tripData.itinerary[dayIndex].date}`;
                modalPhotoList = [];
                renderModalPhotoManager();
            }

            modal.classList.remove('hidden');
        }

        function handleItineraryItemSave(event) {
            event.preventDefault();
            
            const dayIndex = parseInt(document.getElementById('modal-day-index').value, 10);
            const itemIndexStr = document.getElementById('modal-item-index').value;
            const itemIndex = itemIndexStr === '' ? null : parseInt(itemIndexStr, 10);
            
            // NEW: å–å¾—é¸æ“‡çš„èƒŒæ™¯è‰²
            const selectedColor = document.querySelector('input[name="modal-bgColor"]:checked').value;

            const newItem = {
                time: document.getElementById('modal-time').value.trim(),
                name: document.getElementById('modal-name').value.trim(),
                type: document.getElementById('modal-type').value,
                notes: document.getElementById('modal-notes').value.trim() || undefined,
                photos: (Array.isArray(modalPhotoList) ? modalPhotoList.map(p => (typeof p === 'string' ? p : p.src)).filter(Boolean) : []),
                link: document.getElementById('modal-gmap').value.trim() || undefined,
                naver_link: document.getElementById('modal-naver').value.trim() || undefined,
                hours: document.getElementById('modal-hours').value.trim() || undefined,
                address_copy: document.getElementById('modal-address').value.trim() || undefined,
                highlight: document.getElementById('modal-highlight').checked || undefined,
                bgColor: selectedColor || undefined // NEW: åŠ å…¥èƒŒæ™¯è‰²
            };
            
            // æ¸…é™¤ undefined æˆ–ç©ºå­—ä¸²çš„å±¬æ€§
            Object.keys(newItem).forEach(key => newItem[key] === undefined || newItem[key] === '' ? delete newItem[key] : {});
            
            // æ·±åº¦è¤‡è£½ tripData
            const updatedTripData = JSON.parse(JSON.stringify(tripData));

            if (itemIndex !== null) {
                // ç·¨è¼¯ç¾æœ‰é …ç›®
                updatedTripData.itinerary[dayIndex].items[itemIndex] = newItem;
                alertModal('è¡Œç¨‹é …ç›®å·²æ›´æ–°ï¼');
            } else {
                // æ–°å¢é …ç›® (é è¨­åŠ åœ¨ç•¶æ—¥è¡Œç¨‹æœ«å°¾)
                updatedTripData.itinerary[dayIndex].items.push(newItem);
                alertModal('æ–°çš„è¡Œç¨‹é …ç›®å·²åŠ å…¥ï¼');
            }

            setTripData(updatedTripData);
            document.getElementById('itinerary-modal').classList.add('hidden');
            modalPhotoList = [];
            // å¿…é ˆå‚³å…¥ç•¶å‰å®¹å™¨ï¼Œä»¥ä¾¿é‡æ–°æ¸²æŸ“
            renderItineraryTab(document.getElementById('app-content')); 
        }

        function deleteItineraryItem(dayIndex, itemIndex) {
            if (!confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹é …ç›®å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;

            // æ·±åº¦è¤‡è£½ tripData
            const updatedTripData = JSON.parse(JSON.stringify(tripData));
            
            updatedTripData.itinerary[dayIndex].items.splice(itemIndex, 1);

            setTripData(updatedTripData);
            alertModal('è¡Œç¨‹é …ç›®å·²åˆªé™¤ã€‚');
            // å¿…é ˆå‚³å…¥ç•¶å‰å®¹å™¨ï¼Œä»¥ä¾¿é‡æ–°æ¸²æŸ“
            renderItineraryTab(document.getElementById('app-content')); 
        }

        // ===============================
        // Itinerary Photos: add / reorder / delete + lightbox
        // ===============================
        let modalPhotoList = [];
        let _itineraryPhotoInputBound = false;

        function _newPhotoId() {
            try { return crypto.randomUUID(); } catch (e) { return 'p_' + Date.now() + '_' + Math.random().toString(16).slice(2); }
        }

        function renderModalPhotoManager() {
            const wrap = document.getElementById('modal-photo-manager');
            if (!wrap) return;

            if (!Array.isArray(modalPhotoList) || modalPhotoList.length === 0) {
                wrap.innerHTML = `<p class="text-xs text-gray-500 col-span-4">å°šæœªä¸Šå‚³ç…§ç‰‡</p>`;
                return;
            }

            wrap.innerHTML = modalPhotoList.map((p, idx) => {
                const src = (typeof p === 'string') ? p : p?.src;
                const canUp = idx > 0;
                const canDown = idx < modalPhotoList.length - 1;
                return `
                    <div class="relative" draggable="true"
                         ondragstart="onModalPhotoDragStart(event, ${idx})"
                         ondragover="onModalPhotoDragOver(event)"
                         ondrop="onModalPhotoDrop(event, ${idx})">
                        <button type="button" class="block w-full" onclick="openModalPhotoPreview(${idx})" title="é»æ“Šé è¦½">
                            <img src="${src}" class="w-full aspect-square object-cover rounded-lg border shadow-sm" style="border-color: var(--color-divider);" />
                        </button>
                        <div class="absolute top-1 left-1 flex gap-1">
                            <button type="button" class="muji-btn-light text-[11px] px-2 py-1" style="border-color: var(--color-divider);" ${canUp ? '' : 'disabled'} onclick="moveModalPhoto(${idx}, -1)" title="å¾€å‰">
                                â†‘
                            </button>
                            <button type="button" class="muji-btn-light text-[11px] px-2 py-1" style="border-color: var(--color-divider);" ${canDown ? '' : 'disabled'} onclick="moveModalPhoto(${idx}, 1)" title="å¾€å¾Œ">
                                â†“
                            </button>
                        </div>
                        <button type="button" class="absolute top-1 right-1 muji-btn-light text-[11px] px-2 py-1" style="border-color: #fca5a5; color:#dc2626;" onclick="deleteModalPhoto(${idx})" title="åˆªé™¤">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function moveModalPhoto(idx, dir) {
            const j = idx + dir;
            if (j < 0 || j >= modalPhotoList.length) return;
            const arr = modalPhotoList.slice();
            const tmp = arr[idx];
            arr[idx] = arr[j];
            arr[j] = tmp;
            modalPhotoList = arr;
            renderModalPhotoManager();
        }

        function deleteModalPhoto(idx) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤ç…§ç‰‡ï¼Ÿ')) return;
            modalPhotoList.splice(idx, 1);
            renderModalPhotoManager();
        }

        let _dragPhotoIndex = null;
        function onModalPhotoDragStart(e, idx) {
            _dragPhotoIndex = idx;
            try { e.dataTransfer.effectAllowed = 'move'; } catch {}
        }
        function onModalPhotoDragOver(e) {
            e.preventDefault();
            try { e.dataTransfer.dropEffect = 'move'; } catch {}
        }
        function onModalPhotoDrop(e, dropIdx) {
            e.preventDefault();
            if (_dragPhotoIndex === null || _dragPhotoIndex === dropIdx) return;
            const arr = modalPhotoList.slice();
            const [moved] = arr.splice(_dragPhotoIndex, 1);
            arr.splice(dropIdx, 0, moved);
            modalPhotoList = arr;
            _dragPhotoIndex = null;
            renderModalPhotoManager();
        }

        // Lightbox state
        let _lightboxPhotos = [];
        let _lightboxIndex = 0;

        function _showLightboxAt(idx) {
            const lb = document.getElementById('photo-lightbox');
            const img = document.getElementById('photo-lightbox-img');
            const indicator = document.getElementById('photo-lightbox-indicator');
            const prevBtn = document.getElementById('photo-lightbox-prev');
            const nextBtn = document.getElementById('photo-lightbox-next');

            if (!lb || !img) return;
            _lightboxIndex = Math.max(0, Math.min(idx, _lightboxPhotos.length - 1));
            img.src = _lightboxPhotos[_lightboxIndex] || '';

            if (indicator) indicator.textContent = _lightboxPhotos.length ? `${_lightboxIndex + 1} / ${_lightboxPhotos.length}` : '';
            if (prevBtn) prevBtn.style.display = _lightboxPhotos.length > 1 ? '' : 'none';
            if (nextBtn) nextBtn.style.display = _lightboxPhotos.length > 1 ? '' : 'none';
        }

        function openPhotoLightbox(dayIndex, itemIndex, photoIndex = 0) {
            const item = tripData?.itinerary?.[dayIndex]?.items?.[itemIndex];
            const photos = (item && Array.isArray(item.photos)) ? item.photos : [];
            if (!photos.length) return;

            _lightboxPhotos = photos.slice();
            const lb = document.getElementById('photo-lightbox');
            if (!lb) return;
            lb.classList.remove('hidden');
            _showLightboxAt(photoIndex);
        }

        function openModalPhotoPreview(photoIndex = 0) {
            const photos = (Array.isArray(modalPhotoList) ? modalPhotoList : []).map(p => (typeof p === 'string') ? p : p?.src).filter(Boolean);
            if (!photos.length) return;

            _lightboxPhotos = photos;
            const lb = document.getElementById('photo-lightbox');
            if (!lb) return;
            lb.classList.remove('hidden');
            _showLightboxAt(photoIndex);
        }

        function closePhotoLightbox() {
            const lb = document.getElementById('photo-lightbox');
            if (!lb) return;
            lb.classList.add('hidden');
            _lightboxPhotos = [];
            _lightboxIndex = 0;
        }

        function _bindLightboxOnce() {
            const lb = document.getElementById('photo-lightbox');
            if (!lb) return;

            const backdrop = document.getElementById('photo-lightbox-backdrop');
            const prevBtn = document.getElementById('photo-lightbox-prev');
            const nextBtn = document.getElementById('photo-lightbox-next');
            const closeBtn = document.getElementById('photo-lightbox-close');

            const goPrev = () => _showLightboxAt((_lightboxIndex - 1 + _lightboxPhotos.length) % _lightboxPhotos.length);
            const goNext = () => _showLightboxAt((_lightboxIndex + 1) % _lightboxPhotos.length);

            if (backdrop) backdrop.addEventListener('click', closePhotoLightbox);
            if (closeBtn) closeBtn.addEventListener('click', closePhotoLightbox);
            if (prevBtn) prevBtn.addEventListener('click', () => { if (_lightboxPhotos.length) goPrev(); });
            if (nextBtn) nextBtn.addEventListener('click', () => { if (_lightboxPhotos.length) goNext(); });

            document.addEventListener('keydown', (e) => {
                if (lb.classList.contains('hidden')) return;
                if (e.key === 'Escape') closePhotoLightbox();
                if (_lightboxPhotos.length > 1) {
                    if (e.key === 'ArrowLeft') goPrev();
                    if (e.key === 'ArrowRight') goNext();
                }
            });
        }

        function _bindItineraryPhotoInputOnce() {
            if (_itineraryPhotoInputBound) return;
            const input = document.getElementById('modal-photos');
            if (!input) return;

            input.addEventListener('change', (e) => {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;

                const pending = files.length;
                let done = 0;
                files.forEach((file) => {
                    // å¤ç”¨æ—¢æœ‰å£“ç¸®ï¼šè¼¸å‡ºç‚ºè¼ƒå° base64ï¼Œé¿å… LocalStorage çˆ†æ‰
                    compressImage(file, (dataURL) => {
                        modalPhotoList.push({ id: _newPhotoId(), src: dataURL });
                        done += 1;
                        if (done >= pending) {
                            // æ¸…ç©º inputï¼Œè®“åŒä¸€å¼µç…§ç‰‡ä¹Ÿèƒ½å†é¸ä¸€æ¬¡
                            input.value = '';
                            renderModalPhotoManager();
                        }
                    });
                });
            });

            _itineraryPhotoInputBound = true;
        }


        // --- å½±åƒå£“ç¸®èˆ‡ Base64 è™•ç† ---
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const MAX_WIDTH = 300; // ç¸®åœ–æœ€å¤§å¯¬åº¦
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // è¼¸å‡ºç‚º Base64 (JPEG, ç•«è³ª 70%)
                    const dataURL = canvas.toDataURL('image/jpeg', 0.7);
                    callback(dataURL);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- å°èˆªèˆ‡å…§å®¹æ¸²æŸ“ (ä¸è®Š) ---
        function changeTab(tabName) {
            const content = document.getElementById('app-content');
            const navItems = document.querySelectorAll('.nav-item');

            // ç§»é™¤èˆŠçš„ active ç‹€æ…‹
            navItems.forEach(item => item.classList.remove('active'));

            // è¨­ç½®æ–°çš„ active ç‹€æ…‹
            const activeNav = document.querySelector(`.nav-item[data-tab="${tabName}"]`);
            if (activeNav) {
                activeNav.classList.add('active');
            }

            content.innerHTML = ''; // æ¸…ç©ºå…§å®¹
            window.scrollTo(0, 0); // å›åˆ°é ‚éƒ¨

            // æ ¹æ“š tabName æ¸²æŸ“å…§å®¹
            switch (tabName) {
                case 'FLIGHTS_STAY':
                    renderFlightsStayTab(content);
                    break;
                case 'ITINERARY':
                    renderItineraryTab(content);
                    break;
case 'WALLET':
                    renderWalletTab(content);
                    break;
                case 'LISTS':
                    renderListsTab(content);
                    break;
                case 'INFO':
                    renderInfoTab(content);
                    break;
            }
        }
        
        // --- Tab: FLIGHTS_STAY (èˆªç­èˆ‡ä½å®¿) æ¸²æŸ“ (ä¸è®Š) ---
        function renderFlightsStayTab(container) {
            const flightsNote = (tripData.flights_note && String(tripData.flights_note).trim()) ? String(tripData.flights_note) : "è«‹æ³¨æ„ï¼šå»ç¨‹CI164é è¨ˆ10:55æŠµé”ä»å·ï¼›å›ç¨‹CI165ç‚º12:00èµ·é£›ï¼Œè«‹å‹™å¿…é ç•™å……è¶³äº¤é€šèˆ‡å ±åˆ°æ™‚é–“ã€‚";
            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">âœˆï¸ èˆªç­èˆ‡ä½å®¿ç¸½è¦½</h2>

                <div class="muji-card p-4 mb-6">
                    <h3 class="text-xl font-bold mb-3 flex items-center" style="color: var(--color-text-main);">
                        <i class="fas fa-plane-departure mr-2 text-2xl" style="color: var(--color-accent);"></i> å‡ºå…¥å¢ƒèˆªç­
                    </h3>
                    <div class="text-sm p-3 rounded" style="background-color: var(--color-bg-primary);">
                        <p class="font-medium mb-2">${tripData.flights.split('ï¼›')[0].replace('å»ç¨‹ï¼š', 'ğŸ›« å»ç¨‹:')}</p>
                        <p class="font-medium">${tripData.flights.split('ï¼›')[1].replace('å›ç¨‹ï¼š', 'ğŸ›¬ å›ç¨‹:')}</p>
                    </div>
                    <div class="mt-3 p-3 rounded border" style="border-color: var(--color-divider);">
                        <div class="flex items-center justify-between gap-2">
                            <p class="text-xs font-semibold" style="color: var(--color-text-main);">èˆªç­å‚™è¨»</p>
                            <div class="flex items-center gap-2">
                                <button id="edit-flights-note-btn" type="button" class="muji-btn-light text-xs px-2 py-1 hover:shadow-md">
                                    <i class="fas fa-edit mr-1"></i>ç·¨è¼¯
                                </button>
                                <button id="hide-flights-note-editor-btn" type="button" class="muji-btn-light text-xs px-2 py-1 hover:shadow-md hidden">
                                    <i class="fas fa-chevron-up mr-1"></i>æ”¶èµ·
                                </button>
                            </div>
                        </div>

                        <div id="flights-note-view" class="text-xs text-gray-600 mt-2 whitespace-pre-wrap">${flightsNote}</div>

                        <div id="flights-note-editor" class="mt-2 hidden">
                            <textarea id="flights-note-input" class="w-full p-2 border rounded-lg text-xs" rows="3" style="border-color: var(--color-divider);">${flightsNote}</textarea>
                            <div class="flex gap-2 mt-2">
                                <button id="save-flights-note-btn" type="button" class="muji-btn text-xs px-3 py-1">
                                    <i class="fas fa-save mr-1"></i>å„²å­˜
                                </button>
                                <button id="cancel-flights-note-btn" type="button" class="muji-btn-light text-xs px-3 py-1" style="border-color: var(--color-divider);">
                                    å–æ¶ˆ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="muji-card p-4 mb-6">
                    <h3 class="text-xl font-bold mb-3 flex items-center" style="color: var(--color-text-main);">
                        <i class="fas fa-bed mr-2 text-2xl" style="color: var(--color-accent);"></i> ä½å®¿åœ°é» (å…± ${tripData.accommodation.length} è™•)
                    </h3>
                    
                    ${tripData.accommodation.map((acc, index) => `
                        <div class="text-base mb-4 p-3 rounded-lg border-l-4" style="border-color: var(--color-highlight); background-color: var(--color-bg-primary);">
                            <p class="font-bold text-lg mb-1" style="color: var(--color-text-main);">
                                <span class="text-sm font-normal p-1 mr-1 rounded" style="background-color: var(--color-accent); color: white;">${acc.date}</span> ${acc.name}
                            </p>
                            <div class="flex items-start justify-between gap-2 acc-wrap">
                                <p class="text-sm text-gray-600 acc-address flex-1">${acc.address}</p>
                                <button type="button" onclick="copyTextToClipboard(this.closest(\'div\').querySelector(\'.acc-address\').textContent, \'ä½å®¿åœ°å€å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\')" class="muji-btn-light text-xs mt-0 px-2 py-1 inline-flex items-center shrink-0 hover:shadow-md">
                                    <i class="fas fa-copy"></i>
                                </button>
                             </div>
                            <a href="${acc.mapLink}" target="_blank" class="muji-btn-light text-xs mt-2 px-2 py-1 inline-flex items-center hover:shadow-md">
                                <i class="fas fa-location-dot mr-1"></i> æŸ¥çœ‹åœ°åœ– / å°èˆª
                            </a>
                        </div>
                    `).join('')}
                </div>
            `;
            container.innerHTML = html;
            setupFlightsStayListeners();
        }


        // --- èˆªç­ä½å®¿é ï¼šå‚™è¨»å¯ç·¨è¼¯ + ç·¨è¼¯æ¬„æ”¶èµ· ---
        function setupFlightsStayListeners() {
            const view = document.getElementById('flights-note-view');
            const editorWrap = document.getElementById('flights-note-editor');
            const input = document.getElementById('flights-note-input');
            const editBtn = document.getElementById('edit-flights-note-btn');
            const hideBtn = document.getElementById('hide-flights-note-editor-btn');
            const saveBtn = document.getElementById('save-flights-note-btn');
            const cancelBtn = document.getElementById('cancel-flights-note-btn');

            if (!view || !editorWrap || !input || !editBtn || !hideBtn || !saveBtn || !cancelBtn) return;

            function openEditor() {
                editorWrap.classList.remove('hidden');
                hideBtn.classList.remove('hidden');
                editBtn.classList.add('hidden');
                input.focus();
            }

            function closeEditor(reset = true) {
                editorWrap.classList.add('hidden');
                hideBtn.classList.add('hidden');
                editBtn.classList.remove('hidden');
                if (reset) {
                    input.value = view.textContent || '';
                }
            }

            editBtn.onclick = openEditor;
            hideBtn.onclick = () => closeEditor(false);
            cancelBtn.onclick = () => closeEditor(true);

            saveBtn.onclick = () => {
                const v = (input.value || '').trim();
                const updatedTripData = JSON.parse(JSON.stringify(tripData || {}));
                updatedTripData.flights_note = v;
                setTripData(updatedTripData);

                view.textContent = v.length ? v : '-';
                closeEditor(false);
                alertModal('èˆªç­å‚™è¨»å·²æ›´æ–°ï¼');
            };
        }

        // --- Tab: ITINERARY (æ¯æ—¥è¡Œç¨‹è¡¨) æ¸²æŸ“ (ä¸è®Š) ---
        function renderItineraryTab(container) {
            
            // æ ¹æ“šæ—¥æœŸå–å¾—ä½å®¿è³‡è¨Š
            function getAccommodation(dateStr) {
                // å¾ "2/13 (äº”)" ä¸­æå–æ—¥æœŸæ•¸å­— (13)
                const dateParts = dateStr.match(/(\d+)\/(\d+)/);
                const dayValue = dateParts ? parseInt(dateParts[2], 10) : 0;
                
                // ä½å®¿è³‡è¨Šç´¢å¼•
                const hanokStay = tripData.accommodation[0]; // 2/13 - 2/14
                const airbnb = tripData.accommodation[1];    // 2/15 - 2/21

                if (dayValue >= 13 && dayValue <= 14) {
                    return hanokStay;
                } else if (dayValue >= 15 && dayValue <= 21) {
                    return airbnb;
                }
                return { name: "æœªçŸ¥ä½å®¿", address: "æœªçŸ¥åœ°é»", mapLink: "#" };
            }

            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">ğŸ—“ï¸ æ¯æ—¥è¡Œç¨‹ç´°ç¯€</h2>

                <p class="text-sm mb-6 text-gray-600">è¡Œç¨‹ä»¥æ™‚é–“è»¸æ–¹å¼å‘ˆç¾ï¼Œé»æ“Šã€Œç·¨è¼¯ã€å¯ä¿®æ”¹é …ç›®ï¼Œé»æ“Šã€Œæ–°å¢ã€å¯å¢åŠ é …ç›®ã€‚</p>
                
                ${tripData.itinerary.map((day, dayIndex) => { // æ–°å¢ dayIndex
                    // å–å¾—ç•¶å¤©ä½å®¿è³‡è¨Š
                    const currentAccommodation = getAccommodation(day.date);

                    // ä½¿ç”¨æ–°çš„æš–é»ƒè‰²ä½œç‚ºä½å®¿èƒŒæ™¯
                    const accommodationHtml = `
                        <div class="mt-4 pt-4 border-t border-dashed" style="border-color: var(--color-divider);">
                            <h5 class="text-sm font-bold p-1 rounded inline-flex items-center" style="background-color: var(--color-highlight); color: var(--color-text-main);">
                                <i class="fas fa-bed mr-1 text-base"></i> ç•¶æ™šä½å®¿ï¼š${currentAccommodation.name}
                            </h5>
                            <div class="mt-1 flex items-start justify-between gap-2 stay-wrap">
                             <p class="text-xs text-gray-600 stay-address flex-1">${currentAccommodation.address}</p>
                             <button type="button" onclick="copyTextToClipboard(this.closest(\'div\').querySelector(\'.stay-address\').textContent, \'ä½å®¿åœ°å€å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\')" class="muji-btn-light text-[11px] px-2 py-1 inline-flex items-center shrink-0 hover:shadow-md" style="border-color: var(--color-divider);">
                                 <i class="fas fa-copy"></i>
                             </button>
                         </div>
                            <a href="${currentAccommodation.mapLink}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800">
                                <i class="fas fa-location-dot mr-1"></i>æŸ¥çœ‹åœ°åœ–
                            </a>
                        </div>
                    `;

                    return `
                        <div class="mb-8 p-3 muji-card">
                            <div class="flex justify-between items-center">
                                <h4 class="text-lg font-bold text-white p-2 rounded-t-lg mb-4" style="background-color: var(--color-accent);">
                                    ${"Day" + (dayIndex + 1) + "ï¼š" + day.date}
                                </h4>
                                <button onclick="openItineraryItemModal(${dayIndex})" class="muji-btn text-xs px-3 py-1 mb-3">
                                    <i class="fas fa-plus mr-1"></i> æ–°å¢é …ç›®
                                </button>
                            </div>

                            <div class="relative pl-8">
                                ${day.items.map((item, itemIndex) => { // æ–°å¢ itemIndex
                                    // é«˜äº®é …ç›®ä½¿ç”¨ç¶“å…¸æš–é»ƒè‰²
                                    const highlightStyle = item.highlight ? `background-color: var(--color-highlight); font-weight: bold; color: var(--color-text-main);` : '';
                                    const dotClass = item.highlight ? 'bg-red-500' : 'bg-gray-400';
                                    
                                    // NEW: è‡ªè¨‚èƒŒæ™¯è‰² (ä½¿ç”¨ç™½è‰²ä½œç‚ºé è¨­/ç©ºå€¼)
                                    const itemBgColor = item.bgColor && item.bgColor !== '' ? item.bgColor : 'white';
                                    const itemContainerStyle = `background-color: ${itemBgColor}; border-color: var(--color-divider);`;

                                    // åˆ¤æ–· Naver Map é€£çµï¼Œå„ªå…ˆä½¿ç”¨è‡ªè¨‚ï¼Œå…¶æ¬¡ç”¨åœ°å€ï¼Œæœ€å¾Œç”¨åç¨±æœå°‹
                                    const naverLink = item.naver_link || (item.address_copy ? `https://map.naver.com/v5/search/${encodeURIComponent(item.address_copy)}` : `https://map.naver.com/v5/search/${encodeURIComponent(item.name)}`);

                                    const itemLink = (item.link || item.naver_link || item.type === 'Food' || item.type === 'Activity') ? `
                                        <div class="mt-2 flex flex-wrap gap-2">
                                            ${item.link ? `
                                                <a href="${item.link}" target="_blank" class="muji-btn-light text-xs px-2 py-1 flex items-center hover:shadow-md">
                                                    <i class="fas fa-map-pin mr-1"></i> Google Map
                                                </a>
                                            ` : ''}
                                            <a href="${naverLink}" target="_blank" class="muji-btn-light text-xs px-2 py-1 flex items-center hover:shadow-md">
                                                <i class="fas fa-map mr-1"></i> Naver Map
                                            </a>
                                            <a href="https://www.google.com/search?q=${encodeURIComponent(item.name)} é£Ÿè¨˜" target="_blank" class="muji-btn-light text-xs px-2 py-1 flex items-center hover:shadow-md">
                                                <i class="fas fa-utensils mr-1"></i> é£Ÿè¨˜/ä»‹ç´¹
                                            </a>
                                        </div>
                                    ` : '';

                                    return `
                                        <div class="timeline-item relative pb-6 ml-3">
                                            <div class="timeline-dot ${dotClass} ${item.highlight ? 'ring-4' : ''}" style="border-color: var(--color-divider); background-color: ${item.highlight ? 'var(--color-text-main)' : 'var(--color-divider)'}; top: 2px; ${item.highlight ? 'box-shadow: 0 0 0 3px var(--color-highlight);' : ''}"></div>
                                            <div class="ml-4 p-3 rounded-lg border-l-4 shadow-sm" style="border-color: var(--color-divider); ${itemContainerStyle}">
                                                
                                                <div class="flex justify-between items-start">
                                                    <p class="text-sm font-medium p-1 rounded inline-block" style="${highlightStyle}">${item.time}</p>
                                                    <div class="flex space-x-2">
                                                        <button onclick="openItineraryItemModal(${dayIndex}, ${itemIndex})" class="muji-btn-light text-xs px-2 py-1 flex items-center hover:shadow-md">
                                                            <i class="fas fa-edit text-gray-600"></i>
                                                        </button>
                                                        <button onclick="deleteItineraryItem(${dayIndex}, ${itemIndex})" class="muji-btn-light text-xs px-2 py-1 flex items-center hover:shadow-md" style="color: #dc2626; border-color: #fca5a5;">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <p class="text-base font-semibold mt-1" style="color: var(--color-text-main);">${item.name}</p>
                                                <p class="text-xs text-gray-500">${item.notes || item.type}</p>
                                                
                                                ${item.hours || item.address_copy ? `
                                                    <div class="mt-2 p-3 rounded-lg border-l-2" style="border-color: var(--color-accent); background-color: var(--color-bg-primary);">
                                                        ${item.hours ? `<p class="text-xs text-gray-700 mb-1"><i class="far fa-clock mr-1 text-sm" style="color: var(--color-text-main);"></i> ç‡Ÿæ¥­æ™‚é–“: <span class="font-medium">${item.hours}</span></p>` : ''}
                                                        ${item.address_copy ? `
                                                            <div class="mt-2 pt-2 border-t border-dashed" style="border-color: var(--color-divider);">
                                                                <p class="text-xs font-medium mb-1" style="color: var(--color-text-main);">åœ°å€ (ä¸€éµè¤‡è£½):</p>
                                                                <div class="flex items-center space-x-2">
                                                                    <p class="text-xs text-gray-600 font-mono break-all flex-1">${item.address_copy}</p>
                                                                    <button onclick="copyTextToClipboard(this.previousElementSibling.textContent)" class="muji-btn-light text-xs px-2 py-1 flex items-center shrink-0 hover:shadow-md">
                                                                        <i class="fas fa-copy"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                ` : ''}

                                                ${item.photos && item.photos.length ? `
                                                    <div class="mt-3 flex flex-wrap gap-2">
                                                        ${item.photos.map((src, pIdx) => `
                                                            <button type="button" class="group relative" onclick="openPhotoLightbox(${dayIndex}, ${itemIndex}, ${pIdx})" title="é»æ“Šæ”¾å¤§">
                                                                <img src="${src}" class="w-16 h-16 object-cover rounded-lg border shadow-sm" style="border-color: var(--color-divider);" />
                                                                <span class="absolute inset-0 rounded-lg ring-0 group-hover:ring-2 group-hover:ring-black/20"></span>
                                                            </button>
                                                        `).join('')}
                                                    </div>
                                                ` : ''}

                                                ${itemLink}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${accommodationHtml}
                        </div>
                    `;
                }).join('')}
            `;
            container.innerHTML = html;
        }

        // --- Tab: GUIDE (æ·±åº¦å°è¦½) æ¸²æŸ“ (ä¸è®Š) ---
        function renderGuideTab(container) {
            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">ğŸ“– æ·±åº¦å°è¦½èˆ‡æ—…éŠæ‰‹å†Š</h2>
                <p class="text-sm mb-6 text-gray-600">æä¾›é‡é»æ™¯é»çš„æ­·å²èƒŒæ™¯èˆ‡å†·çŸ¥è­˜ï¼Œæ’ç‰ˆæ¨¡æ“¬é›œèªŒé¢¨æ ¼ï¼Œè®“é–±è®€æ›´è¼•é¬†ã€‚</p>
                
                ${tripData.guide_spots.map((spot, index) => `
                    <div class="muji-card p-5 mb-8">
                        <div class="flex items-center mb-4">
                            <span class="text-3xl font-serif text-white px-3 py-1 mr-3 rounded" style="background-color: var(--color-accent);">
                                ${index + 1}
                            </span>
                            <h3 class="text-xl font-bold" style="color: var(--color-text-main);">${spot.name}</h3>
                        </div>

                        <div class="p-4 rounded border-l-4" style="background-color: var(--color-bg-primary); border-color: var(--color-divider);">
                            <p class="text-sm italic mb-3" style="color: var(--color-text-main);">#æ­·å²èˆ‡æ–‡åŒ–</p>
                            <p class="text-base whitespace-pre-wrap text-gray-700">${spot.intro}</p>
                        </div>
                        
                        <h4 class="text-lg font-semibold mt-6 mb-3" style="color: var(--color-text-main);">åœ°åœ–ä½ç½® (OpenStreetMap)</h4>
                        <div class="aspect-video overflow-hidden rounded-lg border" style="border-color: var(--color-divider); box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);">
                            <iframe 
                                width="100%" 
                                height="100%" 
                                frameborder="0" 
                                scrolling="no" 
                                marginheight="0" 
                                marginwidth="0" 
                                src="https://www.openstreetmap.org/export/embed.html?bbox=${spot.map.lng - 0.005}%2C${spot.map.lat - 0.003}%2C${spot.map.lng + 0.005}%2C${spot.map.lat + 0.003}&layer=mapnik&marker=${spot.map.lat}%2C${spot.map.lng}" 
                                style="border: 0;">
                            </iframe>
                            <small>
                                <a href="https://www.openstreetmap.org/?mlat=${spot.map.lat}&mlon=${spot.map.lng}#map=16/${spot.map.lat}/${spot.map.lng}" target="_blank" class="text-xs text-gray-500 block text-right mt-1">æŸ¥çœ‹å¤§åœ–</a>
                            </small>
                        </div>
                    </div>
                `).join('')}
            `;
            container.innerHTML = html;
        }


        // --- Tab: WALLET (è¨˜å¸³èˆ‡åŒ¯ç‡) æ¸²æŸ“ ---
        function renderWalletTab(container) {
            // è¼‰å…¥è¨˜å¸³è³‡æ–™
            let expenses = getLocalStorage(expensesKey, []);

            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">ğŸ’° è¨˜å¸³èˆ‡åŒ¯ç‡ä¸­å¿ƒ</h2>

                <div class="muji-card p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-3 flex items-center" style="color: var(--color-text-main);">
                        <i class="fas fa-money-check-dollar mr-2 text-xl" style="color: var(--color-accent);"></i> æ˜æ´å¤§ä½¿é¤¨åŒ¯ç‡åƒè€ƒ
                    </h3>
                    
                    <label for="daesagwan-rate-input" class="block text-sm font-medium mb-1" style="color: var(--color-text-main);">ä»Šæ—¥å¤§ä½¿é¤¨æ›éŒ¢æ‰€åŒ¯ç‡ (KRW/TWD):</label>
                    <input type="text" id="daesagwan-rate-input" class="w-full p-2 mb-3 border rounded-lg text-sm" placeholder="e.g. 0.0245 (åƒ…ä¾›åƒè€ƒï¼Œä¸æœƒå½±éŸ¿è¨ˆç®—)" style="border-color: var(--color-divider);">

                    <a href="https://creatrip.com/exchange" target="_blank" class="muji-btn w-full text-center flex items-center justify-center text-sm">
                        <i class="fas fa-external-link-alt mr-2"></i> å‰å¾€ Creatrip æŸ¥çœ‹å³æ™‚åŒ¯ç‡
                    </a>
                </div>

                <div class="muji-card p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-3" style="color: var(--color-text-main);">åŒ¯ç‡æ›ç®—æ©Ÿ</h3>
                    <div class="flex space-x-2 mb-3">
                        <input type="number" id="rate-input" value="${currentRate.toFixed(4)}" step="0.0001" class="w-1/3 p-2 border rounded-lg focus:ring-1 focus:ring-red-300" placeholder="0.024" style="border-color: var(--color-divider); color: var(--color-text-main);">
                        <button id="set-rate-btn" class="muji-btn text-sm w-2/3">è¨­å®šç•¶å‰ KRW/TWD åŒ¯ç‡</button>
                    </div>

                    <div class="grid grid-cols-4 gap-2 p-3 rounded-lg" style="background-color: var(--color-bg-primary);">
                        <input type="text" id="calc-display" class="col-span-4 text-right text-2xl p-2 mb-2 rounded border font-mono bg-white" value="0" readonly style="border-color: var(--color-divider);">
                        <div id="calc-result" class="col-span-4 text-right text-sm text-gray-500">
                            ${TWD_SYMBOL} <span id="calc-twd-result">0</span>
                        </div>
                        
                        <button class="calc-btn muji-btn-light text-xl" data-value="C" style="background-color: var(--color-divider);">C</button>
                        <button class="calc-btn muji-btn-light text-xl" data-value="back"><i class="fas fa-backspace"></i></button>
                        <button class="calc-btn muji-btn-light text-xl" data-value="/">Ã·</button>
                        <button class="calc-btn muji-btn-light text-xl" data-value="*">Ã—</button>

                        <button class="calc-btn muji-btn text-xl" data-value="7">7</button>
                        <button class="calc-btn muji-btn text-xl" data-value="8">8</button>
                        <button class="calc-btn muji-btn text-xl" data-value="9">9</button>
                        <button class="calc-btn muji-btn-light text-xl" data-value="-">âˆ’</button>

                        <button class="calc-btn muji-btn text-xl" data-value="4">4</button>
                        <button class="calc-btn muji-btn text-xl" data-value="5">5</button>
                        <button class="calc-btn muji-btn text-xl" data-value="6">6</button>
                        <button class="calc-btn muji-btn-light text-xl" data-value="+">&plus;</button>

                        <button class="calc-btn muji-btn text-xl" data-value="1">1</button>
                        <button class="calc-btn muji-btn text-xl" data-value="2">2</button>
                        <button class="calc-btn muji-btn text-xl" data-value="3">3</button>
                        <button class="calc-btn muji-btn-light text-xl row-span-2" data-value="=">=</button>

                        <button class="calc-btn muji-btn text-xl" data-value="00">00</button>
                        <button class="calc-btn muji-btn text-xl" data-value="0">0</button>
                        <button class="calc-btn muji-btn text-xl" data-value=".">.</button>
                    </div>
                </div>

                <div class="muji-card p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-3" style="color: var(--color-text-main);">æ–°å¢ä¸€ç­†é–‹éŠ·</h3>
                    
                    <select id="expense-category" class="w-full p-2 mb-2 border rounded-lg" style="border-color: var(--color-divider);">
                        ${EXPENSE_CATEGORIES.map(cat => `<option value="${cat.key}">${cat.name}</option>`).join('')}
                    </select>

                    <input type="text" id="expense-item" class="w-full p-2 mb-2 border rounded-lg" placeholder="å“é …åç¨± (e.g. åˆé¤ã€å’–å•¡)" style="border-color: var(--color-divider);">
                    <input type="number" id="expense-krw" class="w-full p-2 mb-2 border rounded-lg" placeholder="éŸ“å¹£é‡‘é¡ (KRW)" style="border-color: var(--color-divider);">
                    
                    <label class="block text-sm font-medium mb-2" style="color: var(--color-text-main);">ä¸Šå‚³æˆ–æ‹ç…§ (å£“ç¸®ç‚ºç¸®åœ–)</label>
                    <input type="file" id="expense-photo" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold" style="--file-bg: var(--color-accent); --file-text: var(--color-text-main);" onMouseOver="this.style.backgroundColor='var(--color-highlight)'" onMouseOut="this.style.backgroundColor='var(--color-bg-primary)'">
                    <div id="photo-preview" class="mt-2 text-center text-sm text-gray-400">ï¼ˆåœ–ç‰‡å£“ç¸®å¾Œä¸æœƒä½”ç”¨å¤ªå¤šå®¹é‡ï¼Œæœ‰ç…§ç‰‡æ™‚ä¸æœƒé¡¯ç¤ºåˆ†é¡åœ–ç¤ºï¼‰</div>

                    <button id="add-expense-btn" class="muji-btn w-full mt-4">ç´€éŒ„é–‹éŠ·</button>
                </div>

                <h3 class="text-xl font-bold mb-3" style="color: var(--color-text-main);">ğŸ“œ è¨˜å¸³æ­·å²</h3>
                <div id="expense-list-container">
                    ${expenses.length === 0 ? '<p class="text-center text-gray-500 p-4">ç›®å‰æ²’æœ‰è¨˜å¸³ç´€éŒ„ã€‚</p>' : ''}
                </div>
            `;
            container.innerHTML = html;
            setupWalletListeners();
            renderExpenseList();
        }

        // æ¸²æŸ“è¨˜å¸³æ­·å²åˆ—è¡¨ (æ›´æ–°: é¡¯ç¤ºåˆ†é¡åœ–ç¤ºå’Œåˆªé™¤æŒ‰éˆ•)
        function renderExpenseList() {
            const container = document.getElementById('expense-list-container');
            let expenses = getLocalStorage(expensesKey, []);

            if (!container) return;

            if (expenses.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-4">ç›®å‰æ²’æœ‰è¨˜å¸³ç´€éŒ„ã€‚</p>';
                return;
            }

            // è¨ˆç®—ç¸½é¡
            const totalKRW = expenses.reduce((sum, exp) => sum + exp.krw, 0);
            const totalTWD = krwToTwd(totalKRW);

            let listHtml = `
                <div class="muji-card p-4 mb-4 text-center" style="background-color: var(--color-highlight); border-color: var(--color-accent);">
                    <p class="text-lg font-bold" style="color: var(--color-text-main);">ç¸½è¨ˆèŠ±è²»</p>
                    <p class="text-2xl font-bold my-1" style="color: var(--color-text-main);">${totalKRW.toLocaleString()} KRW</p>
                    <p class="text-md text-gray-500">ç´„ ${TWD_SYMBOL} ${totalTWD.toLocaleString()} TWD</p>
                </div>

                <div class="space-y-3">
                    ${expenses.reverse().map(exp => {
                        const catInfo = getCategoryInfo(exp.category); // å–å¾—åˆ†é¡è³‡è¨Š
                        
                        return `
                        <div class="muji-card p-3 flex items-center justify-between border" style="border-color: var(--color-divider);">
                            <div class="flex items-center space-x-3 flex-1 min-w-0">
                                ${exp.photo ? 
                                    `<img src="${exp.photo}" alt="æ”¶æ“šç¸®åœ–" class="w-12 h-12 object-cover rounded-md border" style="border-color: var(--color-divider);">` 
                                    : 
                                    `<div class="w-12 h-12 flex items-center justify-center rounded-md text-white text-xl shadow-md" style="background-color: var(--color-text-main);">
                                        <i class="fas ${catInfo.icon}"></i>
                                    </div>`
                                }
                                <div class="truncate flex-1 min-w-0">
                                    <p class="font-medium truncate" style="color: var(--color-text-main);">${exp.item}</p>
                                    <p class="text-xs text-gray-500">${catInfo.name} - ${new Date(exp.timestamp).toLocaleDateString()} ${new Date(exp.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                                </div>
                            </div>
                            
                            <div class="text-right flex flex-col items-end justify-between space-y-1 ml-4">
                                <p class="text-sm font-semibold whitespace-nowrap" style="color: var(--color-text-main);">${exp.krw.toLocaleString()} KRW</p>
                                <p class="text-xs text-gray-500 whitespace-nowrap">${TWD_SYMBOL} ${krwToTwd(exp.krw)}</p>
                                <button onclick="deleteExpense(${exp.id})" class="text-xs text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition duration-150 whitespace-nowrap">
                                    <i class="fas fa-trash-alt mr-1"></i> åˆªé™¤
                                </button>
                            </div>
                        </div>
                    `;
                    }).join('')}
                </div>
            `;
            container.innerHTML = listHtml;
        }
        
        // NEW: åˆªé™¤å–®ç­†é–‹éŠ·è¨˜éŒ„
        function deleteExpense(expenseId) {
            if (!confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†é–‹éŠ·ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) {
                return;
            }

            let expenses = getLocalStorage(expensesKey, []);
            
            // éæ¿¾æ‰ç¬¦åˆ ID çš„é …ç›®
            const updatedExpenses = expenses.filter(exp => exp.id !== expenseId);
            
            setLocalStorage(expensesKey, updatedExpenses);
            
            alertModal('é–‹éŠ·ç´€éŒ„å·²åˆªé™¤ã€‚');
            
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            renderExpenseList();
        }


        // è¨­ç½® Wallet Tab çš„äº‹ä»¶ç›£è½å™¨ (å·²åŠ å…¥å„²å­˜æˆåŠŸæç¤º)
        function setupWalletListeners() {
            // --- åŒ¯ç‡è¨­å®š ---
            document.getElementById('set-rate-btn').addEventListener('click', () => {
                const input = document.getElementById('rate-input');
                const newRate = parseFloat(input.value);
                if (newRate > 0) {
                    currentRate = newRate;
                    setLocalStorage(exchangeRateKey, newRate);
                    updateRateDisplay();
                    renderExpenseList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°å°å¹£é‡‘é¡
                } else {
                    alertModal("è«‹è¼¸å…¥æœ‰æ•ˆçš„åŒ¯ç‡ã€‚");
                }
            });

            // --- æ˜æ´å¤§ä½¿é¤¨åŒ¯ç‡åƒè€ƒï¼ˆåªè¨˜éŒ„ã€ä¸ä¸­æ–·è¨ˆç®—ï¼‰---
            const daesagwanInput = document.getElementById('daesagwan-rate-input');
            if (daesagwanInput) {
                const savedDaesagwan = getLocalStorage(daesagwanRateKey, '');
                if (savedDaesagwan !== null && savedDaesagwan !== undefined) {
                    daesagwanInput.value = String(savedDaesagwan);
                }
                const persistDaesagwan = () => setLocalStorage(daesagwanRateKey, daesagwanInput.value.trim());
                daesagwanInput.addEventListener('input', persistDaesagwan);
                daesagwanInput.addEventListener('change', persistDaesagwan);
            }

            // --- è¨ˆç®—æ©Ÿé‚è¼¯ ---
            const display = document.getElementById('calc-display');
            const twdResult = document.getElementById('calc-twd-result');
            const buttons = document.querySelectorAll('.calc-btn');

            buttons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const value = e.currentTarget.dataset.value;
                    let current = display.value === '0' ? '' : display.value;

                    try {
                        if (value === 'C') {
                            display.value = '0';
                        } else if (value === 'back') {
                            display.value = current.length > 1 ? current.slice(0, -1) : '0';
                        } else if (value === '=') {
                            // åƒ…å…è¨±æ•¸å­—å’ŒåŸºæœ¬é‹ç®—ç¬¦è™Ÿ
                            const safeExpression = current.replace(/[^-()\d/*+. ]/g, '');
                            const krwTotal = eval(safeExpression);
                            if (isNaN(krwTotal) || !isFinite(krwTotal)) throw new Error('Invalid calculation');
                            
                            display.value = Math.floor(krwTotal).toString(); // çµæœå–æ•´æ•¸ (éŸ“å¹£ç„¡å°æ•¸)
                        } else {
                            if (current === '0' && value !== '.') current = '';
                            display.value = current + value;
                        }
                        
                        // å³æ™‚è¨ˆç®— KRW ç¸½é¡ä¸¦æ›ç®— TWD
                        let krwAmount = 0;
                        try {
                            const safeExpression = display.value.replace(/[^-()\d/*+. ]/g, '');
                            krwAmount = eval(safeExpression) || 0;
                        } catch (e) {
                            krwAmount = 0;
                        }

                        twdResult.textContent = krwToTwd(Math.floor(krwAmount));

                    } catch (e) {
                        display.value = 'Error';
                        twdResult.textContent = '0';
                        console.error('Calculator error:', e);
                    }
                });
            });

            // --- è¨˜å¸³åŠŸèƒ½ (é‡é»æª¢æŸ¥å€) ---
            const photoInput = document.getElementById('expense-photo');
            let base64Photo = null;

            photoInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    compressImage(file, (dataURL) => {
                        base64Photo = dataURL;
                        const preview = document.getElementById('photo-preview');
                        preview.innerHTML = `<img src="${dataURL}" class="w-20 h-20 object-cover mx-auto rounded-md mt-2 border" style="border-color: var(--color-divider);">`;
                    });
                }
            });

            document.getElementById('add-expense-btn').addEventListener('click', () => {
                const itemInput = document.getElementById('expense-item');
                const krwInput = document.getElementById('expense-krw');
                const categoryInput = document.getElementById('expense-category'); // NEW

                const item = itemInput.value.trim();
                // ä½¿ç”¨ parseInt ç¢ºä¿æ˜¯æ•´æ•¸
                const krw = parseInt(krwInput.value, 10);
                const category = categoryInput.value; // NEW

                if (!item || isNaN(krw) || krw <= 0) {
                    alertModal("è«‹è¼¸å…¥æœ‰æ•ˆçš„å“é …åç¨±å’ŒéŸ“å¹£é‡‘é¡ã€‚");
                    return;
                }

                const newExpense = {
                    id: Date.now(),
                    item: item,
                    krw: krw,
                    category: category, // NEW: å„²å­˜åˆ†é¡
                    photo: base64Photo,
                    timestamp: new Date().toISOString()
                };

                // æ ¸å¿ƒå„²å­˜æ­¥é©Ÿ
                let expenses = getLocalStorage(expensesKey, []); // 1. è¼‰å…¥èˆŠè³‡æ–™
                expenses.push(newExpense);                           // 2. åŠ å…¥æ–°è³‡æ–™
                setLocalStorage(expensesKey, expenses);              // 3. å„²å­˜è‡³ç€è¦½å™¨ localStorage

                // æ¸…ç©ºè¡¨å–®
                itemInput.value = '';
                krwInput.value = '';
                categoryInput.value = EXPENSE_CATEGORIES[0].key; // é‡è¨­åˆ†é¡
                photoInput.value = null; // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥
                document.getElementById('photo-preview').innerHTML = 'ï¼ˆåœ–ç‰‡å£“ç¸®å¾Œä¸æœƒä½”ç”¨å¤ªå¤šå®¹é‡ï¼Œæœ‰ç…§ç‰‡æ™‚ä¸æœƒé¡¯ç¤ºåˆ†é¡åœ–ç¤ºï¼‰';
                base64Photo = null;

                renderExpenseList();
                alertModal('é–‹éŠ·é …ç›®å·²æˆåŠŸç´€éŒ„ï¼'); // **NEW: å„²å­˜æˆåŠŸæç¤º**
            });
        }


        // --- Tab: LISTS (æ¸…å–®) æ¸²æŸ“ (å·²é‡æ§‹) ---
        function renderListsTab(container) {
            // è¼‰å…¥æ¸…å–®å’Œå‚™å¿˜éŒ„
            const checklist = getLocalStorage(checklistKey, initialChecklist);
            const memoText = getLocalStorage(memoKey, "æ­¡è¿ä½¿ç”¨å‚™å¿˜éŒ„ï¼å¯ä»¥åœ¨é€™è£¡è¨˜éŒ„ç¶²å€ï¼Œæœƒè‡ªå‹•è½‰æ›æˆé€£çµæŒ‰éˆ•ã€‚\n\nä¾‹å¦‚ï¼š\nNaver åœ°åœ–: https://map.naver.com/");

            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">ğŸ“ è¡Œå‰æ¸…å–®èˆ‡å‚™å¿˜éŒ„</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div id="luggage-list-card" class="muji-card p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-bold" style="color: var(--color-text-main);">è¡Œææ¸…å–® (Luggage)</h3>
                            <button onclick="openListItemModal('luggage')" class="muji-btn text-xs px-3 py-1" style=" height: 40px; display: flex; align-items: center;width: 100px;justify-content: space-around;background-color: #D8C6BA;">
                                <i class="fas fa-plus mr-1"></i> æ–°å¢
                            </button>
                        </div>
                        <p id="luggage-count" class="text-xs text-gray-500 mb-3"></p>
                        <div id="luggage-container" class="space-y-3">
                            </div>
                    </div>

                    <div id="todo-list-card" class="muji-card p-4">
                        <div class="flex justify-between items-center mb-3">
                          <div>
                            <h3 class="text-lg font-bold" style="color: var(--color-text-main);">ä»£è¾¦äº‹é …</h3>
                            <h3 class="text-lg font-bold" style="color: var(--color-text-main);">(To-do)</h3>
                          </div>
                            <button onclick="openListItemModal('todo')" class="muji-btn text-xs px-3 py-1"style=" height: 40px; display: flex; align-items: center;width: 90px;justify-content: space-around;background-color: #D8C6BA;">
                                <i class="fas fa-plus mr-1"></i> æ–°å¢
                            </button>
                        </div>
                        <p id="todo-count" class="text-xs text-gray-500 mb-3"></p>
                        <div id="todo-container" class="space-y-3">
                            </div>
                    </div>
                </div>

                <div class="muji-card p-4">
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2" style="color: var(--color-text-main); border-color: var(--color-divider);">å€‹äººå‚™å¿˜éŒ„</h3>
                    <textarea id="memo-input" class="w-full p-3 border rounded-lg focus:ring-1 focus:ring-red-300 text-sm" rows="5" placeholder="æƒ³è¨˜ä»€éº¼éƒ½å¯ä»¥â€¦ï¼ˆæ”¯æ´è²¼é€£çµï¼Œä¸‹é¢æœƒè‡ªå‹•è½‰é è¦½ï¼‰" style="border-color: var(--color-divider); color: var(--color-text-main);">${memoText}</textarea>
                    <button id="save-memo-btn" class="muji-btn w-full mt-3">å„²å­˜å‚™å¿˜éŒ„</button>
                    <div class="mt-4 p-3 rounded-lg" id="memo-output" style="background-color: var(--color-bg-primary);">
                        <h4 class="font-medium mb-2" style="color: var(--color-text-main);">é€£çµé è¦½ (è‡ªå‹•è½‰æ›)</h4>
                        </div>
                </div>
            `;
            container.innerHTML = html;
            setupListsListeners();
        }

        // æ¸²æŸ“å–®ä¸€ CheckList é …ç›® (å·²æ›´æ–°)
        function renderChecklist(category) {
            const container = document.getElementById(`${category}-container`);
            const countDisplay = document.getElementById(`${category}-count`);
            if (!container || !countDisplay) return;

            const checklist = getLocalStorage(checklistKey, initialChecklist);
            const items = checklist[category] || [];

            const checkedCount = items.filter(item => item.checked).length;
            const totalCount = items.length;

            // æ›´æ–°è¨ˆæ•¸å™¨ (å¾ 0 é–‹å§‹è¨ˆç®—ï¼Œç¸½æ•¸ç‚º totalCount)
            countDisplay.innerHTML = `å·²å®Œæˆ <span class="font-bold text-lg" style="color: var(--color-text-main);">${checkedCount}</span> / ç¸½é …ç›® <span class="font-bold text-lg">${totalCount}</span>`;

            container.innerHTML = items.map((item) => `
                <div class="p-2 rounded border transition duration-150" style="border-color: var(--color-divider); background-color: ${item.checked ? 'var(--color-bg-primary)' : 'white'};">
                    <div class="flex items-start justify-between">
                        <div class="flex items-center flex-1 min-w-0">
                            <input type="checkbox" id="check-${category}-${item.id}" data-id="${item.id}" data-category="${category}" class="h-5 w-5 border-gray-300 rounded focus:ring-red-500 cursor-pointer" style="color: var(--color-text-main); border-color: var(--color-divider);" ${item.checked ? 'checked' : ''} onclick="toggleChecklistItem('${category}', ${item.id})">
                            <label for="check-${category}-${item.id}" class="ml-3 text-sm flex-1 break-words cursor-pointer">
                                <p class="font-medium ${item.checked ? 'line-through text-gray-500' : 'text-gray-800'}" style="color: ${item.checked ? 'gray' : 'var(--color-text-main)'};">${item.text}</p>
                                ${item.notes ? `<p class="text-xs text-gray-400 mt-0.5">${item.notes}</p>` : ''}
                            </label>
                        </div>
                        <div class="flex space-x-1.5 ml-2 shrink-0">
                            <button onclick="openListItemModal('${category}', ${item.id})" class="muji-btn-light text-xs px-2 py-1 flex items-center hover:shadow-md" style="background-color: white;">
                                <i class="fas fa-edit text-gray-600"></i>
                            </button>
                            <button onclick="deleteListItem('${category}', ${item.id})" class="muji-btn-light text-xs px-2 py-1 flex items-center hover:shadow-md" style="background-color: white; color: #dc2626; border-color: #fca5a5;">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // åˆ‡æ›æ¸…å–®é …ç›®ç‹€æ…‹
        function toggleChecklistItem(category, itemId) {
            let checklist = getLocalStorage(checklistKey, initialChecklist);
            const item = checklist[category].find(i => i.id === itemId);
            if (item) {
                item.checked = !item.checked;
                setLocalStorage(checklistKey, checklist);
                renderChecklist(category);
            }
        }
        
        // é–‹å•Ÿæ¸…å–®ç·¨è¼¯ Modal (æ–°å¢)
        function openListItemModal(category, itemId = null) {
            const modal = document.getElementById('list-modal');
            const form = document.getElementById('list-form');
            const title = document.getElementById('list-modal-title');
            
            form.reset();
            document.getElementById('list-modal-category').value = category;
            document.getElementById('list-modal-item-id').value = itemId !== null ? itemId : '';
            
            if (itemId !== null) {
                // ç·¨è¼¯æ¨¡å¼
                title.textContent = "ç·¨è¼¯æ¸…å–®é …ç›®";
                const checklist = getLocalStorage(checklistKey, initialChecklist);
                const item = checklist[category].find(i => i.id === itemId);
                if (item) {
                    document.getElementById('list-modal-text').value = item.text || '';
                    document.getElementById('list-modal-notes').value = item.notes || '';
                }
            } else {
                // æ–°å¢æ¨¡å¼
                title.textContent = `æ–°å¢ ${category === 'luggage' ? 'è¡Œæ' : 'ä»£è¾¦'} é …ç›®`;
            }

            modal.classList.remove('hidden');
        }
        
        // å„²å­˜æ¸…å–®é …ç›® (æ–°å¢)
        function handleListItemSave(event) {
            event.preventDefault();
            
            const category = document.getElementById('list-modal-category').value;
            const itemIdStr = document.getElementById('list-modal-item-id').value;
            const itemId = itemIdStr === '' ? null : parseInt(itemIdStr, 10);
            
            const text = document.getElementById('list-modal-text').value.trim();
            const notes = document.getElementById('list-modal-notes').value.trim();
            
            if (!text) {
                alertModal('é …ç›®åç¨±ä¸èƒ½ç‚ºç©ºï¼');
                return;
            }
            
            let checklist = getLocalStorage(checklistKey, initialChecklist);
            
            const newItem = {
                text: text,
                notes: notes,
                checked: false
            };

            if (itemId !== null) {
                // ç·¨è¼¯ç¾æœ‰é …ç›®
                const index = checklist[category].findIndex(i => i.id === itemId);
                if (index !== -1) {
                    checklist[category][index].text = newItem.text;
                    checklist[category][index].notes = newItem.notes;
                    alertModal('é …ç›®å·²æ›´æ–°ï¼');
                }
            } else {
                // æ–°å¢é …ç›®
                // ç°¡æ˜“ ID ç”Ÿæˆï¼Œå–ç•¶å‰æœ€å¤§ ID + 1
                const maxId = checklist[category].reduce((max, item) => Math.max(max, item.id), category === 'luggage' ? 0 : 100);
                newItem.id = maxId + 1;
                checklist[category].push(newItem);
                alertModal('æ–°é …ç›®å·²åŠ å…¥ï¼');
            }

            setLocalStorage(checklistKey, checklist);
            document.getElementById('list-modal').classList.add('hidden');
            renderChecklist(category); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        }

        // åˆªé™¤æ¸…å–®é …ç›® (æ–°å¢)
        function deleteListItem(category, itemId) {
            if (!confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤æ¸…å–®é …ç›®å—ï¼Ÿ')) return;
            
            let checklist = getLocalStorage(checklistKey, initialChecklist);
            
            checklist[category] = checklist[category].filter(item => item.id !== itemId);
            
            setLocalStorage(checklistKey, checklist);
            alertModal('é …ç›®å·²åˆªé™¤ã€‚');
            renderChecklist(category);
        }

        // æ¸²æŸ“å‚™å¿˜éŒ„è¼¸å‡º (è‡ªå‹•è½‰æ›é€£çµ) (ä¸è®Š)
        function renderMemoOutput(memoText, outputId, linkPrefix = '<i class="fas fa-link mr-2"></i>') {
            const outputDiv = document.getElementById(outputId);
            if (!outputDiv) return;

            // åŒ¹é… URLï¼ŒåŒæ™‚åŒ¹é…é›»è©±è™Ÿç¢¼ (tel:xxx)
            const urlRegex = /(https?:\/\/[^\s]+|tel:\+?\d[\d\s-]*)/g;
            const lines = memoText.split('\n');
            
            let outputHtml = '<h4 class="font-medium mb-2" style="color: var(--color-text-main);">é€£çµ/é›»è©±é è¦½ (è‡ªå‹•è½‰æ›)</h4><div class="space-y-2">';
            let hasMatch = false;

            lines.forEach(line => {
                const matches = line.match(urlRegex);
                if (matches) {
                    matches.forEach(url => {
                        hasMatch = true;
                        
                        // å˜—è©¦å¾è¡Œé¦–æå–é€£çµåç¨±ï¼Œå¦‚æœè¡Œå°¾æ˜¯é€£çµï¼Œå‰‡å–é€£çµå‰çš„æ–‡å­—
                        let linkName = line.replace(url, '').trim();
                        let icon = linkPrefix;
                        let displayUrl = url;

                        if (url.startsWith('tel:')) {
                            icon = '<i class="fas fa-phone mr-2"></i>';
                            // ç§»é™¤ tel: å‰ç¶´ä½œç‚ºé¡¯ç¤ºåç¨±
                            linkName = linkName || url.substring(4);
                        } else {
                            // å¦‚æœæ²’æœ‰å…¶ä»–æ–‡å­—ï¼Œå‰‡ç›´æ¥ä½¿ç”¨é€£çµçš„ç°¡åŒ–å½¢å¼
                            if (linkName === '') {
                                try {
                                    const urlObj = new URL(url);
                                    linkName = urlObj.hostname + urlObj.pathname.substring(0, 15) + '...';
                                } catch (e) {
                                    linkName = url;
                                }
                            }
                        }

                        outputHtml += `
                            <a href="${url}" target="${url.startsWith('tel:') ? '_self' : '_blank'}" class="muji-btn-light w-full text-left flex items-center justify-between text-sm" style="border-color: var(--color-divider); background-color: white;">
                                <span>${icon} ${linkName}</span>
                                <i class="fas ${url.startsWith('tel:') ? 'fa-mobile-alt' : 'fa-external-link-alt'} text-xs"></i>
                            </a>
                        `;
                    });
                }
            });

            if (!hasMatch) {
                outputHtml += '<p class="text-sm text-gray-400">æ²’æœ‰åµæ¸¬åˆ°å¯è½‰æ›çš„ç¶²å€æˆ–é›»è©±é€£çµã€‚</p>';
            }

            outputHtml += '</div>';
            outputDiv.innerHTML = outputHtml;
        }

        // è¨­ç½® Lists Tab çš„äº‹ä»¶ç›£è½å™¨ (å·²é‡æ§‹)
        function setupListsListeners() {
            // 1. CheckList æ¸²æŸ“
            renderChecklist('luggage');
            renderChecklist('todo');

            // 2. Memo è¼‰å…¥èˆ‡äº‹ä»¶
            const memoText = getLocalStorage(memoKey, "æ­¡è¿ä½¿ç”¨å‚™å¿˜éŒ„ï¼å¯ä»¥åœ¨é€™è£¡è¨˜éŒ„ç¶²å€ï¼Œæœƒè‡ªå‹•è½‰æ›æˆé€£çµæŒ‰éˆ•ã€‚\n\nä¾‹å¦‚ï¼š\nNaver åœ°åœ–: https://map.naver.com/");
            renderMemoOutput(memoText, 'memo-output');

            document.getElementById('save-memo-btn').addEventListener('click', () => {
                const input = document.getElementById('memo-input');
                const newMemoText = input.value;
                setLocalStorage(memoKey, newMemoText);
                renderMemoOutput(newMemoText, 'memo-output');
                alertModal("å‚™å¿˜éŒ„å·²å„²å­˜ã€‚");
            });

            // 3. æ¸…å–®ç·¨è¼¯ Modal ç›£è½å™¨
            const listModal = document.getElementById('list-modal');
            if (listModal) {
                // ç¶å®šå„²å­˜æŒ‰éˆ•
                document.getElementById('list-form').addEventListener('submit', handleListItemSave);
                // ç¶å®šå–æ¶ˆæŒ‰éˆ•
                document.getElementById('list-modal-cancel-btn').addEventListener('click', () => {
                    listModal.classList.add('hidden');
                });
            }
        }


        // --- Tab: INFO (è³‡è¨Š) æ¸²æŸ“ (æ–°å¢å€‹äººç·Šæ€¥å‚™è¨»æ¬„) ---
        function renderInfoTab(container) {
             const infoMemoText = getLocalStorage(memoInfoKey, "ä¾‹å¦‚ï¼š\n1. æ—…éŠä¿éšªå–®è™Ÿï¼šPL-1234567\n2. ä¿¡ç”¨å¡å®¢æœé›»è©±ï¼š+886-2-2500-XXXX\n3. å‚™ç”¨è¯çµ¡äººï¼šå°æ˜ï¼Œæ‰‹æ©Ÿï¼štel:+886-912-345-678");

            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">ğŸ’¡ æ—…éŠå¯¦ç”¨è³‡è¨Š</h2>

                <div class="muji-card p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2" style="color: var(--color-text-main); border-color: var(--color-divider);">ç•¶åœ°è³‡è¨Šé€£çµ</h3>
                    <div class="space-y-3">
                        <a href="https://weather.com/zh-TW/weather/today/l/KSXX0037:1:KS" target="_blank" class="muji-btn-light w-full flex items-center justify-between" style="border-color: var(--color-divider); background-color: var(--color-bg-primary);">
                            <span><i class="fas fa-cloud-sun mr-2"></i> é¦–çˆ¾ç•¶åœ°å¤©æ°£é å ±</span>
                            <i class="fas fa-external-link-alt text-xs"></i>
                        </a>
                    </div>

                    <h3 class="text-lg font-semibold mt-6 mb-3 border-b pb-2" style="color: var(--color-text-main); border-color: var(--color-divider);">ç·Šæ€¥è¯çµ¡è³‡è¨Š</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-2 border-b" style="border-color: var(--color-divider);">
                            <span class="font-medium text-red-600"><i class="fas fa-house-medical mr-2"></i> æ•‘è­·è»Š/æ€¥è¨º</span>
                            <span class="font-bold text-lg" style="color: var(--color-text-main);">119</span>
                        </div>
                        <div class="flex justify-between items-center p-2 border-b" style="border-color: var(--color-divider);">
                            <span class="font-medium text-blue-600"><i class="fas fa-user-shield mr-2"></i> è­¦å¯Ÿ</span>
                            <span class="font-bold text-lg" style="color: var(--color-text-main);">112</span>
                        </div>
                        <div class="p-2 border rounded-lg" style="background-color: var(--color-bg-primary); border-color: var(--color-divider);">
                            <p class="font-medium" style="color: var(--color-text-main);">é§éŸ“åœ‹è‡ºåŒ—ä»£è¡¨éƒ¨</p>
                            <p class="text-sm text-gray-600">åœ°å€ï¼šé¦–çˆ¾å¸‚é¾è·¯å€ä¸–å®—å¤§è·¯ 149 å…‰åŒ–é–€å¤§å»ˆ 6 æ¨“</p>
                            <p class="text-sm text-gray-600">æ€¥é›£æ•‘åŠ©é›»è©±ï¼š<a href="tel:+82-2-399-2782" class="text-blue-600 hover:underline">+82-2-399-2782</a></p>
                        </div>
                    </div>
                </div>

                <div class="muji-card p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2" style="color: var(--color-text-main); border-color: var(--color-divider);"> å‚™è¨»æ¬„</h3>
                    <textarea id="memo-info-input" class="w-full p-3 h-40 border rounded-lg focus:ring-1 focus:ring-red-300 text-sm" placeholder="è¼¸å…¥æ‚¨çš„å‚™è¨»å…§å®¹" style="border-color: var(--color-divider); color: var(--color-text-main);"></textarea>
                    <button id="save-memo-info-btn" class="muji-btn w-full mt-3">å„²å­˜å‚™è¨»</button>
                    <div class="mt-4 p-3 rounded-lg" id="memo-info-output" style="background-color: var(--color-bg-primary);">
                        </div>
                </div>

                <div class="muji-card p-4">
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2" style="color: var(--color-text-main); border-color: var(--color-divider);">âš ï¸ æ—…éŠç¦å¿Œèˆ‡æ³¨æ„äº‹é …</h3>
                    <ul class="text-sm space-y-2 list-disc list-inside text-gray-600">
                        <li><span class="font-medium" style="color: var(--color-text-main);">å‡ºå…¥å¢ƒé•ç¦å“ï¼š</span>åš´ç¦æ”œå¸¶è‚‰é¡ã€ç”Ÿé®®ç”¢å“å…¥å¢ƒã€‚éƒ¨åˆ†è—¥å“å¦‚å«æœ‰éº»é†‰æˆ–ç®¡åˆ¶æˆåˆ†éœ€ç”³å ±ã€‚</li>
                        <li><span class="font-medium" style="color: var(--color-text-main);">é¤é£²ç¦®å„€ï¼š</span>ç”¨é¤æ™‚ï¼Œå°‡ç¢—ç¢Ÿç•™åœ¨æ¡Œä¸Šï¼Œä¸æ§èµ·é£¯ç¢—æˆ–æ¹¯ç¢—ã€‚ä¸å¯ç”¨ç­·å­æŒ‡äººã€‚</li>
                        <li><span class="font-medium" style="color: var(--color-text-main);">é•·å¹¼å°Šå‘ï¼š</span>å‘å¹´é•·è€…éç‰©æˆ–æ¥ç‰©æ™‚ï¼Œæ‡‰é›™æ‰‹é€²è¡Œï¼Œä»¥ç¤ºå°Šé‡ã€‚</li>
                        <li><span class="font-medium" style="color: var(--color-text-main);">å…¬å…±äº¤é€šï¼š</span>åœ¨åœ°éµæˆ–å…¬è»Šä¸Šæ‡‰ç‚ºè€äººã€å­•å©¦è®“åº§ï¼ŒéŸ“åœ‹ç¤¾æœƒå°æ­¤éå¸¸é‡è¦–ã€‚</li>
                        <li><span class="font-medium" style="color: var(--color-text-main);">éŸ“å±‹ä½å®¿ï¼š</span>åœ¨å‚³çµ±éŸ“å±‹å…§éœ€è„«é‹ï¼Œæ³¨æ„ä¿æŒå®‰éœï¼Œä»¥ç¶­è­·ç’°å¢ƒã€‚</li>
                    </ul>
                </div>
            `;
            container.innerHTML = html;
            setupInfoListeners();
        }
        
        // NEW: è¨­ç½® Info Tab çš„äº‹ä»¶ç›£è½å™¨
        function setupInfoListeners() {  
            renderMemoOutput(infoMemoText, 'memo-info-output', '<i class="fas fa-shield-halved mr-2"></i>'); // ä½¿ç”¨ç›¾ç‰Œåœ–ç¤ºä½œç‚ºå‚™è¨»é€£çµå‰ç¶´

            document.getElementById('save-memo-info-btn').addEventListener('click', () => {
                const input = document.getElementById('memo-info-input');
                const newMemoText = input.value;
                setLocalStorage(memoInfoKey, newMemoText);
                renderMemoOutput(newMemoText, 'memo-info-output', '<i class="fas fa-shield-halved mr-2"></i>');
                alertModal("å‚™è¨»å·²å„²å­˜ã€‚");
            });
        }


        // --- Custom Alert Modal (å–ä»£ alert()) ---
        function alertModal(message) {
            let modal = document.getElementById('custom-alert-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'custom-alert-modal';
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30 p-4 hidden';
                modal.innerHTML = `
                    <div class="muji-card p-6 w-full max-w-xs text-center" style="border-color: var(--color-divider);">
                        <p class="text-lg font-medium mb-4" id="alert-message" style="color: var(--color-text-main);"></p>
                        <button id="alert-close-btn" class="muji-btn w-full">ç¢ºèª</button>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('alert-close-btn').onclick = () => {
                    modal.classList.add('hidden');
                };
            }
            document.getElementById('alert-message').textContent = message;
            modal.classList.remove('hidden');
        }

        // --- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š ---
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData(); // åŠ è¼‰åŒ¯ç‡å’Œè¡Œç¨‹è³‡æ–™
            loadTitle(); // NEW: åŠ è¼‰ä¸¦é¡¯ç¤ºæ¨™é¡Œ
            // ç¶å®šè¡Œç¨‹ç…§ç‰‡ lightbox / ä¸Šå‚³ï¼ˆåªç¶ä¸€æ¬¡ï¼‰
            try { _bindLightboxOnce(); _bindItineraryPhotoInputOnce(); } catch (e) {}
            
            // åˆå§‹è¼‰å…¥ FLIGHTS_STAY tab (æ–°çš„é¦–é )
            changeTab('FLIGHTS_STAY');

            // ç¶å®šåº•éƒ¨å°èˆªåˆ—äº‹ä»¶
            document.querySelectorAll('.nav-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tab = e.currentTarget.dataset.tab;
                    changeTab(tab);
                });
            });
            
            // NEW: æ¨™é¡Œç·¨è¼¯äº‹ä»¶ç¶å®š
            document.getElementById('edit-title-btn').addEventListener('click', () => {
                toggleTitleEdit(true);
            });
            
            document.getElementById('save-title-btn').addEventListener('click', saveTitle);
            
            document.getElementById('cancel-edit-btn').addEventListener('click', () => {
                // é‡ç½®è¼¸å…¥æ¡†å…§å®¹
                loadTitle();
                toggleTitleEdit(false);
            });
            
            // åˆå§‹åŒ– LocalStorage é è¨­å€¼ (å¦‚æœæ²’æœ‰çš„è©±)
            if (!localStorage.getItem(checklistKey)) {
                setLocalStorage(checklistKey, initialChecklist);
            }

            // Itinerary Modal Listeners
            const itineraryModal = document.getElementById('itinerary-modal');
            if (itineraryModal) {
                // ç¶å®šå„²å­˜æŒ‰éˆ•
                document.getElementById('itinerary-form').addEventListener('submit', handleItineraryItemSave);
                // ç¶å®šå–æ¶ˆæŒ‰éˆ•
                document.getElementById('modal-cancel-btn').addEventListener('click', () => {
                    itineraryModal.classList.add('hidden');
                });
            }
        });

    </script>

  </div>

    <!-- Photo Lightbox -->
    <div id="photo-lightbox" class="fixed inset-0 z-[60] hidden">
        <div id="photo-lightbox-backdrop" class="absolute inset-0 bg-black/80"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="relative flex items-center justify-center">
                <img id="photo-lightbox-img" src="" alt="preview" class="max-w-[90vw] max-h-[80vh] w-auto h-auto rounded-xl shadow-2xl border border-white/10 bg-white" />

                <button id="photo-lightbox-prev" type="button"
                        class="absolute -left-3 sm:-left-14 top-1/2 -translate-y-1/2 px-3 py-2 rounded-full text-white border border-white/30 bg-black/20 hover:bg-black/40">
                    <i class="fas fa-chevron-left"></i>
                </button>

                <button id="photo-lightbox-next" type="button"
                        class="absolute -right-3 sm:-right-14 top-1/2 -translate-y-1/2 px-3 py-2 rounded-full text-white border border-white/30 bg-black/20 hover:bg-black/40">
                    <i class="fas fa-chevron-right"></i>
                </button>

                <button id="photo-lightbox-close" type="button"
                        class="absolute -top-3 -right-3 sm:-top-10 sm:-right-10 px-3 py-2 rounded-full text-white border border-white/30 bg-black/20 hover:bg-black/40">
                    <i class="fas fa-times"></i>
                </button>

                <div id="photo-lightbox-indicator" class="absolute -bottom-8 left-1/2 -translate-x-1/2 text-white text-sm opacity-90"></div>
            </div>
        </div>
    </div>

</body>
</html>