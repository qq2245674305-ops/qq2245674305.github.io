<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ“åœ‹ä¹‹æ—…ï¼šè¦ªå‹æ—…éŠå°å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* è¨­ç½®å…¨åŸŸå­—é«”ç‚º Noto Sans TC */
        /* === æ›´æ–°ç‚ºæ–°çš„é¡è‰²é…ç½® === */
        :root {
            --color-bg-primary: #faf8f5; /* ä¿æŒæ¥µæ·ºåº•è‰² */
            --color-bg-card: #ffffff; /* ç´”ç™½ */
            --color-text-main: #514378; /* æ·±ç´« (Primary Text/Dark Contrast) */
            --color-accent: #EBC79A; /* æš–é‡‘è‰² (Main Accent/Headers) */
            --color-divider: #eac9b8; /* æŸ”å’Œç²‰è‰² (Soft Divider/Border) */
            --color-highlight: #F8D77A; /* ç¶“å…¸æš–é»ƒ (Highlight/Important Time) */
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--color-bg-primary);
            color: var(--color-text-main);
            padding-bottom: 4rem; /* åº•éƒ¨ç©ºé–“ç•™çµ¦å°èˆªåˆ— */
            line-height: 1.6;
        }

        /* å°èˆªåˆ—æ¨£å¼ */
        .nav-item {
            color: var(--color-text-main);
            transition: color 0.2s, background-color 0.2s;
        }
        .nav-item.active {
            color: var(--color-text-main); /* å°èˆªé¸ä¸­æ™‚ä½¿ç”¨æ·±ç´« */
            background-color: var(--color-highlight);
            border-radius: 8px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .muji-card {
            background-color: var(--color-bg-card);
            border: 1px solid var(--color-divider);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.03);
            transition: transform 0.1s;
        }

        /* æŒ‰éˆ•é€šç”¨æ¨£å¼ */
        .muji-btn {
            background-color: var(--color-text-main); /* ä½¿ç”¨æœ€æ·±çš„é¡è‰²ä½œæŒ‰éˆ•èƒŒæ™¯ï¼Œç¢ºä¿å¯è¦–æ€§ */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .muji-btn:hover {
            background-color: #3d3151; /* Slightly darker deep purple */
        }
        .muji-btn-light {
             background-color: var(--color-bg-primary);
             color: var(--color-text-main);
             border: 1px solid var(--color-divider);
        }

        /* æ™‚é–“è»¸ç·šæ¢ */
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--color-divider);
        }
        .timeline-dot {
            position: absolute;
            left: 14px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: var(--color-text-main);
            border: 2px solid var(--color-bg-primary);
            z-index: 10;
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="sticky top-0 z-20 bg-white shadow-md p-4 flex justify-between items-center border-b" style="border-color: var(--color-divider);">
        <h1 class="text-xl font-bold" style="color: var(--color-text-main);">ğŸ‡°ğŸ‡· é¦–çˆ¾è¼•æ—…è¡Œ</h1>
        <div id="current-exchange-rate" class="text-sm font-medium px-3 py-1 rounded-full" style="background-color: var(--color-bg-primary); color: var(--color-text-main);">
            KRW/TWD: -
        </div>
    </header>

    <main id="app-content" class="p-4 pt-6 max-w-xl mx-auto">
        </main>

    <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-30">
        <nav class="flex justify-around items-center h-16 max-w-xl mx-auto">
            <button class="nav-item flex flex-col items-center p-2 active" data-tab="FLIGHTS_STAY">
                <i class="fas fa-plane text-xl"></i>
                <span class="text-xs mt-1">èˆªç­ä½å®¿</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-tab="ITINERARY">
                <i class="fas fa-calendar-alt text-xl"></i>
                <span class="text-xs mt-1">è¡Œç¨‹è¡¨</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-tab="GUIDE">
                <i class="fas fa-map-marked-alt text-xl"></i>
                <span class="text-xs mt-1">å°è¦½</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-tab="WALLET">
                <i class="fas fa-calculator text-xl"></i>
                <span class="text-xs mt-1">è¨˜å¸³</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-tab="LISTS">
                <i class="fas fa-list-check text-xl"></i>
                <span class="text-xs mt-1">æ¸…å–®</span>
            </button>
            <button class="nav-item flex flex-col items-center p-2" data-tab="INFO">
                <i class="fas fa-info-circle text-xl"></i>
                <span class="text-xs mt-1">è³‡è¨Š</span>
            </button>
        </nav>
    </footer>

    <script>
        // --- å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ–è³‡æ–™ ---
        const APP_ID = 'KR_TRIP_APP'; // LocalStorage å‘½åç©ºé–“
        const exchangeRateKey = `${APP_ID}_EXCHANGE_RATE`;
        const expensesKey = `${APP_ID}_EXPENSES`;
        const checklistKey = `${APP_ID}_CHECKLIST`;
        const memoKey = `${APP_ID}_MEMO`;

        let currentRate = 0.024; // é è¨­éŸ“å…ƒåˆ°å°å¹£åŒ¯ç‡ (å¯èª¿æ•´)
        const TWD_SYMBOL = 'NT$';

        // æ ¸å¿ƒè¡Œç¨‹æ•¸æ“š - å·²æ›´æ–°èˆªç­èˆ‡é¤å»³è³‡è¨Šï¼Œä¸¦åŠ å…¥ç‡Ÿæ¥­æ™‚é–“èˆ‡åœ°å€
        const tripData = {
            flights: "å»ç¨‹ï¼š2026/2/13 è¯èˆªCI164 é«˜é›„-ä»å· (07:10 - 10:55)ï¼›å›ç¨‹ï¼š2026/2/21 è¯èˆªCI165 ä»å·-é«˜é›„ (12:00 - 14:10)",
            accommodation: [
                // [0] å¤§è‡ªç„¶éŸ“å±‹æ—…é¤¨
                { date: "2/13 - 2/15", name: "å¤§è‡ªç„¶éŸ“å±‹æ—…é¤¨ (Dajayon Hanok Stay)", address: "81-3, Yulgok-ro 10-gil, Jongro-gu, é˜è·¯, é¦–çˆ¾, éŸ“åœ‹", mapLink: "https://www.google.com/maps/place/Dajayon+Hanok+Stay/data=!4m2!3m1!1s0x357ca352a7cdd2d5:0x5c2a92c61f4e3531?sa=X&ved=1t:242&ictx=111" },
                // [1] Airbnb
                { date: "2/15 - 2/21", name: "Airbnb æ—…é¤¨ (éº»æµ¦å€)", address: "29 Dohwa 2-gil, Dohwa-dong, Mapo-gu, Seoul, South Korea", mapLink: "https://www.google.com/maps/place/29+Dohwa+2-gil,+Mapo-gu,+Seoul,+%E5%8D%97%E9%9F%93/@37.5394541,126.9496077,17z/data=!3m1!4b1!4m6!3m5!1s0x357c98a8a4569029:0x95d15235dbbefdfc!8m2!3d37.5394541!4d126.9496077!16s%2Fg%2F11bzgc92fl?entry=ttu&g_ep=EgoyMDI1MTEyMy4xIKXMDSoASAFQAw%3D%3D" }
            ],
            itinerary: [
                { date: "2/13 (äº”)", items: [
                    { time: "ä¸­åˆå‰", name: "æŠµé”ä»å·ã€åŒ…è»Šè‡³ä½å®¿é»", type: "Travel", highlight: true, notes: "CI164 é è¨ˆ 10:55 æŠµé”ï¼Œç›´æ¥æ­è»Šå‰å¾€å¸‚å€" },
                    // UPDATED 1: åŒ—æ‘å¤§ç“¦æˆ¿é†¬èŸ¹
                    { time: "åˆé¤", name: "í°ê¸°ì™€ì§‘(å¤§ç“¦æˆ¿é†¬èŸ¹-åŒ—æ‘)", type: "Food", notes: "ç±³å…¶æ—ä¸€æ˜Ÿ", link: "https://maps.app.goo.gl/cnKvroKdRau3itxz5", hours: "æ¯æ—¥ 12:00â€“21:00 (å¹³æ—¥ä¼‘æ¯ 15:00â€“17:00)", address_copy: "ì„œìš¸ ì¢…ë¡œêµ¬ ë¶ì´Œë¡œ 22 1ì¸µ" },
                    // UPDATED 2: æ˜æ´å¤§ä½¿é¤¨æ›éŒ¢
                    { time: "ä¸‹åˆ", name: "ëŒ€ì‚¬ê´€ì•í™˜ì „ (æ˜æ´å¤§ä½¿é¤¨æ›éŒ¢)", type: "Activity", hours: "æ¯æ—¥ 09:00â€“20:00", address_copy: "ì„œìš¸ ì¤‘êµ¬ ëª…ë™2ê¸¸ 26" },
                    { time: "ä¸‹åˆ", name: "æ˜æ´é€›è¡—", type: "Activity" },
                    // UPDATED 3: æœæœåˆ€å‰Šéºµ
                    { time: "æ™šé¤", name: "ì¡°ì¡°ì¹¼êµ­ìˆ˜ ì‹œì²­ì  (æœæœåˆ€å‰Šéºµ å¸‚æ”¿å»³åº—)", type: "Food", link: "https://maps.app.goo.gl/3A2X4Y8k2T5eP8wQ7", hours: "æ¯æ—¥ 11:00â€“21:00 (ä¼‘æ¯æ™‚é–“ 15:00â€“17:00)", address_copy: "27 Sejong-daero 11-gil, Jung District, Seoul, å—éŸ“" }
                ]},
                { date: "2/14 (å…­)", items: [
                    // CHANGE 1: æ˜æœˆæ ¼éŸ“æœè£é«® -> æ˜æœˆé–£éŸ“æœ + åœ°å€ + å‚™è¨»
                    { time: "08:30", name: "æ˜æœˆé–£éŸ“æœ", type: "Activity", highlight: true, address_copy: "ì„œìš¸ ì¢…ë¡œêµ¬ ì‚¬ì§ë¡œ 105 1ì¸µ", notes: "æœè£ä»˜ç¾5è¬~10è¬ä¸ç­‰ï¼Œå«å¸½æ‰‡é‹ï¼Œå¥³ç”Ÿç·¨é«®é…é£¾ï¼›è¥ªå­è‡ªå‚™ï¼ˆå»ºè­°ç™½è¥ªï¼‰åŒ–å¦å¦åŠ åƒ¹" },
                    // CHANGE 2: æ™¯ç¦å®®éŸ“æœæ‹ç…§ -> æ™¯ç¦å®®-äºè³“æ”å½±å¸« + æ™‚é–“ + åœ°å€
                    { time: "10:30-12:00", name: "æ™¯ç¦å®®-äºè³“æ”å½±å¸«", type: "Activity", link: "https://maps.app.goo.gl/3hJ5D7NqZ4pLg6F8A", address_copy: "æ™¯ç¦å®®" },
                    // UPDATED 4: åœŸä¿—æ‘è”˜é›æ¹¯
                    { time: "åˆé¤", name: "í† ì†ì´Œ ì‚¼ê³„íƒ• (åœŸä¿—æ‘è”˜é›æ¹¯)", type: "Food", link: "https://maps.app.goo.gl/5z4B1wUuLu6eK8tY8", naver_link: "https://naver.me/FM6Bdfws", hours: "æ¯æ—¥ 10:00â€“22:00", address_copy: "5 Jahamun-ro 5-gil, JongnoDistrict, Seoul, å—éŸ“" },
                    // CHANGE 3: å¤å®®åšç‰©é¤¨ - æ–°å¢ Google Map Link
                    { time: "ä¸‹åˆ", name: "å¤å®®åšç‰©é¤¨", type: "Sightseeing", link: "https://maps.app.goo.gl/Go5HUp6HtZwzct8W6" },
                    { time: "ä¸‹åˆ", name: "æ­·å²åšç‰©é¤¨", type: "Sightseeing" },
                    { time: "æ™šé¤", name: "ê³„ë¦¼ è¾£é›æ¹¯ (Gyerim)", type: "Food", notes: "åœ°å€: ì„œìš¸ ì¢…ë¡œêµ¬ ëˆí™”ë¬¸ë¡œ4ê¸¸ 39", link: "https://maps.app.goo.gl/A7F8U3x5L9JpY4kC9" }
                ]},
                { date: "2/15 (æ—¥)", items: [
                    { time: "ä¸Šåˆ", name: "åŒ—æ‘é€›è¡—", type: "Activity" },
                    { time: "ä¸‹åˆ", name: "æ›ä½å®¿ (é·å¾€ Airbnb)", type: "Travel", highlight: true },
                    { time: "ä¸‹åˆ", name: "å¼˜å¤§é€›è¡—", type: "Activity" },
                    // CHANGE 4: å¼˜å¤§çƒ¤é°»é­š -> é¢¨å·é°»é­š-å»¶å—åº—
                    { time: "æ™šé¤", name: "í’ì²œì¥ì–´(é¢¨å·é°»é­š-å»¶å—åº—)", type: "Food", hours: "æ¯æ—¥ 11:30â€“22:00", address_copy: "ì„œìš¸ ë§ˆí¬êµ¬ ë™êµë¡œ27ê¸¸ 39" }
                ]},
                { date: "2/16 (ä¸€)", items: [
                    { time: "å…¨å¤©", name: "åŒ…è»Š: å—æ€¡å³¶, ä¸‰å²³å±±çºœè»Š", type: "Sightseeing", highlight: true, link: "https://maps.app.goo.gl/5tY8H7kG6R9pV2wD8" }
                ]},
                { date: "2/17 (äºŒ)", items: [
                    // CHANGE 5: DMZ ä¸€æ—¥éŠ - æ™‚é–“ + é›†åˆåœ°å€ + å‚™è¨»
                    { time: "07:30 - 14:30", name: "DMZ ä¸€æ—¥éŠ", type: "Sightseeing", highlight: true, address_copy: "58 Mapo-daero, Mapo-gu, Seoul", notes: "6:10åˆ†é¦–çˆ¾èŠ±åœ’é£¯åº—(ì„œìš¸ê°€ë“ í˜¸í…”)é›†åˆã€‚é›†åˆæ™‚é–“ç‚ºæ—©ä¸Š 6:20 æ–¼é¦–çˆ¾èŠ±åœ’é£¯åº—ã€‚æ—…éŠç„¡ç‰¹æ®Šæœè£è¦æ±‚ï¼ˆå»ºè­°ç©¿è‘—èˆ’é©é‹å­ï¼‰ã€‚åƒåœ˜é ˆæ”œå¸¶è­·ç…§ï¼ˆç¾è»èº«åˆ†è­‰æˆ– ARC äº¦å¯ï¼‰ã€‚è«‹æº–æ™‚ï¼ˆè«‹è‡³å°‘ææ—© 5 åˆ†é˜åˆ°é”ã€‚å·´å£«å°‡æº–æ™‚ç™¼è»Šï¼Œä¸æœƒç­‰å€™é²åˆ°è€…ï¼‰ã€‚" }
                ]},
                { date: "2/18 (ä¸‰)", items: [
                    // CHANGE 6: æœ›é å¸‚å ´ - Google Map Link æ›´æ–°
                    { time: "ä¸Šåˆ", name: "æœ›é å¸‚å ´", type: "Activity", link: "https://maps.app.goo.gl/45jDJ58foJvAi8tWA" },
                    { time: "ä¸‹åˆ", name: "é¦–çˆ¾ç«™æ¨‚å¤©è¶…å¸‚", type: "Shopping" }
                ]},
                { date: "2/19 (å››)", items: [
                    { time: "å…¨å¤©", name: "åŒ…è»Š: å¤§é—œå¶º ä¸‰é¤Šç‰§å ´, éŸ“åœ‹æ±ŸåŸé“æœˆç²¾å¯º", type: "Sightseeing", highlight: true, link: "https://maps.app.goo.gl/H5J8K7oL6M2nT4xP9" }
                ]},
                { date: "2/20 (äº”)", items: [
                    { time: "å…¨å¤©", name: "è‡ªç”±æ´»å‹•", type: "Activity" }
                ]},
                { date: "2/21 (å…­)", items: [
                    { time: "09:00", name: "é€€æˆ¿ä¸¦å‰å¾€ä»å·æ©Ÿå ´", type: "Travel", highlight: true, notes: "CI165 12:00 èµ·é£›ï¼Œè«‹é ç•™å……è¶³æ™‚é–“è¾¦ç†ç™»æ©Ÿæ‰‹çºŒ" },
                    { time: "12:00", name: "è¯èˆªCI165 ä»å·-é«˜é›„", type: "Travel", highlight: true }
                ]},
            ],
            guide_spots: [
                { name: "æ™¯ç¦å®®", intro: "æ™¯ç¦å®®æ˜¯æœé®®ç‹æœï¼ˆ1392-1897å¹´ï¼‰çš„æ­£å®®ï¼Œæ„ç‚ºã€Œå¤§å‰å¤§åˆ©ã€ç¦ç¥¿ç¶¿é•·ã€ã€‚å®ƒå»ºæ–¼1395å¹´ï¼Œæ˜¯éŸ“åœ‹äº”å¤§å®®ê¶ä¸­è¦æ¨¡æœ€å¤§ã€å»ºç¯‰è¨­è¨ˆæœ€ç²¾ç¾çš„ã€‚æœ€è‘—åçš„å‹¤æ”¿æ®¿æ˜¯ç”¨æ–¼åœ‹å®¶å„€å¼å’Œæ¥è¦‹å¤–åœ‹ä½¿ç¯€çš„åœ°æ–¹ï¼Œè€Œé¦™é äº­å‰‡æ˜¯æ¹–ç•”çš„å„ªç¾äº­é–£ã€‚å†·çŸ¥è­˜ï¼šåœ¨æ—¥æ²»æ™‚æœŸï¼Œå®®æ®¿çš„å¤§éƒ¨åˆ†è¢«æ¯€æï¼Œç¾ä»Šæ‰€è¦‹æ˜¯å¤šå¹´ä¾†ä¿®å¾©çš„çµæœï¼Œé«”ç¾äº†éŸ“åœ‹å°æ­·å²çš„å …å®ˆèˆ‡å¾©èˆˆã€‚", map: { lat: 37.58, lng: 126.98 } },
                { name: "DMZ éè»äº‹å€", intro: "DMZï¼ˆDemilitarized Zoneï¼‰æ˜¯åˆ†éš”å—åŒ—éŸ“çš„ç·©è¡å€ï¼Œé•·ç´„250å…¬é‡Œï¼Œå¯¬ç´„4å…¬é‡Œã€‚é›–ç„¶åç‚ºéè»äº‹å€ï¼Œä½†å®ƒæ˜¯ä¸–ç•Œä¸Šè»äº‹åŒ–ç¨‹åº¦æœ€é«˜çš„åœ°å€ä¹‹ä¸€ã€‚é€™è£åŒæ™‚ä¹Ÿæ˜¯ä¸€å€‹ç”Ÿæ…‹å¤©å ‚ï¼Œå› ç‚ºäººé¡æ´»å‹•çš„é™åˆ¶ï¼Œæˆç‚ºäº†è¨±å¤šçç¨€é‡ç”Ÿå‹•æ¤ç‰©çš„æ£²æ¯åœ°ã€‚åƒè§€è¡Œç¨‹é€šå¸¸åŒ…æ‹¬æ¿é–€åº—ã€ç¬¬ä¸‰åœ°é“å’Œéƒ½ç¾…å±•æœ›å°ã€‚å†·çŸ¥è­˜ï¼šDMZ å…§éƒ¨æœ‰ä¸€å€‹åç‚ºã€Œå’Œå¹³ä¹‹æ‘ã€ï¼ˆå¤§æˆæ´ï¼‰çš„æ‘èŠï¼Œæ˜¯å”¯ä¸€å…è¨±å¹³æ°‘å±…ä½åœ¨DMZå…§çš„ç‰¹ä¾‹ã€‚", map: { lat: 37.93, lng: 126.70 } },
            ]
        };

        // åˆå§‹æ¸…å–®æ•¸æ“š
        const initialChecklist = [
            { id: 1, text: "è­·ç…§", checked: false },
            { id: 2, text: "esim (æˆ–å¯¦é«” SIM å¡)", checked: false },
            { id: 3, text: "å°å¹£ (ç”¨æ–¼æ›éŸ“å¹£)", checked: false },
            { id: 4, text: "ç¾½çµ¨å¤–å¥—", checked: false },
            { id: 5, text: "è²¼èº«ä¿æš–è¡£ç‰© (ç™¼ç†±è¡£)", checked: false },
            { id: 6, text: "å¸½å­, æ‰‹å¥—", checked: false },
            { id: 7, text: "æ—…éŠå¸¸å‚™è—¥ (æ„Ÿå†’ã€è…¸èƒƒè—¥)", checked: false },
            { id: 8, text: "ä¿å¥é£Ÿå“", checked: false },
            { id: 9, text: "å€‹äººç›¥æ´—ç”¨å“", checked: false },
            { id: 10, text: "åŒ–å¦å“, ä¿é¤Šå“, å¸å¦", checked: false },
            { id: 11, text: "å‡¡å£«æ—, å”‡è†, èº«é«”ä¹³ (éŸ“åœ‹è¼ƒä¹¾ç‡¥)", checked: false },
        ];


        // --- LocalStorage è®€å¯«å·¥å…· ---
        function getLocalStorage(key, defaultValue) {
            const data = localStorage.getItem(key);
            try {
                return data ? JSON.parse(data) : defaultValue;
            } catch (e) {
                console.error(`Error parsing LocalStorage key ${key}`, e);
                return defaultValue;
            }
        }

        function setLocalStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error(`Error setting LocalStorage key ${key}`, e);
            }
        }
        
        // --- é€šç”¨å‰ªè²¼ç°¿è¤‡è£½åŠŸèƒ½ ---
        function copyTextToClipboard(text, message) {
            try {
                // ä½¿ç”¨ document.execCommand('copy') ä½œç‚º iframe ç’°å¢ƒçš„é¦–é¸æ–¹æ³•
                const tempInput = document.createElement('textarea');
                tempInput.value = text;
                // è®“ textarea ä¸å¯è¦‹ä½†å¯é¸ä¸­
                tempInput.style.position = 'absolute';
                tempInput.style.left = '-9999px';
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                alertModal(message || 'åœ°å€å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            } catch (err) {
                console.error('Could not copy text: ', err);
                alertModal('ç„¡æ³•è¤‡è£½ï¼Œè«‹æ‰‹å‹•è¤‡è£½: ' + text);
            }
        }

        // --- åŒ¯ç‡èˆ‡è²»ç”¨è¨ˆç®—å·¥å…· ---
        function loadInitialData() {
            // åŠ è¼‰ä¸¦é¡¯ç¤ºåŒ¯ç‡
            currentRate = getLocalStorage(exchangeRateKey, 0.024);
            updateRateDisplay();
        }

        function updateRateDisplay() {
            const display = document.getElementById('current-exchange-rate');
            if (display) {
                display.textContent = `KRW/TWD: ${currentRate.toFixed(4)}`;
            }
        }

        function krwToTwd(krw) {
            return (krw * currentRate).toFixed(0);
        }

        // --- å½±åƒå£“ç¸®èˆ‡ Base64 è™•ç† ---
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const MAX_WIDTH = 300; // ç¸®åœ–æœ€å¤§å¯¬åº¦
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // è¼¸å‡ºç‚º Base64 (JPEG, ç•«è³ª 70%)
                    const dataURL = canvas.toDataURL('image/jpeg', 0.7);
                    callback(dataURL);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- å°èˆªèˆ‡å…§å®¹æ¸²æŸ“ ---
        function changeTab(tabName) {
            const content = document.getElementById('app-content');
            const navItems = document.querySelectorAll('.nav-item');

            // ç§»é™¤èˆŠçš„ active ç‹€æ…‹
            navItems.forEach(item => item.classList.remove('active'));

            // è¨­ç½®æ–°çš„ active ç‹€æ…‹
            const activeNav = document.querySelector(`.nav-item[data-tab="${tabName}"]`);
            if (activeNav) {
                activeNav.classList.add('active');
            }

            content.innerHTML = ''; // æ¸…ç©ºå…§å®¹
            window.scrollTo(0, 0); // å›åˆ°é ‚éƒ¨

            // æ ¹æ“š tabName æ¸²æŸ“å…§å®¹
            switch (tabName) {
                case 'FLIGHTS_STAY':
                    renderFlightsStayTab(content);
                    break;
                case 'ITINERARY':
                    renderItineraryTab(content);
                    break;
                case 'GUIDE':
                    renderGuideTab(content);
                    break;
                case 'WALLET':
                    renderWalletTab(content);
                    break;
                case 'LISTS':
                    renderListsTab(content);
                    break;
                case 'INFO':
                    renderInfoTab(content);
                    break;
            }
        }
        
        // --- Tab: FLIGHTS_STAY (èˆªç­èˆ‡ä½å®¿) æ¸²æŸ“ (ä¸è®Š) ---
        function renderFlightsStayTab(container) {
            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">âœˆï¸ èˆªç­èˆ‡ä½å®¿ç¸½è¦½</h2>

                <div class="muji-card p-4 mb-6">
                    <h3 class="text-xl font-bold mb-3 flex items-center" style="color: var(--color-text-main);">
                        <i class="fas fa-plane-departure mr-2 text-2xl" style="color: var(--color-accent);"></i> å‡ºå…¥å¢ƒèˆªç­
                    </h3>
                    <div class="text-sm p-3 rounded" style="background-color: var(--color-bg-primary);">
                        <p class="font-medium mb-2">${tripData.flights.split('ï¼›')[0].replace('å»ç¨‹ï¼š', 'ğŸ›« å»ç¨‹:')}</p>
                        <p class="font-medium">${tripData.flights.split('ï¼›')[1].replace('å›ç¨‹ï¼š', 'ğŸ›¬ å›ç¨‹:')}</p>
                    </div>
                    <div class="text-xs text-gray-500 mt-3 p-2 rounded border" style="border-color: var(--color-divider);">
                        è«‹æ³¨æ„ï¼šå»ç¨‹CI164é è¨ˆ10:55æŠµé”ä»å·ï¼›å›ç¨‹CI165ç‚º12:00èµ·é£›ï¼Œè«‹å‹™å¿…é ç•™å……è¶³äº¤é€šèˆ‡å ±åˆ°æ™‚é–“ã€‚
                    </div>
                </div>

                <div class="muji-card p-4 mb-6">
                    <h3 class="text-xl font-bold mb-3 flex items-center" style="color: var(--color-text-main);">
                        <i class="fas fa-bed mr-2 text-2xl" style="color: var(--color-accent);"></i> ä½å®¿åœ°é» (å…± ${tripData.accommodation.length} è™•)
                    </h3>
                    
                    ${tripData.accommodation.map((acc, index) => `
                        <div class="text-base mb-4 p-3 rounded-lg border-l-4" style="border-color: var(--color-highlight); background-color: var(--color-bg-primary);">
                            <p class="font-bold text-lg mb-1" style="color: var(--color-text-main);">
                                <span class="text-sm font-normal p-1 mr-1 rounded" style="background-color: var(--color-accent); color: white;">${acc.date}</span> ${acc.name}
                            </p>
                            <p class="text-sm text-gray-600">${acc.address}</p>
                            <a href="${acc.mapLink}" target="_blank" class="muji-btn-light text-xs mt-2 px-2 py-1 inline-flex items-center hover:shadow-md">
                                <i class="fas fa-location-dot mr-1"></i> æŸ¥çœ‹åœ°åœ– / å°èˆª
                            </a>
                        </div>
                    `).join('')}
                </div>
            `;
            container.innerHTML = html;
        }

        // --- Tab: ITINERARY (æ¯æ—¥è¡Œç¨‹è¡¨) æ¸²æŸ“ ---
        function renderItineraryTab(container) {
            
            // æ ¹æ“šæ—¥æœŸå–å¾—ä½å®¿è³‡è¨Š
            function getAccommodation(dateStr) {
                // å¾ "2/13 (äº”)" ä¸­æå–æ—¥æœŸæ•¸å­— (13)
                const dateParts = dateStr.match(/(\d+)\/(\d+)/);
                const dayValue = dateParts ? parseInt(dateParts[2], 10) : 0;
                
                // ä½å®¿è³‡è¨Šç´¢å¼•
                const hanokStay = tripData.accommodation[0]; // 2/13 - 2/14
                const airbnb = tripData.accommodation[1];    // 2/15 - 2/21

                if (dayValue >= 13 && dayValue <= 14) {
                    return hanokStay;
                } else if (dayValue >= 15 && dayValue <= 21) {
                    return airbnb;
                }
                return { name: "æœªçŸ¥ä½å®¿", address: "æœªçŸ¥åœ°é»", mapLink: "#" };
            }

            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">ğŸ—“ï¸ æ¯æ—¥è¡Œç¨‹ç´°ç¯€</h2>

                <p class="text-sm mb-6 text-gray-600">è¡Œç¨‹ä»¥æ™‚é–“è»¸æ–¹å¼å‘ˆç¾ï¼Œæ–¹ä¾¿æŸ¥çœ‹æ¯æ—¥æ´»å‹•èˆ‡é¤å»³åœ°é»ã€‚</p>
                
                ${tripData.itinerary.map(day => {
                    // å–å¾—ç•¶å¤©ä½å®¿è³‡è¨Š
                    const currentAccommodation = getAccommodation(day.date);

                    // ä½¿ç”¨æ–°çš„æš–é»ƒè‰²ä½œç‚ºä½å®¿èƒŒæ™¯
                    const accommodationHtml = `
                        <div class="mt-4 pt-4 border-t border-dashed" style="border-color: var(--color-divider);">
                            <h5 class="text-sm font-bold p-1 rounded inline-flex items-center" style="background-color: var(--color-highlight); color: var(--color-text-main);">
                                <i class="fas fa-bed mr-1 text-base"></i> ç•¶æ™šä½å®¿ï¼š${currentAccommodation.name}
                            </h5>
                            <p class="text-xs text-gray-600 mt-1">${currentAccommodation.address}</p>
                            <a href="${currentAccommodation.mapLink}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800">
                                <i class="fas fa-location-dot mr-1"></i>æŸ¥çœ‹åœ°åœ–
                            </a>
                        </div>
                    `;

                    return `
                        <div class="mb-8 p-3 muji-card">
                            <h4 class="text-lg font-bold text-white p-2 rounded-t-lg mb-4" style="background-color: var(--color-accent);">
                                ${day.date}
                            </h4>
                            <div class="relative pl-8">
                                ${day.items.map((item, index) => {
                                    // é«˜äº®é …ç›®ä½¿ç”¨ç¶“å…¸æš–é»ƒè‰²
                                    const highlightStyle = item.highlight ? `background-color: var(--color-highlight); font-weight: bold; color: var(--color-text-main);` : '';
                                    const dotClass = item.highlight ? 'bg-red-500' : 'bg-gray-400';
                                    
                                    // åˆ¤æ–· Naver Map é€£çµï¼Œå„ªå…ˆä½¿ç”¨è‡ªè¨‚ï¼Œå…¶æ¬¡ç”¨åœ°å€ï¼Œæœ€å¾Œç”¨åç¨±æœå°‹
                                    const naverLink = item.naver_link || (item.address_copy ? `https://map.naver.com/v5/search/${encodeURIComponent(item.address_copy)}` : `https://map.naver.com/v5/search/${encodeURIComponent(item.name)}`);

                                    const itemLink = (item.link || item.naver_link || item.type === 'Food' || item.type === 'Activity') ? `
                                        <div class="mt-2 flex flex-wrap gap-2">
                                            ${item.link ? `
                                                <a href="${item.link}" target="_blank" class="muji-btn-light text-xs px-2 py-1 flex items-center hover:shadow-md">
                                                    <i class="fas fa-map-pin mr-1"></i> Google Map
                                                </a>
                                            ` : ''}
                                            <a href="${naverLink}" target="_blank" class="muji-btn-light text-xs px-2 py-1 flex items-center hover:shadow-md">
                                                <i class="fas fa-map mr-1"></i> Naver Map
                                            </a>
                                            <a href="https://www.google.com/search?q=${encodeURIComponent(item.name)} é£Ÿè¨˜" target="_blank" class="muji-btn-light text-xs px-2 py-1 flex items-center hover:shadow-md">
                                                <i class="fas fa-utensils mr-1"></i> é£Ÿè¨˜/ä»‹ç´¹
                                            </a>
                                        </div>
                                    ` : '';

                                    return `
                                        <div class="timeline-item relative pb-6 ml-3">
                                            <div class="timeline-dot ${dotClass} ${item.highlight ? 'ring-4' : ''}" style="border-color: var(--color-divider); background-color: ${item.highlight ? 'var(--color-text-main)' : 'var(--color-divider)'}; top: 2px; ${item.highlight ? 'box-shadow: 0 0 0 3px var(--color-highlight);' : ''}"></div>
                                            <div class="ml-4 pl-4 border-l" style="border-color: var(--color-divider);">
                                                <p class="text-sm font-medium p-1 rounded inline-block" style="${highlightStyle}">${item.time}</p>
                                                <p class="text-base font-semibold mt-1" style="color: var(--color-text-main);">${item.name}</p>
                                                <p class="text-xs text-gray-500">${item.notes || item.type}</p>
                                                
                                                ${item.hours || item.address_copy ? `
                                                    <div class="mt-2 p-3 rounded-lg border-l-2" style="border-color: var(--color-accent); background-color: var(--color-bg-primary);">
                                                        ${item.hours ? `<p class="text-xs text-gray-700 mb-1"><i class="far fa-clock mr-1 text-sm" style="color: var(--color-text-main);"></i> ç‡Ÿæ¥­æ™‚é–“: <span class="font-medium">${item.hours}</span></p>` : ''}
                                                        ${item.address_copy ? `
                                                            <div class="mt-2 pt-2 border-t border-dashed" style="border-color: var(--color-divider);">
                                                                <p class="text-xs font-medium mb-1" style="color: var(--color-text-main);">åœ°å€ (ä¸€éµè¤‡è£½):</p>
                                                                <div class="flex items-center space-x-2">
                                                                    <p class="text-xs text-gray-600 font-mono break-all flex-1">${item.address_copy}</p>
                                                                    <button onclick="copyTextToClipboard(this.previousElementSibling.textContent)" class="muji-btn-light text-xs px-2 py-1 flex items-center shrink-0 hover:shadow-md">
                                                                        <i class="fas fa-copy"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                ` : ''}

                                                ${itemLink}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${accommodationHtml}
                        </div>
                    `;
                }).join('')}
            `;
            container.innerHTML = html;
        }

        // --- Tab: GUIDE (æ·±åº¦å°è¦½) æ¸²æŸ“ (ä¸è®Š) ---
        function renderGuideTab(container) {
            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">ğŸ“– æ·±åº¦å°è¦½èˆ‡æ—…éŠæ‰‹å†Š</h2>
                <p class="text-sm mb-6 text-gray-600">æä¾›é‡é»æ™¯é»çš„æ­·å²èƒŒæ™¯èˆ‡å†·çŸ¥è­˜ï¼Œæ’ç‰ˆæ¨¡æ“¬é›œèªŒé¢¨æ ¼ï¼Œè®“é–±è®€æ›´è¼•é¬†ã€‚</p>
                
                ${tripData.guide_spots.map((spot, index) => `
                    <div class="muji-card p-5 mb-8">
                        <div class="flex items-center mb-4">
                            <span class="text-3xl font-serif text-white px-3 py-1 mr-3 rounded" style="background-color: var(--color-accent);">
                                ${index + 1}
                            </span>
                            <h3 class="text-xl font-bold" style="color: var(--color-text-main);">${spot.name}</h3>
                        </div>

                        <div class="p-4 rounded border-l-4" style="background-color: var(--color-bg-primary); border-color: var(--color-divider);">
                            <p class="text-sm italic mb-3" style="color: var(--color-text-main);">#æ­·å²èˆ‡æ–‡åŒ–</p>
                            <p class="text-base whitespace-pre-wrap text-gray-700">${spot.intro}</p>
                        </div>
                        
                        <h4 class="text-lg font-semibold mt-6 mb-3" style="color: var(--color-text-main);">åœ°åœ–ä½ç½® (OpenStreetMap)</h4>
                        <div class="aspect-video overflow-hidden rounded-lg border" style="border-color: var(--color-divider); box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);">
                            <iframe 
                                width="100%" 
                                height="100%" 
                                frameborder="0" 
                                scrolling="no" 
                                marginheight="0" 
                                marginwidth="0" 
                                src="https://www.openstreetmap.org/export/embed.html?bbox=${spot.map.lng - 0.005}%2C${spot.map.lat - 0.003}%2C${spot.map.lng + 0.005}%2C${spot.map.lat + 0.003}&layer=mapnik&marker=${spot.map.lat}%2C${spot.map.lng}" 
                                style="border: 0;">
                            </iframe>
                            <small>
                                <a href="https://www.openstreetmap.org/?mlat=${spot.map.lat}&mlon=${spot.map.lng}#map=16/${spot.map.lat}/${spot.map.lng}" target="_blank" class="text-xs text-gray-500 block text-right mt-1">æŸ¥çœ‹å¤§åœ–</a>
                            </small>
                        </div>
                    </div>
                `).join('')}
            `;
            container.innerHTML = html;
        }


        // --- Tab: WALLET (è¨˜å¸³èˆ‡åŒ¯ç‡) æ¸²æŸ“ (ä¸è®Š) ---
        function renderWalletTab(container) {
            // è¼‰å…¥è¨˜å¸³è³‡æ–™
            let expenses = getLocalStorage(expensesKey, []);

            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">ğŸ’° è¨˜å¸³èˆ‡åŒ¯ç‡ä¸­å¿ƒ</h2>

                <div class="muji-card p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-3" style="color: var(--color-text-main);">åŒ¯ç‡æ›ç®—æ©Ÿ</h3>
                    <div class="flex space-x-2 mb-3">
                        <input type="number" id="rate-input" value="${currentRate.toFixed(4)}" step="0.0001" class="w-1/3 p-2 border rounded-lg focus:ring-1 focus:ring-red-300" placeholder="0.024" style="border-color: var(--color-divider); color: var(--color-text-main);">
                        <button id="set-rate-btn" class="muji-btn text-sm w-2/3">è¨­å®šç•¶å‰ KRW/TWD åŒ¯ç‡</button>
                    </div>

                    <div class="grid grid-cols-4 gap-2 p-3 rounded-lg" style="background-color: var(--color-bg-primary);">
                        <input type="text" id="calc-display" class="col-span-4 text-right text-2xl p-2 mb-2 rounded border font-mono bg-white" value="0" readonly style="border-color: var(--color-divider);">
                        <div id="calc-result" class="col-span-4 text-right text-sm text-gray-500">
                            ${TWD_SYMBOL} <span id="calc-twd-result">0</span>
                        </div>
                        
                        <button class="calc-btn muji-btn-light text-xl" data-value="C" style="background-color: var(--color-divider);">C</button>
                        <button class="calc-btn muji-btn-light text-xl" data-value="back"><i class="fas fa-backspace"></i></button>
                        <button class="calc-btn muji-btn-light text-xl" data-value="/">Ã·</button>
                        <button class="calc-btn muji-btn-light text-xl" data-value="*">Ã—</button>

                        <button class="calc-btn muji-btn text-xl" data-value="7">7</button>
                        <button class="calc-btn muji-btn text-xl" data-value="8">8</button>
                        <button class="calc-btn muji-btn text-xl" data-value="9">9</button>
                        <button class="calc-btn muji-btn-light text-xl" data-value="-">âˆ’</button>

                        <button class="calc-btn muji-btn text-xl" data-value="4">4</button>
                        <button class="calc-btn muji-btn text-xl" data-value="5">5</button>
                        <button class="calc-btn muji-btn text-xl" data-value="6">6</button>
                        <button class="calc-btn muji-btn-light text-xl" data-value="+">&plus;</button>

                        <button class="calc-btn muji-btn text-xl" data-value="1">1</button>
                        <button class="calc-btn muji-btn text-xl" data-value="2">2</button>
                        <button class="calc-btn muji-btn text-xl" data-value="3">3</button>
                        <button class="calc-btn muji-btn-light text-xl row-span-2" data-value="=">=</button>

                        <button class="calc-btn muji-btn text-xl" data-value="00">00</button>
                        <button class="calc-btn muji-btn text-xl" data-value="0">0</button>
                        <button class="calc-btn muji-btn text-xl" data-value=".">.</button>
                    </div>
                </div>

                <div class="muji-card p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-3" style="color: var(--color-text-main);">æ–°å¢ä¸€ç­†é–‹éŠ·</h3>
                    <input type="text" id="expense-item" class="w-full p-2 mb-2 border rounded-lg" placeholder="å“é …åç¨± (e.g. åˆé¤ã€å’–å•¡)" style="border-color: var(--color-divider);">
                    <input type="number" id="expense-krw" class="w-full p-2 mb-2 border rounded-lg" placeholder="éŸ“å¹£é‡‘é¡ (KRW)" style="border-color: var(--color-divider);">
                    
                    <label class="block text-sm font-medium mb-2" style="color: var(--color-text-main);">ä¸Šå‚³æˆ–æ‹ç…§ (å£“ç¸®ç‚ºç¸®åœ–)</label>
                    <input type="file" id="expense-photo" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold" style="--file-bg: var(--color-accent); --file-text: var(--color-text-main);" onMouseOver="this.style.backgroundColor='var(--color-highlight)'" onMouseOut="this.style.backgroundColor='var(--color-bg-primary)'">
                    <div id="photo-preview" class="mt-2 text-center text-sm text-gray-400">ï¼ˆåœ–ç‰‡å£“ç¸®å¾Œä¸æœƒä½”ç”¨å¤ªå¤šå®¹é‡ï¼‰</div>

                    <button id="add-expense-btn" class="muji-btn w-full mt-4">ç´€éŒ„é–‹éŠ·</button>
                </div>

                <h3 class="text-xl font-bold mb-3" style="color: var(--color-text-main);">ğŸ“œ è¨˜å¸³æ­·å²</h3>
                <div id="expense-list-container">
                    ${expenses.length === 0 ? '<p class="text-center text-gray-500 p-4">ç›®å‰æ²’æœ‰è¨˜å¸³ç´€éŒ„ã€‚</p>' : ''}
                </div>
            `;
            container.innerHTML = html;
            setupWalletListeners();
            renderExpenseList();
        }

        // æ¸²æŸ“è¨˜å¸³æ­·å²åˆ—è¡¨ (ä¸è®Š)
        function renderExpenseList() {
            const container = document.getElementById('expense-list-container');
            let expenses = getLocalStorage(expensesKey, []);

            if (!container) return;

            if (expenses.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-4">ç›®å‰æ²’æœ‰è¨˜å¸³ç´€éŒ„ã€‚</p>';
                return;
            }

            // è¨ˆç®—ç¸½é¡
            const totalKRW = expenses.reduce((sum, exp) => sum + exp.krw, 0);
            const totalTWD = krwToTwd(totalKRW);

            let listHtml = `
                <div class="muji-card p-4 mb-4 text-center" style="background-color: var(--color-highlight); border-color: var(--color-accent);">
                    <p class="text-lg font-bold" style="color: var(--color-text-main);">ç¸½è¨ˆèŠ±è²»</p>
                    <p class="text-2xl font-bold my-1" style="color: var(--color-text-main);">${totalKRW.toLocaleString()} KRW</p>
                    <p class="text-md text-gray-500">ç´„ ${TWD_SYMBOL} ${totalTWD.toLocaleString()} TWD</p>
                </div>

                <div class="space-y-3">
                    ${expenses.reverse().map(exp => `
                        <div class="muji-card p-3 flex items-center justify-between border" style="border-color: var(--color-divider);">
                            <div class="flex items-center space-x-3 w-3/4">
                                ${exp.photo ? `<img src="${exp.photo}" alt="æ”¶æ“šç¸®åœ–" class="w-12 h-12 object-cover rounded-md border" style="border-color: var(--color-divider);">` : `<div class="w-12 h-12 flex items-center justify-center bg-gray-100 rounded-md text-gray-400" style="background-color: var(--color-bg-primary);"><i class="fas fa-image"></i></div>`}
                                <div class="truncate">
                                    <p class="font-medium truncate" style="color: var(--color-text-main);">${exp.item}</p>
                                    <p class="text-xs text-gray-500">${new Date(exp.timestamp).toLocaleDateString()} ${new Date(exp.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                                </div>
                            </div>
                            <div class="text-right w-1/4">
                                <p class="text-sm font-semibold" style="color: var(--color-text-main);">${exp.krw.toLocaleString()} KRW</p>
                                <p class="text-xs text-gray-500">${TWD_SYMBOL} ${krwToTwd(exp.krw)}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            container.innerHTML = listHtml;
        }

        // è¨­ç½® Wallet Tab çš„äº‹ä»¶ç›£è½å™¨ (ä¸è®Š)
        function setupWalletListeners() {
            // --- åŒ¯ç‡è¨­å®š ---
            document.getElementById('set-rate-btn').addEventListener('click', () => {
                const input = document.getElementById('rate-input');
                const newRate = parseFloat(input.value);
                if (newRate > 0) {
                    currentRate = newRate;
                    setLocalStorage(exchangeRateKey, newRate);
                    updateRateDisplay();
                    renderExpenseList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°å°å¹£é‡‘é¡
                } else {
                    alertModal("è«‹è¼¸å…¥æœ‰æ•ˆçš„åŒ¯ç‡ã€‚");
                }
            });

            // --- è¨ˆç®—æ©Ÿé‚è¼¯ ---
            const display = document.getElementById('calc-display');
            const twdResult = document.getElementById('calc-twd-result');
            const buttons = document.querySelectorAll('.calc-btn');

            buttons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const value = e.currentTarget.dataset.value;
                    let current = display.value === '0' ? '' : display.value;

                    try {
                        if (value === 'C') {
                            display.value = '0';
                        } else if (value === 'back') {
                            display.value = current.length > 1 ? current.slice(0, -1) : '0';
                        } else if (value === '=') {
                            // åƒ…å…è¨±æ•¸å­—å’ŒåŸºæœ¬é‹ç®—ç¬¦è™Ÿ
                            const safeExpression = current.replace(/[^-()\d/*+. ]/g, '');
                            const krwTotal = eval(safeExpression);
                            if (isNaN(krwTotal) || !isFinite(krwTotal)) throw new Error('Invalid calculation');
                            
                            display.value = Math.floor(krwTotal).toString(); // çµæœå–æ•´æ•¸ (éŸ“å¹£ç„¡å°æ•¸)
                        } else {
                            if (current === '0' && value !== '.') current = '';
                            display.value = current + value;
                        }
                        
                        // å³æ™‚è¨ˆç®— KRW ç¸½é¡ä¸¦æ›ç®— TWD
                        let krwAmount = 0;
                        try {
                            const safeExpression = display.value.replace(/[^-()\d/*+. ]/g, '');
                            krwAmount = eval(safeExpression) || 0;
                        } catch (e) {
                            krwAmount = 0;
                        }

                        twdResult.textContent = krwToTwd(Math.floor(krwAmount));

                    } catch (e) {
                        display.value = 'Error';
                        twdResult.textContent = '0';
                        console.error('Calculator error:', e);
                    }
                });
            });

            // --- è¨˜å¸³åŠŸèƒ½ ---
            const photoInput = document.getElementById('expense-photo');
            let base64Photo = null;

            photoInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    compressImage(file, (dataURL) => {
                        base64Photo = dataURL;
                        const preview = document.getElementById('photo-preview');
                        preview.innerHTML = `<img src="${dataURL}" class="w-20 h-20 object-cover mx-auto rounded-md mt-2 border" style="border-color: var(--color-divider);">`;
                    });
                }
            });

            document.getElementById('add-expense-btn').addEventListener('click', () => {
                const itemInput = document.getElementById('expense-item');
                const krwInput = document.getElementById('expense-krw');

                const item = itemInput.value.trim();
                const krw = parseInt(krwInput.value, 10);

                if (!item || isNaN(krw) || krw <= 0) {
                    alertModal("è«‹è¼¸å…¥æœ‰æ•ˆçš„å“é …åç¨±å’ŒéŸ“å¹£é‡‘é¡ã€‚");
                    return;
                }

                const newExpense = {
                    id: Date.now(),
                    item: item,
                    krw: krw,
                    photo: base64Photo,
                    timestamp: new Date().toISOString()
                };

                let expenses = getLocalStorage(expensesKey, []);
                expenses.push(newExpense);
                setLocalStorage(expensesKey, expenses);

                // æ¸…ç©ºè¡¨å–®
                itemInput.value = '';
                krwInput.value = '';
                photoInput.value = null; // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥
                document.getElementById('photo-preview').innerHTML = 'ï¼ˆåœ–ç‰‡å£“ç¸®å¾Œä¸æœƒä½”ç”¨å¤ªå¤šå®¹é‡ï¼‰';
                base64Photo = null;

                renderExpenseList();
            });
        }


        // --- Tab: LISTS (æ¸…å–®) æ¸²æŸ“ (ä¸è®Š) ---
        function renderListsTab(container) {
            // è¼‰å…¥æ¸…å–®å’Œå‚™å¿˜éŒ„
            const checklist = getLocalStorage(checklistKey, initialChecklist);
            const memoText = getLocalStorage(memoKey, "æ­¡è¿ä½¿ç”¨å‚™å¿˜éŒ„ï¼å¯ä»¥åœ¨é€™è£¡è¨˜éŒ„ç¶²å€ï¼Œæœƒè‡ªå‹•è½‰æ›æˆé€£çµæŒ‰éˆ•ã€‚\n\nä¾‹å¦‚ï¼š\nNaver åœ°åœ–: https://map.naver.com/");

            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">ğŸ“ è¡Œå‰æ¸…å–®èˆ‡å‚™å¿˜éŒ„</h2>

                <div class="muji-card p-4 mb-8">
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2" style="color: var(--color-text-main); border-color: var(--color-divider);">è¡Œå‰æº–å‚™ CheckList</h3>
                    <div id="checklist-container" class="space-y-2">
                        </div>
                </div>

                <div class="muji-card p-4">
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2" style="color: var(--color-text-main); border-color: var(--color-divider);">å€‹äººå‚™å¿˜éŒ„</h3>
                    <textarea id="memo-input" class="w-full p-3 h-40 border rounded-lg focus:ring-1 focus:ring-red-300 text-sm" placeholder="è¼¸å…¥æ‚¨çš„å‚™å¿˜å…§å®¹..." style="border-color: var(--color-divider); color: var(--color-text-main);">${memoText}</textarea>
                    <button id="save-memo-btn" class="muji-btn w-full mt-3">å„²å­˜å‚™å¿˜éŒ„</button>
                    <div class="mt-4 p-3 rounded-lg" id="memo-output" style="background-color: var(--color-bg-primary);">
                        <h4 class="font-medium mb-2" style="color: var(--color-text-main);">é€£çµé è¦½ (è‡ªå‹•è½‰æ›)</h4>
                        </div>
                </div>
            `;
            container.innerHTML = html;
            setupListsListeners(checklist, memoText);
        }

        // æ¸²æŸ“ CheckList é …ç›® (ä¸è®Š)
        function renderChecklist(checklist) {
            const container = document.getElementById('checklist-container');
            if (!container) return;

            container.innerHTML = checklist.map(item => `
                <div class="flex items-center p-2 rounded hover:bg-gray-50 transition duration-150">
                    <input type="checkbox" id="check-${item.id}" data-id="${item.id}" class="h-5 w-5 border-gray-300 rounded focus:ring-red-500" style="color: var(--color-text-main); border-color: var(--color-divider);" ${item.checked ? 'checked' : ''}>
                    <label for="check-${item.id}" class="ml-3 text-sm flex-1 ${item.checked ? 'line-through text-gray-500' : 'text-gray-800'}" style="color: ${item.checked ? 'gray' : 'var(--color-text-main)'};">
                        ${item.text}
                    </label>
                </div>
            `).join('');
        }
        
        // æ¸²æŸ“å‚™å¿˜éŒ„è¼¸å‡º (è‡ªå‹•è½‰æ›é€£çµ) (ä¸è®Š)
        function renderMemoOutput(memoText) {
            const outputDiv = document.getElementById('memo-output');
            if (!outputDiv) return;

            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const lines = memoText.split('\n');
            
            let outputHtml = '<h4 class="font-medium mb-2" style="color: var(--color-text-main);">é€£çµé è¦½ (è‡ªå‹•è½‰æ›)</h4><div class="space-y-2">';

            lines.forEach(line => {
                const matches = line.match(urlRegex);
                if (matches) {
                    matches.forEach(url => {
                        const linkName = line.replace(url, '').trim() || url;
                        outputHtml += `
                            <a href="${url}" target="_blank" class="muji-btn-light w-full text-left flex items-center justify-between text-sm" style="border-color: var(--color-divider); background-color: white;">
                                <span><i class="fas fa-link mr-2"></i> ${linkName}</span>
                                <i class="fas fa-external-link-alt text-xs"></i>
                            </a>
                        `;
                    });
                }
            });

            if (outputHtml === '<h4 class="font-medium mb-2" style="color: var(--color-text-main);">é€£çµé è¦½ (è‡ªå‹•è½‰æ›)</h4><div class="space-y-2">') {
                outputHtml += '<p class="text-sm text-gray-400">æ²’æœ‰åµæ¸¬åˆ°å¯è½‰æ›çš„ç¶²å€é€£çµã€‚</p>';
            }

            outputHtml += '</div>';
            outputDiv.innerHTML = outputHtml;
        }

        // è¨­ç½® Lists Tab çš„äº‹ä»¶ç›£è½å™¨ (ä¸è®Š)
        function setupListsListeners(checklist, memoText) {
            // 1. CheckList æ¸²æŸ“èˆ‡äº‹ä»¶
            renderChecklist(checklist);

            document.getElementById('checklist-container').addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const id = parseInt(e.target.dataset.id, 10);
                    const updatedChecklist = getLocalStorage(checklistKey, initialChecklist).map(item => {
                        if (item.id === id) {
                            item.checked = e.target.checked;
                        }
                        return item;
                    });
                    setLocalStorage(checklistKey, updatedChecklist);
                    renderChecklist(updatedChecklist); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ¨£å¼
                }
            });

            // 2. Memo æ¸²æŸ“èˆ‡äº‹ä»¶
            renderMemoOutput(memoText);

            document.getElementById('save-memo-btn').addEventListener('click', () => {
                const input = document.getElementById('memo-input');
                const newMemoText = input.value;
                setLocalStorage(memoKey, newMemoText);
                renderMemoOutput(newMemoText);
                alertModal("å‚™å¿˜éŒ„å·²å„²å­˜ã€‚");
            });
        }


        // --- Tab: INFO (è³‡è¨Š) æ¸²æŸ“ (ä¸è®Š) ---
        function renderInfoTab(container) {
            let html = `
                <h2 class="text-2xl font-bold mb-6 border-b-2 border-dashed pb-2" style="border-color: var(--color-divider);">ğŸ’¡ æ—…éŠå¯¦ç”¨è³‡è¨Š</h2>

                <div class="muji-card p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2" style="color: var(--color-text-main); border-color: var(--color-divider);">ç•¶åœ°è³‡è¨Šé€£çµ</h3>
                    <div class="space-y-3">
                        <a href="https://weather.com/zh-TW/weather/today/l/KSXX0037:1:KS" target="_blank" class="muji-btn-light w-full flex items-center justify-between" style="border-color: var(--color-divider); background-color: var(--color-bg-primary);">
                            <span><i class="fas fa-cloud-sun mr-2"></i> é¦–çˆ¾ç•¶åœ°å¤©æ°£é å ±</span>
                            <i class="fas fa-external-link-alt text-xs"></i>
                        </a>
                    </div>

                    <h3 class="text-lg font-semibold mt-6 mb-3 border-b pb-2" style="color: var(--color-text-main); border-color: var(--color-divider);">ç·Šæ€¥è¯çµ¡è³‡è¨Š</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-2 border-b" style="border-color: var(--color-divider);">
                            <span class="font-medium text-red-600"><i class="fas fa-house-medical mr-2"></i> æ•‘è­·è»Š/æ€¥è¨º</span>
                            <span class="font-bold text-lg" style="color: var(--color-text-main);">119</span>
                        </div>
                        <div class="flex justify-between items-center p-2 border-b" style="border-color: var(--color-divider);">
                            <span class="font-medium text-blue-600"><i class="fas fa-user-shield mr-2"></i> è­¦å¯Ÿ</span>
                            <span class="font-bold text-lg" style="color: var(--color-text-main);">112</span>
                        </div>
                        <div class="p-2 border rounded-lg" style="background-color: var(--color-bg-primary); border-color: var(--color-divider);">
                            <p class="font-medium" style="color: var(--color-text-main);">é§éŸ“åœ‹è‡ºåŒ—ä»£è¡¨éƒ¨</p>
                            <p class="text-sm text-gray-600">åœ°å€ï¼šé¦–çˆ¾å¸‚é¾è·¯å€ä¸–å®—å¤§è·¯ 149 å…‰åŒ–é–€å¤§å»ˆ 6 æ¨“</p>
                            <p class="text-sm text-gray-600">æ€¥é›£æ•‘åŠ©é›»è©±ï¼š<a href="tel:+82-2-399-2782" class="text-blue-600 hover:underline">+82-2-399-2782</a></p>
                        </div>
                    </div>
                </div>

                <div class="muji-card p-4">
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2" style="color: var(--color-text-main); border-color: var(--color-divider);">âš ï¸ æ—…éŠç¦å¿Œèˆ‡æ³¨æ„äº‹é …</h3>
                    <ul class="text-sm space-y-2 list-disc list-inside text-gray-600">
                        <li><span class="font-medium" style="color: var(--color-text-main);">å‡ºå…¥å¢ƒé•ç¦å“ï¼š</span>åš´ç¦æ”œå¸¶è‚‰é¡ã€ç”Ÿé®®ç”¢å“å…¥å¢ƒã€‚éƒ¨åˆ†è—¥å“å¦‚å«æœ‰éº»é†‰æˆ–ç®¡åˆ¶æˆåˆ†éœ€ç”³å ±ã€‚</li>
                        <li><span class="font-medium" style="color: var(--color-text-main);">é¤é£²ç¦®å„€ï¼š</span>ç”¨é¤æ™‚ï¼Œå°‡ç¢—ç¢Ÿç•™åœ¨æ¡Œä¸Šï¼Œä¸æ§èµ·é£¯ç¢—æˆ–æ¹¯ç¢—ã€‚ä¸å¯ç”¨ç­·å­æŒ‡äººã€‚</li>
                        <li><span class="font-medium" style="color: var(--color-text-main);">é•·å¹¼å°Šå‘ï¼š</span>å‘å¹´é•·è€…éç‰©æˆ–æ¥ç‰©æ™‚ï¼Œæ‡‰é›™æ‰‹é€²è¡Œï¼Œä»¥ç¤ºå°Šé‡ã€‚</li>
                        <li><span class="font-medium" style="color: var(--color-text-main);">å…¬å…±äº¤é€šï¼š</span>åœ¨åœ°éµæˆ–å…¬è»Šä¸Šæ‡‰ç‚ºè€äººã€å­•å©¦è®“åº§ï¼ŒéŸ“åœ‹ç¤¾æœƒå°æ­¤éå¸¸é‡è¦–ã€‚</li>
                        <li><span class="font-medium" style="color: var(--color-text-main);">éŸ“å±‹ä½å®¿ï¼š</span>åœ¨å‚³çµ±éŸ“å±‹å…§éœ€è„«é‹ï¼Œæ³¨æ„ä¿æŒå®‰éœï¼Œä»¥ç¶­è­·ç’°å¢ƒã€‚</li>
                    </ul>
                </div>
            `;
            container.innerHTML = html;
        }
        
        // --- Custom Alert Modal (å–ä»£ alert()) ---
        function alertModal(message) {
            let modal = document.getElementById('custom-alert-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'custom-alert-modal';
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30 p-4 hidden';
                modal.innerHTML = `
                    <div class="muji-card p-6 w-full max-w-xs text-center" style="border-color: var(--color-divider);">
                        <p class="text-lg font-medium mb-4" id="alert-message" style="color: var(--color-text-main);"></p>
                        <button id="alert-close-btn" class="muji-btn w-full">ç¢ºèª</button>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('alert-close-btn').onclick = () => {
                    modal.classList.add('hidden');
                };
            }
            document.getElementById('alert-message').textContent = message;
            modal.classList.remove('hidden');
        }

        // --- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š ---
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData(); // åŠ è¼‰åŒ¯ç‡

            // åˆå§‹è¼‰å…¥ FLIGHTS_STAY tab (æ–°çš„é¦–é )
            changeTab('FLIGHTS_STAY');

            // ç¶å®šåº•éƒ¨å°èˆªåˆ—äº‹ä»¶
            document.querySelectorAll('.nav-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tab = e.currentTarget.dataset.tab;
                    changeTab(tab);
                });
            });
            
            // åˆå§‹åŒ– LocalStorage é è¨­å€¼ (å¦‚æœæ²’æœ‰çš„è©±)
            if (!localStorage.getItem(checklistKey)) {
                setLocalStorage(checklistKey, initialChecklist);
            }
        });

    </script>
</body>
</html>

